<!-- Create Course Section -->
<style>
    /* Page Header Styles */
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 1.5rem 0;
    }
    
    .page-header h1 {
        margin-bottom: 1rem;
    }
    
    .page-header .breadcrumb {
        justify-content: center;
        background-color: transparent;
        margin-bottom: 0;
    }
    
    /* Image Preview Styles */
    .existing-file-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .existing-file-preview:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .file-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .file-icon {
        font-size: 2.5rem;
        color: #00a651;
    }
    
    .file-details h6 {
        margin: 0 0 5px 0;
        color: #333;
        font-weight: 600;
    }
    
    .file-details small {
        color: #666;
        display: block;
    }
    
    .file-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    /* Enhanced Image Preview */
    .image-preview-enhanced {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .image-preview-enhanced:hover {
        transform: scale(1.02);
    }
    
    .image-preview-enhanced img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Responsive Design Improvements */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .stat-card {
            margin-bottom: 1rem;
        }
        
        .form-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .form-actions .btn {
            width: 100%;
        }
        
        .existing-file-preview .file-info {
            flex-direction: column;
            text-align: center;
            gap: 10px;
        }
        
        .file-actions {
            margin-left: 0;
            justify-content: center;
        }
        
        .image-preview-enhanced {
            max-width: 200px;
            margin: 0 auto;
        }
        
        /* Table improvements for mobile */
        .table-responsive {
            font-size: 0.85rem;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
            white-space: nowrap;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin-bottom: 2px;
            border-radius: 4px !important;
        }
    }
    
    @media (max-width: 576px) {
        .card-body {
            padding: 1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        .form-control,
        .form-select {
            font-size: 0.9rem;
        }
        
        .table-responsive {
            font-size: 0.8rem;
        }
        
        .existing-file-preview {
            padding: 15px;
        }
        
        .page-header .breadcrumb {
            font-size: 0.8rem;
        }
        
        .card {
            margin-bottom: 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .form-label {
            font-size: 0.95rem;
        }
        
        textarea.form-control {
            min-height: 100px;
        }
    }
    
    @media (max-width: 576px) {
        .page-header h1 {
            font-size: 1.5rem;
        }
        
        .card-header h4 {
            font-size: 1.1rem;
        }
        
        .btn {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        .form-actions button {
            margin: 0.25rem 0;
        }
    }
    
    /* Enhanced Form Styling */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #00a651;
        box-shadow: 0 0 0 0.2rem rgba(0, 166, 81, 0.1);
    }
    
    .form-label {
        color: #495057;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .card {
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    
    .coupon-item {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .coupon-item:hover {
        background-color: #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .card.border-info {
        border-color: #17a2b8 !important;
    }
    
    .card.border-warning {
        border-color: #ffc107 !important;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid rgba(0,0,0,0.125);
    }
    
    .form-control-plaintext {
        padding-left: 0.75rem;
    }
</style>
<div id="create-course-section" class="content-section" style="display: none;">
    <div class="page-header">
        <h1>Create Course</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Create Course</li>
            </ol>
        </nav>
    </div>

    <div class="row justify-content-center">
        <!-- Create Course Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h3 class="mb-0 text-dark"><i class="fas fa-plus-circle me-2"></i>Create New Course</h3>
                </div>
                <div class="card-body">
                    <form id="createCourseForm" method="POST" action="/admin/courses/create" enctype="multipart/form-data">
                        <!-- Basic Course Information -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Basic Course Information</h5>
                            <div class="row">
                            <!-- Course Title -->
                            <div class="col-md-12 mb-3">
                                <label for="courseTitle" class="form-label fw-bold">Course Title *</label>
                                <input type="text" class="form-control form-control-lg" id="courseTitle" name="title" required>
                                <div class="form-text">Enter a compelling course title that describes what students will learn.</div>
                            </div>
                            
                            <!-- Course Category -->
                            <div class="col-lg-6 col-md-12 mb-3">
                                <label for="courseCategory" class="form-label fw-bold">Course Category *</label>
                                <select class="form-select" id="courseCategory" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Web Development">Web Development</option>
                                    <option value="Data Science">Data Science</option>
                                    <option value="Mobile Development">Mobile Development</option>
                                    <option value="Business">Business</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Design">Design</option>
                                    <option value="Photography">Photography</option>
                                    <option value="Music">Music</option>
                                    <option value="Language">Language</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <!-- Course Price -->
                            <div class="col-lg-6 col-md-12 mb-3">
                                <label for="coursePrice" class="form-label fw-bold">Course Price (‡ß≥) *</label>
                                <input type="number" class="form-control" id="coursePrice" name="price" min="0" step="0.01" required>
                                <div class="form-text">Enter the course price in Bangladeshi Taka (BDT).</div>
                            </div>
                            
                            <!-- Course Description -->
                            <div class="col-md-12 mb-3">
                                <label for="courseDescription" class="form-label fw-bold">Course Description *</label>
                                <textarea class="form-control" id="courseDescription" name="description" rows="4" required></textarea>
                                <div class="form-text">Provide a detailed description of what the course covers.</div>
                            </div>
                            </div>
                        </div>
                        
                        <!-- Course Media -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-image me-2"></i>Course Media</h5>
                            <div class="row">
                            <!-- Course Image -->
                            <div class="col-md-12 mb-3">
                                <label for="courseImage" class="form-label fw-bold">Course Image</label>
                                <div id="courseImagePreview" class="mb-2" style="display: none;">
                                    <img id="courseImagePreviewImg" src="" alt="Course Image" style="width: 200px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                                    <div class="mt-1">
                                        <small class="text-muted">Current course image</small>
                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearCourseImage()">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </div>
                                </div>
                                <input type="file" class="form-control" id="courseImage" name="image" accept="image/*">
                                <div class="form-text">Upload a course thumbnail image (recommended: 1200x800 pixels).</div>
                            </div>
                            
                            </div>
                        </div>
                        
                        <!-- Instructor Information -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-user-tie me-2"></i>Instructor Information</h5>
                            <div class="row">
                            <div class="col-lg-6 col-md-12 mb-3">
                                <label for="instructorName" class="form-label fw-bold">Instructor Name</label>
                                <input type="text" class="form-control" id="instructorName" name="instructor_name">
                            </div>
                            
                            <div class="col-lg-6 col-md-12 mb-3">
                                <label for="instructorImage" class="form-label fw-bold">Instructor Image</label>
                                <div id="instructorImagePreview" class="mb-2" style="display: none;">
                                    <img id="instructorImagePreviewImg" src="" alt="Instructor Image" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #ddd;">
                                    <div class="mt-1">
                                        <small class="text-muted">Current instructor image</small>
                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearInstructorImage()">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </div>
                                </div>
                                <input type="file" class="form-control" id="instructorImage" name="instructor_image" accept="image/*">
                            </div>
                            </div>
                        </div>
                        
                        <!-- Course Content Details -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-graduation-cap me-2"></i>Course Content Details</h5>
                            <div class="row">
                            <!-- What You'll Learn -->
                            <div class="col-md-12 mb-3">
                                <label for="whatYoullLearn" class="form-label fw-bold">What You'll Learn</label>
                                <textarea class="form-control" id="whatYoullLearn" name="what_youll_learn" rows="4" placeholder="List the key learning outcomes, one per line"></textarea>
                            </div>
                            
                            <!-- Course Requirements -->
                            <div class="col-md-12 mb-3">
                                <label for="courseRequirements" class="form-label fw-bold">Course Requirements</label>
                                <textarea class="form-control" id="courseRequirements" name="course_requirements" rows="3" placeholder="List any prerequisites or requirements"></textarea>
                            </div>
                            
                            <!-- About Course -->
                            <div class="col-md-12 mb-3">
                                <label for="aboutCourse" class="form-label fw-bold">About This Course</label>
                                <textarea class="form-control" id="aboutCourse" name="about_course" rows="4"></textarea>
                            </div>
                            
                            <!-- Instructor Bio -->
                            <div class="col-md-12 mb-3">
                                <label for="instructorBio" class="form-label fw-bold">Instructor Bio</label>
                                <textarea class="form-control" id="instructorBio" name="instructor_bio" rows="4"></textarea>
                            </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="text-center mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-primary btn-lg me-3 px-5">
                                <i class="fas fa-save me-2"></i>Create Course
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg px-5" onclick="resetCourseForm()">
                                <i class="fas fa-undo me-2"></i>Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar - Removed per requirement -->
    </div>
    
    <!-- Existing Courses List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-list me-2"></i>Existing Courses</h3>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshCoursesManually()" title="Click if courses don't load">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Thumbnail</th>
                                    <th>Course Title</th>
                                    <th>Instructor</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Enrollments</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coursesTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Loading courses...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Course Management Functions
let coursesLoaded = false;

function getCourseImageUrl(course) {
    if (!course.image) return '/static/images/placeholder.svg';
    
    console.log('Course image filename:', course.image);
    
    // Check if the image filename contains underscore and ends with digits (admin-uploaded pattern)
    // Format: 3_1752577561.ext (course_id_timestamp)
    if (course.image.includes('_') && !isNaN(course.image.split('_').pop().split('.')[0])) {
        // This is an admin-uploaded file, use Bunny CDN courses folder
        console.log('Using Bunny CDN courses folder for course image');
        return `https://skill-finesse-videos.b-cdn.net/courses/${course.image}`;
    } else {
        // This is a regular file, use local path
        console.log('Using local path for course image');
        return `/static/images/${course.image}`;
    }
}

function getInstructorImageUrl(course) {
    if (!course.instructor_image) return '/static/images/default-avatar.png';
    
    console.log('Instructor image filename:', course.instructor_image);
    
    // Check if the instructor image filename has a Bunny CDN timestamp pattern
    // Bunny CDN files end with exactly 10 digits before the file extension
    // Format: name_1234567890.ext (timestamp at the end)
    // Local files use format: 20250715122626_name.ext (timestamp at the start)
    const bunnyPattern = /^.+_(\d{10})\.[a-zA-Z]{2,4}$/;
    if (bunnyPattern.test(course.instructor_image)) {
        // This is a Bunny CDN file, construct CDN URL
        console.log('Using Bunny CDN URL for instructor image');
        return `https://skill-finesse-videos.b-cdn.net/courses/${course.instructor_image}`;
    } else {
        // This is a local file, use local path
        console.log('Using local path for instructor image');
        return `/static/uploads/${course.instructor_image}`;
    }
}

function viewCourse(courseId) {
    window.open(`/course/${courseId}`, '_blank');
}

function editCourse(courseId) {
    console.log('üîÑ Editing course ID:', courseId);
    
    // Fetch detailed course data for editing
    fetch(`/admin/courses/${courseId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('‚úÖ Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä Course data received:', data);
        if (data.success) {
            const course = data.course;
            if (course) {
                // Pre-fill the form with course data
                document.getElementById('courseTitle').value = course.title || '';
                document.getElementById('courseCategory').value = course.category || '';
                document.getElementById('coursePrice').value = course.price || '';
                document.getElementById('courseDescription').value = course.description || '';
                document.getElementById('instructorName').value = course.instructor_name || '';
                document.getElementById('whatYoullLearn').value = course.what_youll_learn || '';
                document.getElementById('courseRequirements').value = course.course_requirements || '';
                document.getElementById('aboutCourse').value = course.about_course || '';
                document.getElementById('instructorBio').value = course.instructor_bio || '';
                
                // Show existing course image if available
                if (course.image) {
                    const courseImagePreview = document.getElementById('courseImagePreview');
                    const courseImagePreviewImg = document.getElementById('courseImagePreviewImg');
                    
                    if (courseImagePreview && courseImagePreviewImg) {
                        const courseImageUrl = getCourseImageUrl(course);
                        console.log('Setting course image preview:', courseImageUrl);
                        
                        courseImagePreviewImg.src = courseImageUrl;
                        courseImagePreview.style.display = 'block';
                    }
                }
                
                // Show existing instructor image if available
                if (course.instructor_image) {
                    // Wait a moment to ensure DOM is ready
                    setTimeout(() => {
                        const instructorImagePreview = document.getElementById('instructorImagePreview');
                        const instructorImagePreviewImg = document.getElementById('instructorImagePreviewImg');
                        
                        if (instructorImagePreview && instructorImagePreviewImg) {
                            const instructorImageUrl = getInstructorImageUrl(course);
                            console.log('Setting instructor image preview:', instructorImageUrl);
                            
                            // Set the image source and make it visible
                            instructorImagePreviewImg.src = instructorImageUrl;
                            instructorImagePreviewImg.onerror = function() {
                                console.error('Failed to load instructor image:', instructorImageUrl);
                                // Fallback to default avatar
                                this.src = '/static/images/default-avatar.png';
                            };
                            instructorImagePreview.style.display = 'block';
                        } else {
                            console.error('Instructor image preview elements not found');
                        }
                    }, 100);
                }
                
                // Note: Discount data is now managed in Discount & Coupon Management section
                // document.getElementById('coursePublicDiscountPercent').value = course.discount_percent || '';
                // updateCourseDiscountPreview();
                
                // Note: Coupon data is now managed in Discount & Coupon Management section
                // loadCourseCoupons(course.coupons || []);
                
                // Show existing images (pass full course object)
                showCourseImage(course);
                showInstructorImage(course);
                
                // Scroll to form
                document.getElementById('createCourseForm').scrollIntoView({ behavior: 'smooth' });
                
                // Change button text
                const submitBtn = document.querySelector('#createCourseForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Course';
                    submitBtn.setAttribute('data-course-id', courseId);
                }
                
                // Additional check for instructor image after all DOM updates
                setTimeout(() => {
                    const instructorPreview = document.getElementById('instructorImagePreview');
                    const instructorImg = document.getElementById('instructorImagePreviewImg');
                    
                    if (instructorPreview && instructorImg && course.instructor_image) {
                        console.log('üîç Final instructor image check:');
                        console.log('   Preview display:', instructorPreview.style.display);
                        console.log('   Image src:', instructorImg.src);
                        console.log('   Image visible:', instructorImg.offsetWidth > 0 && instructorImg.offsetHeight > 0);
                        
                        // Force visibility if hidden
                        if (instructorPreview.style.display === 'none' || !instructorImg.src) {
                            const instructorImageUrl = getInstructorImageUrl(course);
                            instructorImg.src = instructorImageUrl;
                            instructorPreview.style.display = 'block';
                            console.log('üîß Forced instructor image visibility');
                        }
                    }
                }, 500);
                
                alert('Course data loaded in the form above. Make your changes and click "Update Course".');
            }
        } else {
            console.error('‚ùå API returned error:', data.message);
            alert('Error: ' + (data.message || 'Course not found'));
        }
    })
    .catch(error => {
        console.error('‚ùå Error loading course:', error);
        alert('Error loading course data: ' + error.message);
    });
}

// Helper functions for image preview
function showCourseImage(course) {
    const preview = document.getElementById('courseImagePreview');
    const img = document.getElementById('courseImagePreviewImg');
    
    if (course && course.image) {
        const courseImageUrl = getCourseImageUrl(course);
        img.src = courseImageUrl;
        img.onerror = function() {
            console.error('Failed to load course image:', courseImageUrl);
            this.src = '/static/images/placeholder.svg';
        };
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

function showInstructorImage(course) {
    const preview = document.getElementById('instructorImagePreview');
    const img = document.getElementById('instructorImagePreviewImg');
    
    if (course && course.instructor_image) {
        const instructorImageUrl = getInstructorImageUrl(course);
        img.src = instructorImageUrl;
        img.onerror = function() {
            console.error('Failed to load instructor image:', instructorImageUrl);
            this.src = '/static/images/default-avatar.png';
        };
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

function clearCourseImage() {
    const preview = document.getElementById('courseImagePreview');
    const fileInput = document.getElementById('courseImage');
    
    preview.style.display = 'none';
    fileInput.value = '';
}

function clearInstructorImage() {
    const preview = document.getElementById('instructorImagePreview');
    const fileInput = document.getElementById('instructorImage');
    
    preview.style.display = 'none';
    fileInput.value = '';
}

function togglePublishCourse(courseId, isPublished) {
    if (confirm(`Are you sure you want to ${isPublished ? 'unpublish' : 'publish'} this course?`)) {
        const endpoint = isPublished ? 'unpublish' : 'publish';
        fetch(`/admin/courses/${courseId}/${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Course ${isPublished ? 'unpublished' : 'published'} successfully!`);
                loadCourses(); // Reload courses
            } else {
                alert('Error: ' + (data.message || 'Failed to update course status'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating course status');
        });
    }
}

function deleteCourse(courseId) {
    if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        fetch(`/admin/courses/${courseId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Course deleted successfully!');
                loadCourses(); // Reload courses
            } else {
                alert('Error: ' + (data.message || 'Failed to delete course'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting course');
        });
    }
}

function loadCourses() {
    console.log('üîÑ loadCourses() called');
    const coursesTableBody = document.getElementById('coursesTableBody');
    
    if (!coursesTableBody) {
        console.error('‚ùå coursesTableBody element not found');
        return;
    }
    
    console.log('‚úÖ coursesTableBody found, loading courses...');
    
    // Show loading state
    coursesTableBody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading courses...</p>
            </td>
        </tr>
    `;
    
    // Make API call
    fetch('/admin/courses/list', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä API Response:', data);
        if (data.success) {
            coursesLoaded = true;
            console.log(`‚úÖ Found ${data.courses.length} courses`);
            
            if (data.courses && data.courses.length > 0) {
                // Log first course for debugging
                console.log('üîç First course data:', data.courses[0]);
                
                // Display courses in table format
                const coursesHTML = data.courses.map(course => {
                    const imageUrl = getCourseImageUrl(course);
                    console.log(`üñºÔ∏è Course "${course.title}" image URL: ${imageUrl}`);
                    return `
                    <tr>
                        <td>
                            <img src="${getCourseImageUrl(course)}" 
                                 alt="${course.title}" 
                                 style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;"
                                 onerror="this.src='/static/images/placeholder.svg';">
                        </td>
                        <td>
                            <strong>${course.title}</strong><br>
                            <small class="text-muted">${course.created_at ? new Date(course.created_at).toLocaleDateString() : 'N/A'}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${getInstructorImageUrl(course)}" 
                                     alt="${course.instructor_name || 'Instructor'}" 
                                     style="width: 30px; height: 30px; object-fit: cover; border-radius: 50%; margin-right: 8px;"
                                     onerror="this.src='/static/images/default-avatar.png';">
                                <span>${course.instructor_name || 'N/A'}</span>
                            </div>
                        </td>
                        <td>
                            ${course.category ? 
                                `<span class="badge bg-secondary">${course.category}</span>` : 
                                '<span class="text-muted">No category</span>'
                            }
                        </td>
                        <td>
                            <strong>‡ß≥${parseFloat(course.price).toLocaleString('en-BD')}</strong>
                        </td>
                        <td>
                            ${course.is_published ? 
                                '<span class="badge bg-success">Published</span>' : 
                                '<span class="badge bg-warning">Draft</span>'
                            }
                        </td>
                        <td>
                            <span class="badge bg-info">${course.enrollments_count || 0}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCourse(${course.id})" title="Edit Course">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="viewCourse(${course.id})" title="View Course">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${course.is_published ? 
                                    `<button class="btn btn-outline-warning" onclick="togglePublishCourse(${course.id}, true)" title="Unpublish">
                                        <i class="fas fa-eye-slash"></i>
                                    </button>` : 
                                    `<button class="btn btn-outline-success" onclick="togglePublishCourse(${course.id}, false)" title="Publish">
                                        <i class="fas fa-eye"></i>
                                    </button>`
                                }
                                <button class="btn btn-outline-danger" onclick="deleteCourse(${course.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');
                
                console.log('üìù Generated HTML length:', coursesHTML.length);
                coursesTableBody.innerHTML = coursesHTML;
                console.log('‚úÖ HTML inserted into table');
            } else {
                // No courses found
                coursesTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-graduation-cap fa-3x mb-3"></i>
                                <p>No courses created yet</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        } else {
            throw new Error(data.message || 'Failed to load courses');
        }
    })
    .catch(error => {
        console.error('Error loading courses:', error);
        coursesTableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center">
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Error loading courses: ${error.message}</p>
                        <button class="btn btn-sm btn-primary" onclick="loadCourses()">
                            <i class="fas fa-redo me-1"></i>Try Again
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
}

// Form submission handler
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createCourseForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            const courseId = submitBtn.getAttribute('data-course-id');
            const isUpdate = courseId !== null;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = isUpdate ? 
                '<i class="fas fa-spinner fa-spin me-2"></i>Updating Course...' : 
                '<i class="fas fa-spinner fa-spin me-2"></i>Creating Course...';
            
            const url = isUpdate ? 
                `/admin/courses/${courseId}/update` : 
                '/admin/courses/create';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset form
                    this.reset();
                    
                    // Clear image previews
                    clearCourseImage();
                    clearInstructorImage();
                    
                    // Clear discount and coupon data
                    clearCourseDiscountAndCoupons();
                    
                    // Show success message
                    alert(isUpdate ? 'Course updated successfully!' : 'Course created successfully!');
                    
                    // Reset button for create mode
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Create Course';
                    submitBtn.removeAttribute('data-course-id');
                    
                    // Reload courses list
                    loadCourses();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(isUpdate ? 'Error updating course' : 'Error creating course');
            })
            .finally(() => {
                // Reset button
                submitBtn.disabled = false;
                if (!submitBtn.getAttribute('data-course-id')) {
                    submitBtn.innerHTML = originalText;
                }
            });
        });
    }
    
    // Load courses when section becomes visible
    function checkSectionVisibility() {
        const section = document.getElementById('create-course-section');
        if (section && section.style.display !== 'none') {
            console.log('üîç Create course section is visible, loading courses...');
            loadCourses();
        }
    }
    
    // Force load courses after a delay to ensure page is ready
    setTimeout(() => {
        console.log('‚è∞ Timeout trigger - checking section visibility');
        checkSectionVisibility();
    }, 1000);
    
    // Initial check
    checkSectionVisibility();
    
    // Check when section visibility changes
    const observer = new MutationObserver(() => {
        console.log('üîÑ DOM mutation detected, checking section visibility');
        checkSectionVisibility();
    });
    observer.observe(document.body, { 
        subtree: true, 
        attributes: true, 
        attributeFilter: ['style'] 
    });
    
    // Add a manual refresh button click handler
    window.refreshCoursesManually = function() {
        console.log('üîÑ Manual refresh triggered');
        coursesLoaded = false;
        loadCourses();
    };
});

// Discount and Coupon Management Functions
let courseCouponCount = 0;

function updateCourseDiscountPreview() {
    // Note: This function is deprecated as discounts are managed in Discount & Coupon Management section
    return;
    /*
    const price = parseFloat(document.getElementById('coursePrice').value) || 0;
    const discountPercent = parseFloat(document.getElementById('coursePublicDiscountPercent').value) || 0;
    const previewElement = document.getElementById('courseDiscountedPricePreview');
    
    if (price > 0) {
        if (discountPercent > 0) {
            const discountAmount = (price * discountPercent) / 100;
            const discountedPrice = price - discountAmount;
            previewElement.innerHTML = `
                <span class="text-muted text-decoration-line-through">‡ß≥${price.toFixed(2)}</span>
                <span class="ms-2 text-success fs-5">‡ß≥${discountedPrice.toFixed(2)}</span>
                <span class="ms-2 badge bg-success">${discountPercent}% OFF</span>
            `;
        } else {
            previewElement.innerHTML = `‡ß≥${price.toFixed(2)} <span class="text-muted">(No discount)</span>`;
        }
    } else {
        previewElement.innerHTML = 'Set course price and discount to see preview';
    }
    */
}

function addNewCourseCoupon() {
    // Note: This function is disabled as coupons are managed in Discount & Coupon Management section
    return;
    /*
    courseCouponCount++;
    const container = document.getElementById('courseCouponsContainer');
    
    // Remove empty state message if it exists
    if (container.querySelector('.text-center')) {
        container.innerHTML = '';
    }
    
    const couponHTML = `
        <div class="coupon-item border rounded p-3 mb-3" id="courseCoupon_${courseCouponCount}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 text-secondary"><i class="fas fa-ticket-alt me-2"></i>Coupon #${courseCouponCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCourseCoupon('courseCoupon_${courseCouponCount}')">
                    <i class="fas fa-trash me-1"></i>Remove
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Coupon Code *</label>
                    <input type="text" class="form-control coupon-code" name="coupons[${courseCouponCount}][code]" 
                           placeholder="e.g., SAVE50" required style="text-transform: uppercase;">
                    <div class="form-text">Enter unique coupon code</div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Discount % *</label>
                    <input type="number" class="form-control coupon-discount" name="coupons[${courseCouponCount}][discount_percent]" 
                           min="1" max="100" placeholder="25" required onchange="updateCourseCouponPreview('courseCoupon_${courseCouponCount}')">
                    <div class="form-text">1-100% discount</div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Usage Limit</label>
                    <input type="number" class="form-control" name="coupons[${courseCouponCount}][usage_limit]" 
                           min="1" placeholder="100">
                    <div class="form-text">Leave empty for unlimited</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Valid From</label>
                    <input type="datetime-local" class="form-control datetime-input" 
                           name="coupons[${courseCouponCount}][valid_from]" 
                           id="course_valid_from_${courseCouponCount}">
                    <div class="form-text">Leave empty for immediate activation</div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">Valid Until</label>
                    <input type="datetime-local" class="form-control datetime-input" 
                           name="coupons[${courseCouponCount}][valid_until]" 
                           id="course_valid_until_${courseCouponCount}">
                    <div class="form-text">Leave empty for no expiry</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="coupons[${courseCouponCount}][is_active]" 
                               id="course_active_${courseCouponCount}" checked>
                        <label class="form-check-label" for="course_active_${courseCouponCount}">
                            Active Coupon
                        </label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="coupon-preview text-end">
                        <small class="text-muted">Discount Preview:</small>
                        <div class="fw-bold text-success" id="course_preview_courseCoupon_${courseCouponCount}">Set discount % to see preview</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', couponHTML);
    
    // Convert coupon code input to uppercase
    const codeInput = document.querySelector(`input[name="coupons[${courseCouponCount}][code]"]`);
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
    
    // Add event listeners for datetime inputs to clear validation messages
    const validFromInput = document.getElementById(`course_valid_from_${courseCouponCount}`);
    const validUntilInput = document.getElementById(`course_valid_until_${courseCouponCount}`);
    
    if (validFromInput) {
        validFromInput.addEventListener('input', function() {
            this.setCustomValidity('');
        });
        validFromInput.addEventListener('change', function() {
            this.setCustomValidity('');
        });
    }
    
    if (validUntilInput) {
        validUntilInput.addEventListener('input', function() {
            this.setCustomValidity('');
        });
        validUntilInput.addEventListener('change', function() {
            this.setCustomValidity('');
        });
    }
    */
}


function removeCourseCoupon(couponId) {
    // Note: This function is disabled as coupons are managed in Discount & Coupon Management section
    return;
    /*
    const couponElement = document.getElementById(couponId);
    if (couponElement) {
        couponElement.remove();
        
        // Check if container is empty and show empty state
        const container = document.getElementById('courseCouponsContainer');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
                    <p class="mb-0">No coupons added yet. Click "Add Coupon" to create one.</p>
                </div>
            `;
        }
    }
    */
}

// Update coupon preview
function updateCourseCouponPreview(couponId) {
    const couponElement = document.getElementById(couponId);
    if (!couponElement) return;
    
    const discountInput = couponElement.querySelector('.coupon-discount');
    const previewElement = document.getElementById(`course_preview_${couponId}`);
    const coursePrice = parseFloat(document.getElementById('coursePrice').value) || 0;
    
    if (discountInput && previewElement) {
        const discount = parseFloat(discountInput.value) || 0;
        
        if (discount > 0 && coursePrice > 0) {
            const discountAmount = (coursePrice * discount) / 100;
            const finalPrice = coursePrice - discountAmount;
            previewElement.innerHTML = `‡ß≥${discountAmount.toFixed(2)} off - Final: ‡ß≥${finalPrice.toFixed(2)}`;
        } else {
            previewElement.innerHTML = 'Set discount % to see preview';
        }
    }
}

// Load existing coupons for editing (deprecated - managed in Discount & Coupon Management section)
function loadCourseCoupons(coupons) {
    // Note: This function is disabled as coupons are managed in Discount & Coupon Management section
    return;
    /*
    const container = document.getElementById('courseCouponsContainer');
    if (!container) return;
    container.innerHTML = '';
    
    if (!coupons || coupons.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
                <p class="mb-0">No coupons added yet. Click "Add Coupon" to create one.</p>
            </div>
        `;
        return;
    }
    
    coupons.forEach((coupon, index) => {
        courseCouponCount = index + 1;
        const couponId = 'courseCoupon_' + courseCouponCount;
        
        const couponHtml = `
            <div class="coupon-item border rounded p-3 mb-3" id="${couponId}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 text-secondary"><i class="fas fa-ticket-alt me-2"></i>Coupon #${courseCouponCount}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCourseCoupon('${couponId}')">
                        <i class="fas fa-trash me-1"></i>Remove
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Coupon Code *</label>
                        <input type="text" class="form-control coupon-code" name="coupons[${courseCouponCount}][code]" 
                               value="${coupon.code || ''}" placeholder="e.g., SAVE50" required style="text-transform: uppercase;">
                        <div class="form-text">Enter unique coupon code</div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Discount % *</label>
                        <input type="number" class="form-control coupon-discount" name="coupons[${courseCouponCount}][discount_percent]" 
                               value="${coupon.discount_percent || ''}" min="1" max="100" placeholder="25" required onchange="updateCourseCouponPreview('${couponId}')">
                        <div class="form-text">1-100% discount</div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Usage Limit</label>
                        <input type="number" class="form-control" name="coupons[${courseCouponCount}][usage_limit]" 
                               value="${coupon.usage_limit || ''}" min="1" placeholder="100">
                        <div class="form-text">Leave empty for unlimited</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Valid From</label>
                        <input type="datetime-local" class="form-control datetime-input" 
                               name="coupons[${courseCouponCount}][valid_from]" 
                               value="${formatDateTimeForInput(coupon.valid_from)}"
                               id="course_valid_from_${courseCouponCount}">
                        <div class="form-text">Leave empty for immediate activation</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Valid Until</label>
                        <input type="datetime-local" class="form-control datetime-input" 
                               name="coupons[${courseCouponCount}][valid_until]" 
                               value="${formatDateTimeForInput(coupon.valid_until)}"
                               id="course_valid_until_${courseCouponCount}">
                        <div class="form-text">Leave empty for no expiry</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="coupons[${courseCouponCount}][is_active]" 
                                   id="course_active_${courseCouponCount}" ${coupon.is_active ? 'checked' : ''}>
                            <label class="form-check-label" for="course_active_${courseCouponCount}">
                                Active Coupon
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="coupon-preview text-end">
                            <small class="text-muted">Discount Preview:</small>
                            <div class="fw-bold text-success" id="course_preview_${couponId}">Set discount % to see preview</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', couponHtml);
        
        // Add event listeners for the loaded coupon
        const codeInput = document.querySelector(`input[name="coupons[${courseCouponCount}][code]"]`);
        if (codeInput) {
            codeInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }
        
        // Add event listeners for datetime inputs
        const validFromInput = document.getElementById(`course_valid_from_${courseCouponCount}`);
        const validUntilInput = document.getElementById(`course_valid_until_${courseCouponCount}`);
        
        if (validFromInput) {
            validFromInput.addEventListener('input', function() {
                this.setCustomValidity('');
            });
            validFromInput.addEventListener('change', function() {
                this.setCustomValidity('');
            });
        }
        
        if (validUntilInput) {
            validUntilInput.addEventListener('input', function() {
                this.setCustomValidity('');
            });
            validUntilInput.addEventListener('change', function() {
                this.setCustomValidity('');
            });
        }
        
        // Update preview
        updateCourseCouponPreview(couponId);
    });
    */
}

// Format datetime for HTML datetime-local input (identical to ebook implementation)
function formatDateTimeForInput(dateTimeString) {
    if (!dateTimeString) return '';
    
    try {
        // Handle ISO format strings (with T separator)
        let cleanDateTime = dateTimeString;
        
        // If it's already in the right format, return it
        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(cleanDateTime)) {
            return cleanDateTime;
        }
        
        // Convert ISO format to datetime-local format (YYYY-MM-DDTHH:MM)
        const date = new Date(cleanDateTime);
        if (isNaN(date.getTime())) {
            return '';
        }
        
        // Format to YYYY-MM-DDTHH:MM
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch (error) {
        console.warn('Error formatting datetime:', dateTimeString, error);
        return '';
    }
}

function clearCourseDiscountAndCoupons() {
    // Note: Discounts are now managed in Discount & Coupon Management section
    /*
    // Reset discount
    document.getElementById('coursePublicDiscountPercent').value = '';
    document.getElementById('courseDiscountedPricePreview').innerHTML = 'Set course price and discount to see preview';
    */
    
    // Reset coupons
    courseCouponCount = 0;
    /*
    const container = document.getElementById('courseCouponsContainer');
    if (container) {
        container.innerHTML = `
        <div class="text-center text-muted py-3">
            <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
            <p class="mb-0">No coupons added yet. Click "Add Coupon" to create one.</p>
        </div>
    `;
    }
    */
}

// Function to clear file previews
function clearFilePreviewsInCourse() {
    // Clear course image preview
    const courseImageContainer = document.getElementById('courseImage').parentElement;
    const coursePreview = courseImageContainer.querySelector('.existing-file-preview');
    if (coursePreview) {
        coursePreview.remove();
    }
    
    // Clear instructor image preview
    const instructorImageContainer = document.getElementById('instructorImage').parentElement;
    const instructorPreview = instructorImageContainer.querySelector('.existing-file-preview');
    if (instructorPreview) {
        instructorPreview.remove();
    }
    
    // Reset original preview elements
    const courseImagePreview = document.getElementById('courseImagePreview');
    const instructorImagePreview = document.getElementById('instructorImagePreview');
    if (courseImagePreview) courseImagePreview.style.display = 'none';
    if (instructorImagePreview) instructorImagePreview.style.display = 'none';
}

function resetCourseForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        // Reset the main form
        document.getElementById('createCourseForm').reset();
        
        // Clear image previews
        clearCourseImage();
        clearInstructorImage();
        clearFilePreviewsInCourse();
        
        // Clear discount and coupon data
        clearCourseDiscountAndCoupons();
        
        // Reset submit button to create mode
        const submitBtn = document.querySelector('#createCourseForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Create Course';
            submitBtn.removeAttribute('data-course-id');
        }
        
        // Scroll to top of form
        document.getElementById('createCourseForm').scrollIntoView({ behavior: 'smooth' });
        
        // Show success message
        setTimeout(() => {
            alert('Form has been reset successfully!');
        }, 100);
    }
}

// Image preview handlers
document.getElementById('courseImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('courseImagePreview');
    const img = document.getElementById('courseImagePreviewImg');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

document.getElementById('instructorImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('instructorImagePreview');
    const img = document.getElementById('instructorImagePreviewImg');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});
</script>