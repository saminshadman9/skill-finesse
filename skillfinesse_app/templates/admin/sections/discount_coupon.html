<!-- Discount & Coupon Management Section -->
<style>
    .item-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .item-card.selected {
        border: 2px solid #00a651;
        background-color: rgba(0, 166, 81, 0.05);
    }
    
    .discount-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #00a651;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    
    .coupon-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        position: relative;
    }
    
    .coupon-code {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
    }
</style>

<div id="discount-coupon-section" class="content-section" style="display: none;">
    <div class="page-header">
        <h1>Discount & Coupon Management</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Discount & Coupon</li>
            </ol>
        </nav>
    </div>

    <div class="row">
        <!-- Left Column: Items List -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="mb-0 text-dark"><i class="fas fa-list me-2"></i>Courses & eBooks</h4>
                </div>
                <div class="card-body">
                    <!-- Filter Tabs -->
                    <ul class="nav nav-tabs mb-3" id="itemTabs">
                        <li class="nav-item">
                            <button class="nav-link active" id="all-tab" onclick="showTab('all')" type="button">
                                <i class="fas fa-th-list me-2"></i>All Items
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="courses-tab" onclick="showTab('courses')" type="button">
                                <i class="fas fa-play-circle me-2"></i>Courses
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="ebooks-tab" onclick="showTab('ebooks')" type="button">
                                <i class="fas fa-book me-2"></i>eBooks
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div id="itemsContainer" class="row">
                        <!-- Items will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading items...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Discount/Coupon Management -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-dark"><i class="fas fa-tags me-2"></i>Manage Discounts & Coupons</h5>
                </div>
                <div class="card-body">
                    <div id="noSelectionMessage" class="text-center text-muted py-4">
                        <i class="fas fa-hand-pointer fa-3x mb-3 opacity-50"></i>
                        <p>Select a course or eBook to manage its discounts and coupons</p>
                    </div>

                    <div id="selectedItemInfo" style="display: none;">
                        <!-- Selected Item Details -->
                        <div class="selected-item-header mb-4">
                            <div class="d-flex align-items-center">
                                <img id="selectedItemImage" src="" alt="" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                <div>
                                    <h6 id="selectedItemTitle" class="mb-1"></h6>
                                    <small id="selectedItemType" class="text-muted"></small>
                                    <div class="mt-1">
                                        <span class="fw-bold text-success" id="selectedItemPrice"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Public Discount Section -->
                        <div class="card border-info mb-3">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0 text-dark"><i class="fas fa-eye me-2"></i>Public Discount</h6>
                            </div>
                            <div class="card-body">
                                <form id="discountForm">
                                    <input type="hidden" id="selectedItemId" name="item_id">
                                    <input type="hidden" id="selectedItemTypeInput" name="item_type">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Discount Percentage (%)</label>
                                        <input type="number" class="form-control" id="discountPercent" name="discount_percent" min="0" max="100" placeholder="e.g., 25">
                                        <div class="form-text">Discount shown to all users</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Discounted Price Preview</label>
                                        <div class="form-control-plaintext fw-bold text-success" id="discountedPricePreview">
                                            Set discount to see preview
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-save me-2"></i>Save Discount
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Private Coupons Section -->
                        <div class="card border-warning">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0 text-dark"><i class="fas fa-ticket-alt me-2"></i>Private Coupons</h6>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addNewCoupon()">
                                    <i class="fas fa-plus me-1"></i>Add Coupon
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="couponsContainer">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
                                        <p class="mb-0">No coupons created yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedItem = null;
let couponCounter = 0;
let allCourses = [];
let allEbooks = [];
let currentTab = 'all';

// Simple tab switching function
function showTab(tabName) {
    console.log('üìã Switching to tab:', tabName);
    
    // Update tab buttons
    document.querySelectorAll('#itemTabs .nav-link').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Update current tab
    currentTab = tabName;
    
    // Show content based on tab
    if (tabName === 'all') {
        displayAllItems();
    } else if (tabName === 'courses') {
        displayCourses();
    } else if (tabName === 'ebooks') {
        displayEbooks();
    }
}

// Load discount and coupon management when section is shown
document.addEventListener('DOMContentLoaded', function() {
    // Load items when discount-coupon section becomes visible
    const discountSection = document.getElementById('discount-coupon-section');
    if (discountSection) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target.style.display !== 'none') {
                    loadAllItems();
                }
            });
        });
        observer.observe(discountSection, { attributes: true, attributeFilter: ['style'] });
    }
});

// Load all courses and ebooks
function loadAllItems() {
    console.log('üîÑ Loading all items...');
    return Promise.all([
        fetch('/admin/courses/list').then(r => r.json()),
        fetch('/admin/ebooks/list').then(r => r.json())
    ]).then(([coursesResponse, ebooksResponse]) => {
        console.log('üìä Courses response:', coursesResponse);
        console.log('üìä Ebooks response:', ebooksResponse);
        
        if (coursesResponse.success) {
            allCourses = coursesResponse.courses || [];
            console.log('‚úÖ Loaded courses:', allCourses.length);
        } else {
            console.error('‚ùå Failed to load courses:', coursesResponse.message);
        }
        
        if (ebooksResponse.success) {
            allEbooks = ebooksResponse.ebooks || [];
            console.log('‚úÖ Loaded ebooks:', allEbooks.length);
        } else {
            console.error('‚ùå Failed to load ebooks:', ebooksResponse.message);
        }
        
        // Display the current tab
        showTab(currentTab);
        
        console.log('üéØ All tabs populated with data');
        return { courses: allCourses, ebooks: allEbooks };
    }).catch(error => {
        console.error('‚ùå Error loading items:', error);
        showError('Failed to load courses and ebooks');
        throw error;
    });
}

// Display all items (courses + ebooks)
function displayAllItems() {
    console.log('üìã Displaying all items...');
    const container = document.getElementById('itemsContainer');
    
    if (!container) {
        console.error('‚ùå Items container not found!');
        return;
    }
    
    
    const allItems = [...allCourses.map(c => ({...c, type: 'course'})), ...allEbooks.map(e => ({...e, type: 'ebook'}))];
    console.log('üìä Total items to display:', allItems.length, '(Courses:', allCourses.length, 'Ebooks:', allEbooks.length, ')');
    
    if (allItems.length === 0) {
        console.log('‚ÑπÔ∏è No items to display');
        container.innerHTML = '<div class="col-12 text-center text-muted py-4"><p>No courses or ebooks found</p></div>';
        return;
    }
    
    const allItemsHtml = allItems.map(item => createItemCard(item)).join('');
    container.innerHTML = allItemsHtml;
    console.log('‚úÖ All items displayed successfully');
}

// Display courses only
function displayCourses() {
    console.log('üéì Displaying courses, count:', allCourses.length);
    const container = document.getElementById('itemsContainer');
    
    if (!container) {
        console.error('‚ùå Items container not found!');
        return;
    }
    
    
    if (allCourses.length === 0) {
        console.log('‚ÑπÔ∏è No courses to display');
        container.innerHTML = '<div class="col-12 text-center text-muted py-4"><p>No courses found</p></div>';
        return;
    }
    
    const coursesHtml = allCourses.map(course => createItemCard({...course, type: 'course'})).join('');
    container.innerHTML = coursesHtml;
    console.log('‚úÖ Courses displayed successfully');
}

// Display ebooks only
function displayEbooks() {
    console.log('üìö Displaying ebooks, count:', allEbooks.length);
    const container = document.getElementById('itemsContainer');
    
    if (!container) {
        console.error('‚ùå Items container not found!');
        return;
    }
    
    
    if (allEbooks.length === 0) {
        console.log('‚ÑπÔ∏è No ebooks to display');
        container.innerHTML = '<div class="col-12 text-center text-muted py-4"><p>No ebooks found</p></div>';
        return;
    }
    
    const ebooksHtml = allEbooks.map(ebook => createItemCard({...ebook, type: 'ebook'})).join('');
    container.innerHTML = ebooksHtml;
    console.log('‚úÖ Ebooks displayed successfully');
}

// Create item card HTML
function createItemCard(item) {
    // Helper function to get correct image URL (handles both Bunny CDN and local files)
    function getImageUrl(filename, type) {
        if (!filename) {
            return type === 'course' ? '/static/images/default-course.jpg' : '/static/images/default-ebook.jpg';
        }
        
        // Check if filename has admin-uploaded pattern (Bunny CDN file)
        // Admin-uploaded files have format: name_timestamp.ext where timestamp ends with digits
        if (filename.includes('_')) {
            const parts = filename.split('_');
            const lastPart = parts[parts.length - 1].split('.')[0];
            if (/^\d+$/.test(lastPart)) {
                // Bunny CDN file
                if (type === 'course') {
                    return `https://skill-finesse-videos.b-cdn.net/courses/${filename}`;
                } else {
                    return `https://skill-finesse-videos.b-cdn.net/ebooks/${filename}`;
                }
            }
        }
        
        // Local file
        if (type === 'course') {
            return `/static/images/${filename}`;
        } else {
            return `/static/images/ebook_cover/${filename}`;
        }
    }
    
    const imageUrl = item.type === 'course' 
        ? getImageUrl(item.image, 'course')
        : getImageUrl(item.cover_image, 'ebook');
    
    const title = item.type === 'course' ? item.title : item.name;
    const price = parseFloat(item.price || 0).toFixed(2);
    const hasDiscount = item.discount_percent > 0;
    
    return `
        <div class="col-md-6 mb-3">
            <div class="card item-card h-100" onclick="selectItem(${item.id}, '${item.type}')">
                ${hasDiscount ? `<div class="discount-badge">${item.discount_percent}% OFF</div>` : ''}
                <img src="${imageUrl}" class="card-img-top" alt="${title}" style="height: 150px; object-fit: cover;">
                <div class="card-body">
                    <h6 class="card-title">${title}</h6>
                    <p class="card-text">
                        <small class="text-muted">${item.type === 'course' ? 'Course' : 'eBook'}</small><br>
                        <span class="fw-bold text-success">‡ß≥${price}</span>
                        ${hasDiscount ? `<span class="text-decoration-line-through text-muted ms-2">‡ß≥${(price / (1 - item.discount_percent/100)).toFixed(2)}</span>` : ''}
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Select an item for discount/coupon management
function selectItem(itemId, itemType) {
    console.log('üéØ Selecting item:', itemType, 'ID:', itemId);
    
    // Remove previous selection
    document.querySelectorAll('.item-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection to clicked item
    event.currentTarget.classList.add('selected');
    
    // Find the selected item
    const items = itemType === 'course' ? allCourses : allEbooks;
    selectedItem = items.find(item => item.id === itemId);
    
    if (!selectedItem) {
        console.error('‚ùå Selected item not found in data!');
        return;
    }
    
    selectedItem.type = itemType;
    console.log('‚úÖ Selected item:', selectedItem.title || selectedItem.name);
    
    // Show selected item info
    document.getElementById('noSelectionMessage').style.display = 'none';
    document.getElementById('selectedItemInfo').style.display = 'block';
    
    // Populate selected item details
    // Helper function to get correct image URL (handles both Bunny CDN and local files)
    function getImageUrl(filename, type) {
        if (!filename) {
            return type === 'course' ? '/static/images/default-course.jpg' : '/static/images/default-ebook.jpg';
        }
        
        // Check if filename has admin-uploaded pattern (Bunny CDN file)
        // Admin-uploaded files have format: name_timestamp.ext where timestamp ends with digits
        if (filename.includes('_')) {
            const parts = filename.split('_');
            const lastPart = parts[parts.length - 1].split('.')[0];
            if (/^\d+$/.test(lastPart)) {
                // Bunny CDN file
                if (type === 'course') {
                    return `https://skill-finesse-videos.b-cdn.net/courses/${filename}`;
                } else {
                    return `https://skill-finesse-videos.b-cdn.net/ebooks/${filename}`;
                }
            }
        }
        
        // Local file
        if (type === 'course') {
            return `/static/images/${filename}`;
        } else {
            return `/static/images/ebook_cover/${filename}`;
        }
    }
    
    const imageUrl = itemType === 'course' 
        ? getImageUrl(selectedItem.image, 'course')
        : getImageUrl(selectedItem.cover_image, 'ebook');
    
    document.getElementById('selectedItemImage').src = imageUrl;
    document.getElementById('selectedItemTitle').textContent = itemType === 'course' ? selectedItem.title : selectedItem.name;
    document.getElementById('selectedItemType').textContent = itemType === 'course' ? 'Course' : 'eBook';
    document.getElementById('selectedItemPrice').textContent = `‡ß≥${parseFloat(selectedItem.price || 0).toFixed(2)}`;
    
    // Set form values
    document.getElementById('selectedItemId').value = itemId;
    document.getElementById('selectedItemTypeInput').value = itemType;
    document.getElementById('discountPercent').value = selectedItem.discount_percent || '';
    
    // Update discount preview
    updateDiscountPreview();
    
    // Clear coupons container immediately to avoid showing previous item's coupons
    const couponsContainer = document.getElementById('couponsContainer');
    couponsContainer.innerHTML = `
        <div class="text-center text-muted py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0 mt-2">Loading coupons...</p>
        </div>
    `;
    
    // Load existing coupons
    loadItemCoupons(itemId, itemType);
}

// Update discount preview
function updateDiscountPreview() {
    const price = parseFloat(selectedItem.price || 0);
    const discount = parseFloat(document.getElementById('discountPercent').value || 0);
    const previewElement = document.getElementById('discountedPricePreview');
    
    if (discount > 0 && price > 0) {
        const discountAmount = (price * discount) / 100;
        const finalPrice = price - discountAmount;
        previewElement.innerHTML = `‡ß≥${discountAmount.toFixed(2)} off - Final: ‡ß≥${finalPrice.toFixed(2)}`;
    } else {
        previewElement.innerHTML = 'Set discount to see preview';
    }
}

// Load existing coupons for selected item
function loadItemCoupons(itemId, itemType) {
    console.log('üîÑ Loading coupons for:', itemType, 'ID:', itemId);
    
    // Clear existing coupons first
    const container = document.getElementById('couponsContainer');
    container.innerHTML = `
        <div class="text-center text-muted py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0 mt-2">Loading coupons...</p>
        </div>
    `;
    
    const endpoint = itemType === 'course' ? `/admin/courses/${itemId}` : `/admin/ebook/${itemId}`;
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            console.log('üìä Coupon data response:', data);
            if (data.success) {
                const item = data.course || data.ebook;
                console.log('‚úÖ Found item with coupons:', item.coupons ? item.coupons.length : 0);
                displayCoupons(item.coupons || []);
            } else {
                console.error('‚ùå Failed to load coupons:', data.message);
                displayCoupons([]);
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading coupons:', error);
            displayCoupons([]);
        });
}

// Display coupons
function displayCoupons(coupons) {
    const container = document.getElementById('couponsContainer');
    
    if (!coupons || coupons.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
                <p class="mb-0">No coupons created yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = coupons.map(coupon => createCouponHTML(coupon)).join('');
}

// Create coupon HTML
function createCouponHTML(coupon) {
    return `
        <div class="coupon-item mb-3" data-coupon-id="${coupon.id}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="coupon-code">${coupon.code}</span>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editCoupon(${coupon.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCoupon(${coupon.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row small">
                <div class="col-6">
                    <strong>${coupon.discount_percent}% OFF</strong>
                </div>
                <div class="col-6 text-end">
                    <span class="badge ${coupon.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${coupon.is_active ? 'Active' : 'Inactive'}
                    </span>
                </div>
            </div>
            ${coupon.usage_limit ? `<div class="small text-muted">Limit: ${coupon.used_count}/${coupon.usage_limit} used</div>` : ''}
            ${coupon.valid_from || coupon.valid_until ? `
                <div class="small text-muted">
                    ${coupon.valid_from ? `From: ${new Date(coupon.valid_from).toLocaleDateString()}` : ''}
                    ${coupon.valid_until ? `Until: ${new Date(coupon.valid_until).toLocaleDateString()}` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

// Add discount percent change listener
document.getElementById('discountPercent').addEventListener('input', updateDiscountPreview);

// Handle discount form submission
document.getElementById('discountForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!selectedItem) {
        showError('No item selected');
        return;
    }
    
    const formData = new FormData(this);
    const endpoint = selectedItem.type === 'course' 
        ? `/admin/courses/${selectedItem.id}/discount`
        : `/admin/ebooks/${selectedItem.id}/discount`;
    
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Discount updated successfully!');
            // Update the item display
            selectedItem.discount_percent = parseFloat(formData.get('discount_percent'));
            selectedItem.discounted_price = data.discounted_price;
            // Refresh the current tab display
            showTab(currentTab);
        } else {
            showError('Error updating discount: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error updating discount. Please try again.');
    });
});

// Show error message
function showError(message) {
    showNotification(message, 'error');
}

// Show success message
function showSuccess(message) {
    showNotification(message, 'success');
}

// Show notification
function showNotification(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Add new coupon
function addNewCoupon() {
    if (!selectedItem) {
        showError('Please select an item first');
        return;
    }
    
    // Show coupon creation modal
    showCouponModal();
}

// Show coupon creation/edit modal
function showCouponModal(existingCoupon = null) {
    const modalHtml = `
        <div class="modal fade" id="couponModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${existingCoupon ? 'Edit Coupon' : 'Create New Coupon'}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="couponForm">
                            <div class="mb-3">
                                <label class="form-label">Coupon Code *</label>
                                <input type="text" class="form-control" id="couponCode" 
                                       value="${existingCoupon ? existingCoupon.code : ''}" 
                                       ${existingCoupon ? 'readonly' : ''} 
                                       placeholder="e.g., SAVE20" required>
                                <div class="form-text">Use uppercase letters and numbers only</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Discount Percentage (%) *</label>
                                <input type="number" class="form-control" id="couponDiscount" 
                                       value="${existingCoupon ? existingCoupon.discount_percent : ''}" 
                                       min="1" max="100" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Usage Limit</label>
                                <input type="number" class="form-control" id="couponLimit" 
                                       value="${existingCoupon ? (existingCoupon.usage_limit || '') : ''}" 
                                       placeholder="Leave empty for unlimited">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valid Until</label>
                                <input type="datetime-local" class="form-control" id="couponExpiry" 
                                       value="${existingCoupon && existingCoupon.valid_until ? existingCoupon.valid_until.split('.')[0] : ''}">
                            </div>
                            ${existingCoupon ? `
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="couponActive" 
                                           ${existingCoupon.is_active ? 'checked' : ''}>
                                    <label class="form-check-label" for="couponActive">
                                        Active
                                    </label>
                                </div>
                            </div>
                            ` : ''}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveCoupon(${existingCoupon ? existingCoupon.id : 'null'})">
                            ${existingCoupon ? 'Update' : 'Create'} Coupon
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('couponModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('couponModal'));
    modal.show();
}

// Save coupon
function saveCoupon(couponId = null) {
    const code = document.getElementById('couponCode').value.trim().toUpperCase();
    const discount = document.getElementById('couponDiscount').value;
    const limit = document.getElementById('couponLimit').value;
    const expiry = document.getElementById('couponExpiry').value;
    const isActive = couponId ? document.getElementById('couponActive').checked : true;
    
    if (!code || !discount) {
        showError('Please fill in all required fields');
        return;
    }
    
    const data = {
        code: code,
        discount_percent: parseFloat(discount),
        usage_limit: limit ? parseInt(limit) : null,
        valid_until: expiry || null
    };
    
    if (couponId) {
        // Edit existing coupon
        data.type = selectedItem.type;
        data.is_active = isActive;
        
        fetch(`/admin/coupons/${couponId}/edit`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showSuccess('Coupon updated successfully!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
                modal.hide();
                loadItemCoupons(selectedItem.id, selectedItem.type);
            } else {
                showError('Error updating coupon: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error updating coupon. Please try again.');
        });
    } else {
        // Create new coupon
        const endpoint = selectedItem.type === 'course'
            ? `/admin/courses/${selectedItem.id}/coupons`
            : `/admin/ebooks/${selectedItem.id}/coupons`;
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showSuccess('Coupon created successfully!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
                modal.hide();
                loadItemCoupons(selectedItem.id, selectedItem.type);
            } else {
                showError('Error creating coupon: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error creating coupon. Please try again.');
        });
    }
}

// Edit coupon
function editCoupon(couponId) {
    // Find the coupon data from the current display
    const couponElement = document.querySelector(`[data-coupon-id="${couponId}"]`);
    if (!couponElement) {
        showError('Coupon not found');
        return;
    }
    
    // Get coupon details from the displayed item
    fetch(`${selectedItem.type === 'course' ? '/admin/courses' : '/admin/ebook'}/${selectedItem.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const item = data.course || data.ebook;
                const coupon = item.coupons.find(c => c.id === couponId);
                if (coupon) {
                    showCouponModal(coupon);
                } else {
                    showError('Coupon not found');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error loading coupon details');
        });
}

// Delete coupon
function deleteCoupon(couponId) {
    if (!confirm('Are you sure you want to delete this coupon?')) {
        return;
    }
    
    fetch(`/admin/coupons/${couponId}/delete?type=${selectedItem.type}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Coupon deleted successfully!');
            loadItemCoupons(selectedItem.id, selectedItem.type);
        } else {
            showError('Error deleting coupon: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error deleting coupon. Please try again.');
    });
}

// Debug function to manually test tab display
window.testTabDisplay = function() {
    console.log('üß™ Testing tab display...');
    console.log('Courses array:', allCourses);
    console.log('Ebooks array:', allEbooks);
    
    displayAllItems();
    displayCourses();
    displayEbooks();
    
    console.log('‚úÖ Manual test completed');
};

// Debug function to reload data
window.reloadDiscountData = function() {
    console.log('üîÑ Manually reloading data...');
    loadAllItems();
};
</script>