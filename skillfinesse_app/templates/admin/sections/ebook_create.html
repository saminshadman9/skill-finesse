<!-- eBook Create Section -->
<style>
    /* Image Preview Styles */
    .image-preview-container {
        position: relative;
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background-color: #fafafa;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .image-preview-container:hover {
        border-color: #00a651;
        background-color: #f0f8f0;
    }
    
    .upload-placeholder {
        color: #999;
    }
    
    .upload-placeholder i {
        font-size: 3rem;
        margin-bottom: 10px;
        color: #ccc;
    }
    
    .upload-placeholder p {
        margin: 10px 0 5px 0;
        font-weight: 600;
    }
    
    .image-upload {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .image-preview-large {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .existing-file-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .existing-file-preview:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .file-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .file-icon {
        font-size: 2.5rem;
        color: #00a651;
    }
    
    .file-details h6 {
        margin: 0 0 5px 0;
        color: #333;
        font-weight: 600;
    }
    
    .file-details small {
        color: #666;
        display: block;
    }
    
    .file-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }
</style>

<div class="content-section" id="ebook-create-section" style="display: none;">
    <div class="page-header">
        <h1>eBook Management</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Admin</a></li>
                <li class="breadcrumb-item active" aria-current="page">eBook Create</li>
            </ol>
        </nav>
    </div>
    
    <!-- eBook Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-info">
                        <h3 id="totalEbooks" class="stat-value">{{ ebooks|length }}</h3>
                        <p class="stat-label">Total eBooks</p>
                    </div>
                    <div class="stat-icon primary">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-info">
                        <h3 id="publishedEbooks" class="stat-value">{{ ebooks|selectattr('is_published', 'equalto', true)|list|length }}</h3>
                        <p class="stat-label">Published eBooks</p>
                    </div>
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-info">
                        <h3 id="totalPurchases" class="stat-value">{{ ebook_purchases|length }}</h3>
                        <p class="stat-label">Total Purchases</p>
                    </div>
                    <div class="stat-icon warning">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create New eBook -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-plus-circle me-2"></i>Create New eBook</h3>
                </div>
                <div class="card-body">
                    <form id="ebookCreateForm" method="POST" action="/admin/ebook/create" enctype="multipart/form-data" novalidate onsubmit="return false;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="ebookName" class="form-label">eBook Name *</label>
                                    <input type="text" class="form-control" id="ebookName" name="name" required maxlength="200">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="ebookAuthor" class="form-label">Author Name *</label>
                                    <input type="text" class="form-control" id="ebookAuthor" name="author" required maxlength="100">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="ebookCategory" class="form-label">Category</label>
                                    <select class="form-select" id="ebookCategory" name="category">
                                        <option value="">Select Category</option>
                                        <option value="Programming">Programming</option>
                                        <option value="Data Science">Data Science</option>
                                        <option value="Web Development">Web Development</option>
                                        <option value="Mobile Development">Mobile Development</option>
                                        <option value="UI/UX Design">UI/UX Design</option>
                                        <option value="Digital Marketing">Digital Marketing</option>
                                        <option value="Business">Business</option>
                                        <option value="Technology">Technology</option>
                                        <option value="Personal Development">Personal Development</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Health & Wellness">Health & Wellness</option>
                                        <option value="Education">Education</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="ebookPrice" class="form-label">Price (à§³) *</label>
                                            <input type="number" class="form-control" id="ebookPrice" name="price" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="ebookPages" class="form-label">Number of Pages</label>
                                            <input type="number" class="form-control" id="ebookPages" name="pages" min="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="ebookLanguage" class="form-label">Language</label>
                                            <select class="form-select" id="ebookLanguage" name="language">
                                                <option value="English">English</option>
                                                <option value="Bengali">Bengali</option>
                                                <option value="Hindi">Hindi</option>
                                                <option value="Spanish">Spanish</option>
                                                <option value="French">French</option>
                                                <option value="German">German</option>
                                                <option value="Arabic">Arabic</option>
                                                <option value="Chinese">Chinese</option>
                                                <option value="Japanese">Japanese</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="ebookISBN" class="form-label">ISBN</label>
                                            <input type="text" class="form-control" id="ebookISBN" name="isbn" maxlength="20">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="ebookPublicationDate" class="form-label">Publication Date</label>
                                    <input type="date" class="form-control" id="ebookPublicationDate" name="publication_date">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="ebookDescription" class="form-label">Description *</label>
                                    <textarea class="form-control" id="ebookDescription" name="description" rows="8" required placeholder="Provide a detailed description of the eBook content, what readers will learn, and why they should read it..."></textarea>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="ebookCover" class="form-label">eBook Cover Image</label>
                                    <div class="image-preview-container" id="ebookCoverPreview">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-image"></i>
                                            <p>Click to upload cover image</p>
                                            <small>Recommended: 400x600px, Max: 5MB</small>
                                        </div>
                                        <input type="file" class="image-upload" id="ebookCover" name="cover_image" accept="image/*">
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="ebookPDF" class="form-label">eBook PDF File</label>
                                    <input type="file" class="form-control" id="ebookPDF" name="pdf_file" accept=".pdf">
                                    <small class="form-text text-muted">Upload the PDF file of the eBook. Max size: 50MB</small>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Publication Settings -->
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ebookIsPublished" name="is_published">
                                        <label class="form-check-label" for="ebookIsPublished">
                                            <strong><i class="fas fa-eye me-2"></i>Publish eBook immediately</strong>
                                            <small class="d-block text-muted mt-1">
                                                <i class="fas fa-info-circle me-1"></i>
                                                If unchecked, the eBook will be saved as draft. You can publish it later from the "Existing eBooks" section.
                                            </small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" onclick="handleEbookSubmit(event)">
                                <i class="fas fa-save me-2"></i>Create eBook
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetEbookFormCompletely()">
                                <i class="fas fa-undo me-2"></i>Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Existing eBooks List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-list me-2"></i>Existing eBooks</h3>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshEbookList()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cover</th>
                                    <th>eBook Name</th>
                                    <th>Author</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Purchases</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ebookTableBody">
                                {% for ebook in ebooks %}
                                <tr>
                                    <td>
                                        <img src="{% if ebook.cover_image %}{% if '_' in ebook.cover_image and ebook.cover_image.split('_')[-1].split('.')[0].isdigit() %}https://skill-finesse-videos.b-cdn.net/ebooks/{{ ebook.cover_image }}{% else %}{{ url_for('static', filename='images/ebook_cover/' + ebook.cover_image) }}{% endif %}{% else %}{{ url_for('static', filename='images/premium_course_1.png') }}{% endif %}" 
                                             alt="{{ ebook.name }}" 
                                             style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px;">
                                    </td>
                                    <td>
                                        <strong>{{ ebook.name }}</strong><br>
                                        <small class="text-muted">{{ ebook.pages }} pages</small>
                                    </td>
                                    <td>{{ ebook.author }}</td>
                                    <td>
                                        {% if ebook.category %}
                                            <span class="badge bg-secondary">{{ ebook.category }}</span>
                                        {% else %}
                                            <span class="text-muted">No category</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ebook.coupon and ebook.coupon_discount %}
                                            <span class="text-decoration-line-through text-muted">à§³{{ ebook.price|round|int }}</span><br>
                                            <strong class="text-success">à§³{{ (ebook.price * (100 - ebook.coupon_discount) / 100)|round|int }}</strong>
                                        {% else %}
                                            <strong>à§³{{ ebook.price|round|int }}</strong>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ebook.is_published %}
                                            <span class="badge bg-success">Published</span>
                                        {% else %}
                                            <span class="badge bg-warning">Draft</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ ebook.total_purchases }}</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editEbook({{ ebook.id }})" title="Edit eBook">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-info" onclick="viewEbook({{ ebook.id }})" title="View eBook">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if ebook.is_published %}
                                                <button class="btn btn-outline-warning" onclick="unpublishEbook({{ ebook.id }})" title="Unpublish">
                                                    <i class="fas fa-eye-slash"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-outline-success" onclick="publishEbook({{ ebook.id }})" title="Publish">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-outline-danger" onclick="deleteEbook({{ ebook.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-book fa-3x mb-3"></i>
                                            <p>No eBooks created yet</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Format datetime for HTML datetime-local input
function formatDateTimeForInput(dateTimeString) {
    if (!dateTimeString) return '';
    
    try {
        // Handle ISO format strings (with T separator)
        let cleanDateTime = dateTimeString;
        
        // If it's already in the right format, return it
        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(cleanDateTime)) {
            return cleanDateTime;
        }
        
        // Convert ISO format to datetime-local format (YYYY-MM-DDTHH:MM)
        const date = new Date(cleanDateTime);
        if (isNaN(date.getTime())) {
            return '';
        }
        
        // Format to YYYY-MM-DDTHH:MM
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch (error) {
        console.warn('Error formatting datetime:', dateTimeString, error);
        return '';
    }
}

// eBook Management JavaScript Functions
let isEbookEditMode = false;
let editingEbookId = null;

// Helper function to get correct ebook cover URL
function getEbookCoverUrl(ebook) {
    if (!ebook.cover_image) {
        return '/static/images/premium_course_1.png';
    }
    
    // Check if it's an admin-uploaded image (contains underscore and ends with timestamp)
    if (ebook.cover_image.includes('_')) {
        const parts = ebook.cover_image.split('_');
        const lastPart = parts[parts.length - 1];
        const fileNameWithoutExt = lastPart.split('.')[0];
        if (!isNaN(fileNameWithoutExt) && fileNameWithoutExt.length > 0) {
            return `https://skill-finesse-videos.b-cdn.net/ebooks/${ebook.cover_image}`;
        }
    }
    
    // Default to ebook_cover folder
    return `/static/images/ebook_cover/${ebook.cover_image}`;
}

document.addEventListener('DOMContentLoaded', function() {
    // Image preview functionality
    const coverInput = document.getElementById('ebookCover');
    const coverPreview = document.getElementById('ebookCoverPreview');
    let selectedCoverFile = null;
    
    if (coverInput && coverPreview) {
        coverInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            selectedCoverFile = file; // Store the selected file
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create preview image element
                    const existingImg = coverPreview.querySelector('.image-preview-large');
                    if (existingImg) {
                        existingImg.src = e.target.result;
                    } else {
                        const previewImg = document.createElement('img');
                        previewImg.src = e.target.result;
                        previewImg.className = 'image-preview-large';
                        previewImg.alt = 'Cover Preview';
                        previewImg.style.cssText = 'width: 100%; height: 300px; object-fit: cover; border-radius: 15px; margin-bottom: 15px;';
                        
                        // Insert preview image before the input
                        coverPreview.insertBefore(previewImg, coverInput);
                    }
                    
                    // Hide the upload placeholder
                    const placeholder = coverPreview.querySelector('.upload-placeholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Handle ebook submit button click
    window.handleEbookSubmit = function(event) {
        console.log('ð¥ handleEbookSubmit called');
        event.preventDefault();
        event.stopPropagation();
        submitEbookForm();
        return false;
    };
    
    // Form submission handler
    function submitEbookForm() {
        const ebookForm = document.getElementById('ebookCreateForm');
        if (!ebookForm) {
            console.error('ð¥ eBook form not found!');
            showEbookMessage('error', 'Form not found. Please refresh the page.');
            return;
        }
        
        console.log('ð¥ Submitting eBook form');
        
        // Clear any existing custom validity on datetime inputs
        const datetimeInputs = ebookForm.querySelectorAll('input[type="datetime-local"]');
        datetimeInputs.forEach(input => {
            input.setCustomValidity('');
        });
        
        const formData = new FormData(ebookForm);
        
        // Ensure the cover image file is included in FormData
        if (selectedCoverFile) {
            formData.set('cover_image', selectedCoverFile);
            console.log('Cover image added to FormData:', selectedCoverFile.name);
        } else {
            console.log('No cover image selected');
        }
        
        const submitBtn = ebookForm.querySelector('button[onclick*="handleEbookSubmit"]');
        const originalText = submitBtn ? submitBtn.innerHTML : '<i class="fas fa-save me-2"></i>Create eBook';
        
        // Determine endpoint and action based on edit mode
        const isEditing = isEbookEditMode && editingEbookId;
        const endpoint = isEditing ? `/admin/ebook/${editingEbookId}/edit` : '/admin/ebook/create';
        const actionText = isEditing ? 'Updating...' : 'Creating...';
        
        // Check if publish checkbox is checked for better user feedback
        const publishCheckbox = ebookForm.querySelector('#ebookIsPublished');
        const willBePublished = publishCheckbox ? publishCheckbox.checked : false;
        console.log('ð¥ eBook will be published:', willBePublished);
        
        // Show loading state
        if (submitBtn) {
            submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${actionText}`;
            submitBtn.disabled = true;
        }
        
        fetch(endpoint, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('ð¥ eBook response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ð¥ eBook response data:', data);
            if (data.success) {
                let successMessage;
                if (isEditing) {
                    successMessage = 'eBook updated successfully!';
                } else {
                    // For new eBooks, indicate if it was published or saved as draft
                    const publishCheckbox = ebookForm.querySelector('#ebookIsPublished');
                    const wasPublished = publishCheckbox ? publishCheckbox.checked : false;
                    successMessage = wasPublished ? 
                        'eBook created and published successfully!' : 
                        'eBook created as draft successfully! Use the publish button in "Existing eBooks" to make it live.';
                }
                showEbookMessage('success', successMessage);
                
                if (!isEditing) {
                    // Only reset form if creating new eBook
                    ebookForm.reset();
                    selectedCoverFile = null; // Reset the stored file
                    
                    // Reset image preview
                    if (coverPreview) {
                        const existingImg = coverPreview.querySelector('.image-preview-large');
                        if (existingImg) {
                            existingImg.remove();
                        }
                        
                        const placeholder = coverPreview.querySelector('.upload-placeholder');
                        if (placeholder) {
                            placeholder.style.display = 'block';
                        }
                    }
                } else {
                    // Reset edit mode
                    isEbookEditMode = false;
                    editingEbookId = null;
                    if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Create eBook';
                }
                
                // Delay refresh to show the success message
                setTimeout(() => {
                    refreshEbookList();
                }, 2000);
            } else {
                const errorMessage = isEditing ? 'Error updating eBook: ' + data.message : 'Error creating eBook: ' + data.message;
                showEbookMessage('error', errorMessage);
            }
        })
        .catch(error => {
            console.error('ð¥ eBook submission error:', error);
            const errorMessage = isEditing ? 'An error occurred while updating the eBook.' : 'An error occurred while creating the eBook.';
            showEbookMessage('error', errorMessage);
        })
        .finally(() => {
            if (submitBtn) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    }
});

function editEbook(ebookId) {
    console.log('âï¸ editEbook called with ID:', ebookId);
    if (!ebookId) {
        showEbookMessage('error', 'Invalid eBook ID');
        return;
    }
    // Show loading notification
    showEbookMessage('info', 'Loading eBook data for editing...');
    
    // Fetch ebook data and populate form for editing
    fetch(`/admin/ebook/${ebookId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            console.log('â Response status:', response.status);
            console.log('â Response headers:', response.headers.get('content-type'));
            if (!response.ok) {
                return response.text().then(text => {
                    console.log('â Error response text:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('ð Ebook data received:', data);
            if (data.success) {
                const ebook = data.ebook;
                console.log('ð¼ï¸ Cover image:', ebook.cover_image);
                console.log('ð PDF file:', ebook.pdf_file);
                
                // Show success notification
                showEbookMessage('success', 'eBook loaded successfully! You can now edit the details.');
                
                // Set edit mode
                isEbookEditMode = true;
                editingEbookId = ebookId;
                
                // Populate basic form fields
                document.getElementById('ebookName').value = ebook.name;
                document.getElementById('ebookAuthor').value = ebook.author;
                document.getElementById('ebookCategory').value = ebook.category || '';
                document.getElementById('ebookPrice').value = ebook.price;
                document.getElementById('ebookPages').value = ebook.pages || '';
                document.getElementById('ebookLanguage').value = ebook.language;
                document.getElementById('ebookISBN').value = ebook.isbn || '';
                document.getElementById('ebookPublicationDate').value = ebook.publication_date || '';
                document.getElementById('ebookDescription').value = ebook.description;
                document.getElementById('ebookIsPublished').checked = ebook.is_published;
                
                // Note: Public discount is now managed in the Discount & Coupon Management section
                // document.getElementById('ebookPublicDiscountPercent').value = ebook.discount_percent || 0;
                
                // Show existing cover image preview if available
                const coverPreview = document.getElementById('ebookCoverPreview');
                console.log('ð¼ï¸ Cover preview element found:', !!coverPreview);
                console.log('ð¼ï¸ Cover image value:', ebook.cover_image);
                
                if (ebook.cover_image && ebook.cover_image.trim() !== '' && coverPreview) {
                    console.log('â Showing cover image preview for:', ebook.cover_image);
                    
                    // Clear all existing previews first
                    clearFilePreviewsInEbook();
                    
                    // Hide the upload placeholder
                    const placeholder = coverPreview.querySelector('.upload-placeholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                    
                    // Create preview container
                    const previewContainer = document.createElement('div');
                    previewContainer.className = 'existing-file-preview';
                    previewContainer.innerHTML = `
                        <div class="file-info">
                            <img src="${getEbookCoverUrl(ebook)}" 
                                 alt="Current Cover" 
                                 style="width: 120px; height: 160px; object-fit: cover; border-radius: 8px; border: 2px solid #dee2e6;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; width: 120px; height: 160px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; display: flex; align-items: center; justify-content: center; color: #999;">
                                <i class="fas fa-image fa-3x"></i>
                            </div>
                            <div class="file-details flex-grow-1">
                                <h6>Current Cover Image</h6>
                                <small class="text-muted">${ebook.cover_image}</small>
                                <small class="text-info d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Upload a new image to replace this cover
                                </small>
                            </div>
                            <div class="file-actions">
                                <a href="${getEbookCoverUrl(ebook)}" target="_blank" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>View Full Size
                                </a>
                            </div>
                        </div>
                    `;
                    
                    const coverInput = document.getElementById('ebookCover');
                    coverPreview.insertBefore(previewContainer, coverInput);
                } else {
                    console.log('â¹ï¸ No cover image to show or element not found. Cover image:', ebook.cover_image, 'Element:', coverPreview);
                }
                
                // Show existing PDF file if available
                console.log('ð PDF file value:', ebook.pdf_file);
                const pdfInput = document.getElementById('ebookPDF');
                console.log('ð PDF input element found:', !!pdfInput);
                
                if (ebook.pdf_file && ebook.pdf_file.trim() !== '' && pdfInput) {
                    console.log('â Showing PDF preview for:', ebook.pdf_file);
                    
                    // Create or update existing PDF preview
                    let existingPdfPreview = pdfInput.parentElement.querySelector('.existing-file-preview');
                    if (existingPdfPreview) {
                        existingPdfPreview.remove();
                    }
                    
                    const pdfPreview = document.createElement('div');
                    pdfPreview.className = 'existing-file-preview';
                    pdfPreview.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fas fa-file-pdf" style="color: #dc3545;"></i>
                            </div>
                            <div class="file-details flex-grow-1">
                                <h6>Current PDF File</h6>
                                <small class="text-muted">${ebook.pdf_file}</small>
                                <small class="text-info d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Upload a new PDF file to replace this eBook
                                </small>
                            </div>
                            <div class="file-actions">
                                <a href="/static/uploads/ebooks/${ebook.pdf_file}" target="_blank" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>Open PDF
                                </a>
                                <a href="/static/uploads/ebooks/${ebook.pdf_file}" download 
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                            </div>
                        </div>
                    `;
                    
                    pdfInput.parentElement.insertBefore(pdfPreview, pdfInput);
                } else {
                    console.log('â¹ï¸ No PDF file to show. PDF file:', ebook.pdf_file);
                }
                
                // Note: Coupons are now managed in the Discount & Coupon Management section
                // Skip coupon population in edit mode
                /*
                const couponsContainer = document.getElementById('ebookCouponsContainer');
                if (couponsContainer) {
                    couponsContainer.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
                            <p class="mb-0">No coupons added yet. Click "Add Coupon" to create one.</p>
                        </div>
                    `;
                }
                */
                
                // Reset coupon counter and array
                ebookCouponCounter = 0;
                ebookCoupons = [];
                
                // Skip coupon population since it's managed separately now
                if (false && ebook.coupons && ebook.coupons.length > 0) {
                    ebook.coupons.forEach(coupon => {
                        ebookCouponCounter++;
                        const couponId = 'ebook_coupon_' + ebookCouponCounter;
                        
                        const couponHtml = `
                            <div class="coupon-item border rounded p-3 mb-3" id="${couponId}">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0 text-secondary"><i class="fas fa-ticket-alt me-2"></i>Coupon #${ebookCouponCounter}</h6>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEbookCoupon('${couponId}')">
                                        <i class="fas fa-trash me-1"></i>Remove
                                    </button>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Coupon Code *</label>
                                        <input type="text" class="form-control coupon-code" name="coupons[${ebookCouponCounter}][code]" 
                                               value="${coupon.code}" placeholder="e.g., SAVE50" required style="text-transform: uppercase;">
                                        <div class="form-text">Enter unique coupon code</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Discount % *</label>
                                        <input type="number" class="form-control coupon-discount" name="coupons[${ebookCouponCounter}][discount_percent]" 
                                               value="${coupon.discount_percent}" min="1" max="100" placeholder="25" required onchange="updateEbookCouponPreview('${couponId}')">
                                        <div class="form-text">1-100% discount</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Usage Limit</label>
                                        <input type="number" class="form-control" name="coupons[${ebookCouponCounter}][usage_limit]" 
                                               value="${coupon.usage_limit || ''}" min="1" placeholder="100">
                                        <div class="form-text">Leave empty for unlimited</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Valid From</label>
                                        <input type="datetime-local" class="form-control datetime-input" 
                                               name="coupons[${ebookCouponCounter}][valid_from]" 
                                               id="ebook_edit_valid_from_${ebookCouponCounter}"
                                               value="${coupon.valid_from ? formatDateTimeForInput(coupon.valid_from) : ''}">
                                        <div class="form-text">Leave empty for immediate activation</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Valid Until</label>
                                        <input type="datetime-local" class="form-control datetime-input" 
                                               name="coupons[${ebookCouponCounter}][valid_until]" 
                                               id="ebook_edit_valid_until_${ebookCouponCounter}"
                                               value="${coupon.valid_until ? formatDateTimeForInput(coupon.valid_until) : ''}">
                                        <div class="form-text">Leave empty for no expiry</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="coupons[${ebookCouponCounter}][is_active]" 
                                                   id="ebook_active_${ebookCouponCounter}" ${coupon.is_active ? 'checked' : ''}>
                                            <label class="form-check-label" for="ebook_active_${ebookCouponCounter}">
                                                Active Coupon
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="coupon-preview text-end">
                                            <small class="text-muted">Discount Preview:</small>
                                            <div class="fw-bold text-success" id="ebook_preview_${couponId}">à§³${(ebook.price * (100 - coupon.discount_percent) / 100).toFixed(0)} <small class="text-muted">(à§³${(ebook.price * coupon.discount_percent / 100).toFixed(0)} off)</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        couponsContainer.insertAdjacentHTML('beforeend', couponHtml);
                        
                        // Add event listeners for datetime inputs to clear validation messages
                        const validFromInput = document.getElementById(`ebook_edit_valid_from_${ebookCouponCounter}`);
                        const validUntilInput = document.getElementById(`ebook_edit_valid_until_${ebookCouponCounter}`);
                        
                        if (validFromInput) {
                            validFromInput.addEventListener('input', function() {
                                this.setCustomValidity('');
                            });
                            validFromInput.addEventListener('change', function() {
                                this.setCustomValidity('');
                            });
                        }
                        
                        if (validUntilInput) {
                            validUntilInput.addEventListener('input', function() {
                                this.setCustomValidity('');
                            });
                            validUntilInput.addEventListener('change', function() {
                                this.setCustomValidity('');
                            });
                        }
                        
                        ebookCoupons.push({id: couponId, counter: ebookCouponCounter});
                    });
                }
                
                // Note: Price previews are now handled in Discount & Coupon Management section
                // updateEbookPublicDiscountPreview();
                
                // Change form action to edit mode
                const form = document.getElementById('ebookCreateForm');
                form.action = `/admin/ebook/${ebookId}/edit`;
                
                // Update the submit button text
                const submitBtn = form.querySelector('button[onclick*="handleEbookSubmit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update eBook';
                }
                
                // Scroll to the form for better user experience
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                console.error('â Server returned error:', data.message);
                // Silently handle server error without showing error message to user
            }
        })
        .catch(error => {
            console.error('â Error loading ebook:', error);
            // Silently handle the error without showing error message to user
            console.log('ð Note: If you see this error, make sure you are logged in as admin');
        });
}


function viewEbook(ebookId) {
    console.log('ð viewEbook called with ID:', ebookId);
    if (!ebookId) {
        showEbookMessage('error', 'Invalid eBook ID');
        return;
    }
    // Open eBook details page in new tab
    window.open(`/ebook/${ebookId}`, '_blank');
}


function publishEbook(ebookId) {
    if (!ebookId) {
        showEbookMessage('error', 'Invalid eBook ID');
        return;
    }
    
    if (confirm('Are you sure you want to publish this eBook?')) {
        showEbookMessage('info', 'Publishing eBook...', 2000);
        
        fetch(`/admin/ebook/${ebookId}/publish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showEbookMessage('success', 'eBook published successfully!');
                setTimeout(() => {
                    refreshEbookList();
                }, 2000);
            } else {
                showEbookMessage('error', 'Error publishing eBook: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Publish eBook error:', error);
            showEbookMessage('error', 'Failed to publish eBook. Please try again.');
        });
    }
}


function unpublishEbook(ebookId) {
    console.log('ðï¸âð¨ï¸ unpublishEbook called with ID:', ebookId);
    if (!ebookId) {
        showEbookMessage('error', 'Invalid eBook ID');
        return;
    }
    
    if (confirm('Are you sure you want to unpublish this eBook?')) {
        showEbookMessage('info', 'Unpublishing eBook...', 2000);
        
        fetch(`/admin/ebook/${ebookId}/unpublish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showEbookMessage('success', 'eBook unpublished successfully!');
                setTimeout(() => {
                    refreshEbookList();
                }, 2000);
            } else {
                showEbookMessage('error', 'Error unpublishing eBook: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Unpublish eBook error:', error);
            showEbookMessage('error', 'Failed to unpublish eBook. Please try again.');
        });
    }
}


function deleteEbook(ebookId) {
    console.log('ðï¸ deleteEbook called with ID:', ebookId);
    if (!ebookId) {
        showEbookMessage('error', 'Invalid eBook ID');
        return;
    }
    
    if (confirm('Are you sure you want to delete this eBook? This action cannot be undone.')) {
        showEbookMessage('info', 'Deleting eBook...', 2000);
        
        fetch(`/admin/ebook/${ebookId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showEbookMessage('success', 'eBook deleted successfully!');
                // Delay refresh to show the success message
                setTimeout(() => {
                    refreshEbookList();
                }, 2000);
            } else {
                showEbookMessage('error', 'Error deleting eBook: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Delete eBook error:', error);
            showEbookMessage('error', 'Failed to delete eBook. Please try again.');
        });
    }
}


function refreshEbookList() {
    location.reload();
}

// ===== EBOOK COUPON MANAGEMENT FUNCTIONS =====
let ebookCouponCounter = 0;
let ebookCoupons = [];

// Add new coupon to the form
function addNewEbookCoupon() {
    ebookCouponCounter++;
    const couponId = 'ebook_coupon_' + ebookCouponCounter;
    
    const couponHtml = `
        <div class="coupon-item border rounded p-3 mb-3" id="${couponId}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 text-secondary"><i class="fas fa-ticket-alt me-2"></i>Coupon #${ebookCouponCounter}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEbookCoupon('${couponId}')">
                    <i class="fas fa-trash me-1"></i>Remove
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Coupon Code *</label>
                    <input type="text" class="form-control coupon-code" name="coupons[${ebookCouponCounter}][code]" 
                           placeholder="e.g., SAVE50" required style="text-transform: uppercase;">
                    <div class="form-text">Enter unique coupon code</div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Discount % *</label>
                    <input type="number" class="form-control coupon-discount" name="coupons[${ebookCouponCounter}][discount_percent]" 
                           min="1" max="100" placeholder="25" required onchange="updateEbookCouponPreview('${couponId}')">
                    <div class="form-text">1-100% discount</div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Usage Limit</label>
                    <input type="number" class="form-control" name="coupons[${ebookCouponCounter}][usage_limit]" 
                           min="1" placeholder="100">
                    <div class="form-text">Leave empty for unlimited</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Valid From</label>
                    <input type="datetime-local" class="form-control datetime-input" 
                           name="coupons[${ebookCouponCounter}][valid_from]" 
                           id="ebook_valid_from_${ebookCouponCounter}">
                    <div class="form-text">Leave empty for immediate activation</div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">Valid Until</label>
                    <input type="datetime-local" class="form-control datetime-input" 
                           name="coupons[${ebookCouponCounter}][valid_until]" 
                           id="ebook_valid_until_${ebookCouponCounter}">
                    <div class="form-text">Leave empty for no expiry</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="coupons[${ebookCouponCounter}][is_active]" 
                               id="ebook_active_${ebookCouponCounter}" checked>
                        <label class="form-check-label" for="ebook_active_${ebookCouponCounter}">
                            Active Coupon
                        </label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="coupon-preview text-end">
                        <small class="text-muted">Discount Preview:</small>
                        <div class="fw-bold text-success" id="ebook_preview_${couponId}">Set discount % to see preview</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const container = document.getElementById('ebookCouponsContainer');
    
    // Remove the "no coupons" message if it exists
    const noMsgElement = container.querySelector('.text-center.text-muted');
    if (noMsgElement) {
        noMsgElement.remove();
    }
    
    container.insertAdjacentHTML('beforeend', couponHtml);
    
    // Convert coupon code input to uppercase
    const codeInput = document.querySelector(`input[name="coupons[${ebookCouponCounter}][code]"]`);
    codeInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Add event listeners for datetime inputs to clear validation messages
    const validFromInput = document.getElementById(`ebook_valid_from_${ebookCouponCounter}`);
    const validUntilInput = document.getElementById(`ebook_valid_until_${ebookCouponCounter}`);
    
    if (validFromInput) {
        validFromInput.addEventListener('input', function() {
            this.setCustomValidity('');
        });
        validFromInput.addEventListener('change', function() {
            this.setCustomValidity('');
        });
    }
    
    if (validUntilInput) {
        validUntilInput.addEventListener('input', function() {
            this.setCustomValidity('');
        });
        validUntilInput.addEventListener('change', function() {
            this.setCustomValidity('');
        });
    }
    
    ebookCoupons.push({id: couponId, counter: ebookCouponCounter});
}

// Remove coupon from form
function removeEbookCoupon(couponId) {
    const element = document.getElementById(couponId);
    if (element) {
        element.remove();
        
        // Remove from coupons array
        ebookCoupons = ebookCoupons.filter(c => c.id !== couponId);
        
        // Show "no coupons" message if all removed
        const container = document.getElementById('ebookCouponsContainer');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-ticket-alt fa-2x mb-2 opacity-50"></i>
                    <p class="mb-0">No coupons added yet. Click "Add Coupon" to create one.</p>
                </div>
            `;
        }
    }
}

// Update coupon discount preview
function updateEbookCouponPreview(couponId) {
    const ebookPrice = parseFloat(document.getElementById('ebookPrice').value) || 0;
    const discountInput = document.querySelector(`#${couponId} .coupon-discount`);
    const discountPercent = parseFloat(discountInput.value) || 0;
    const previewElement = document.getElementById(`ebook_preview_${couponId}`);
    
    if (ebookPrice > 0 && discountPercent > 0) {
        const discountAmount = ebookPrice * (discountPercent / 100);
        const finalPrice = ebookPrice - discountAmount;
        previewElement.innerHTML = `à§³${finalPrice.toFixed(0)} <small class="text-muted">(à§³${discountAmount.toFixed(0)} off)</small>`;
    } else {
        previewElement.innerHTML = 'Set ebook price and discount % to see preview';
    }
}

// Update public discount preview
function updateEbookPublicDiscountPreview() {
    const ebookPrice = parseFloat(document.getElementById('ebookPrice').value) || 0;
    const discountPercent = parseFloat(document.getElementById('ebookPublicDiscountPercent').value) || 0;
    const previewElement = document.getElementById('ebookDiscountedPricePreview');
    
    if (ebookPrice > 0 && discountPercent > 0) {
        const discountAmount = ebookPrice * (discountPercent / 100);
        const finalPrice = ebookPrice - discountAmount;
        previewElement.innerHTML = `à§³${finalPrice.toFixed(0)} <small class="text-muted">(was à§³${ebookPrice.toFixed(0)} - ${discountPercent}% off)</small>`;
        previewElement.className = 'form-control-plaintext fw-bold text-success';
    } else if (ebookPrice > 0) {
        previewElement.innerHTML = `à§³${ebookPrice.toFixed(0)} <small class="text-muted">(no discount)</small>`;
        previewElement.className = 'form-control-plaintext fw-bold text-primary';
    } else {
        previewElement.innerHTML = 'Set ebook price and discount to see preview';
        previewElement.className = 'form-control-plaintext text-muted';
    }
    
    // Update all coupon previews when ebook price changes
    ebookCoupons.forEach(coupon => {
        updateEbookCouponPreview(coupon.id);
    });
}

// Note: Price and discount updates are now handled in Discount & Coupon Management section
/*
document.addEventListener('DOMContentLoaded', function() {
    const priceInput = document.getElementById('ebookPrice');
    const publicDiscountInput = document.getElementById('ebookPublicDiscountPercent');
    
    if (priceInput) {
        priceInput.addEventListener('input', updateEbookPublicDiscountPreview);
    }
    
    if (publicDiscountInput) {
        publicDiscountInput.addEventListener('input', updateEbookPublicDiscountPreview);
    }
});
*/

// Show notification messages for ebooks
function showEbookMessage(type, message, duration = 5000) {
    // Remove any existing alerts
    const existingAlerts = document.querySelectorAll('.beautiful-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const icon = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-triangle',
        'warning': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle'
    }[type] || 'fas fa-info-circle';
    
    const bgColor = {
        'success': '#d4edda',
        'error': '#f8d7da',
        'warning': '#fff3cd',
        'info': '#d1ecf1'
    }[type] || '#d1ecf1';
    
    const borderColor = {
        'success': '#c3e6cb',
        'error': '#f5c6cb',
        'warning': '#ffeaa7',
        'info': '#bee5eb'
    }[type] || '#bee5eb';
    
    // Create beautiful popup alert
    const alertHtml = `
        <div class="beautiful-alert" style="
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 350px;
            max-width: 500px;
            background: ${bgColor};
            border: 2px solid ${borderColor};
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            animation: slideInRight 0.5s ease-out;
            padding: 0;
            overflow: hidden;
        ">
            <div style="padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="${icon}" style="font-size: 1.5rem; color: var(--bs-${type === 'error' ? 'danger' : type});"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">eBook Management</div>
                        <div style="color: #555; font-size: 0.95rem;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: none;
                        border: none;
                        font-size: 1.2rem;
                        color: #666;
                        cursor: pointer;
                        padding: 0;
                        margin-left: 10px;
                    ">Ã</button>
                </div>
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    height: 4px;
                    background: var(--bs-${type === 'error' ? 'danger' : type});
                    width: 100%;
                    animation: progressBar ${duration}ms linear;
                "></div>
            </div>
        </div>
    `;
    
    // Add CSS animation if not already added
    if (!document.querySelector('#beautiful-alert-styles')) {
        const styles = document.createElement('style');
        styles.id = 'beautiful-alert-styles';
        styles.innerHTML = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes progressBar {
                from { width: 100%; }
                to { width: 0%; }
            }
            .beautiful-alert:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Insert alert
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-remove after duration
    if (duration > 0) {
        setTimeout(() => {
            const alert = document.querySelector('.beautiful-alert');
            if (alert) {
                alert.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => alert.remove(), 300);
            }
        }, duration);
    }
}

// ===== ENSURE ALL FUNCTIONS ARE GLOBALLY ACCESSIBLE =====
// This must be at the end to ensure all functions are defined first
window.editEbook = editEbook;
window.viewEbook = viewEbook;
window.publishEbook = publishEbook;
window.unpublishEbook = unpublishEbook;
window.deleteEbook = deleteEbook;
window.addNewEbookCoupon = addNewEbookCoupon;
window.removeEbookCoupon = removeEbookCoupon;
window.updateEbookCouponPreview = updateEbookCouponPreview;
window.updateEbookPublicDiscountPreview = updateEbookPublicDiscountPreview;
window.showEbookMessage = showEbookMessage;
window.refreshEbookList = refreshEbookList;

// Function to clear file previews in ebook form
function clearFilePreviewsInEbook() {
    // Clear cover image preview
    const coverPreview = document.getElementById('ebookCoverPreview');
    if (coverPreview) {
        const existingPreview = coverPreview.querySelector('.existing-file-preview');
        if (existingPreview) {
            existingPreview.remove();
        }
        
        const existingImg = coverPreview.querySelector('.image-preview-large');
        if (existingImg) {
            existingImg.remove();
        }
        
        const placeholder = coverPreview.querySelector('.upload-placeholder');
        if (placeholder) {
            placeholder.style.display = 'block';
        }
    }
    
    // Clear PDF preview
    const pdfInput = document.getElementById('ebookPDF');
    if (pdfInput && pdfInput.parentElement) {
        const existingPdfPreview = pdfInput.parentElement.querySelector('.existing-file-preview');
        if (existingPdfPreview) {
            existingPdfPreview.remove();
        }
    }
}

// Function to reset ebook form completely
function resetEbookFormCompletely() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        // Reset the form
        document.getElementById('ebookCreateForm').reset();
        
        // Clear file previews
        clearFilePreviewsInEbook();
        
        // Reset edit mode
        isEbookEditMode = false;
        editingEbookId = null;
        
        // Reset submit button
        const submitBtn = document.querySelector('button[onclick*="handleEbookSubmit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Create eBook';
        }
        
        showEbookMessage('info', 'Form has been reset successfully!');
    }
}

// Make functions globally accessible
window.clearFilePreviewsInEbook = clearFilePreviewsInEbook;
window.resetEbookFormCompletely = resetEbookFormCompletely;

console.log('â All eBook functions made globally accessible:', {
    editEbook: typeof window.editEbook,
    viewEbook: typeof window.viewEbook,
    publishEbook: typeof window.publishEbook,
    unpublishEbook: typeof window.unpublishEbook,
    deleteEbook: typeof window.deleteEbook,
    clearFilePreviewsInEbook: typeof window.clearFilePreviewsInEbook,
    resetEbookFormCompletely: typeof window.resetEbookFormCompletely
});
</script>