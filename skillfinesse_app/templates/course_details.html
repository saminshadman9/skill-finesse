{% extends 'base.html' %}

{% block title %}{{ course.title }} - Skill Finesse{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/global-header-footer.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/components/courses-showcase.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/responsive.css') }}" rel="stylesheet">

<style>
    :root {
        --primary-color: #00a651;
        --secondary-color: #333333;
    }

    /* Course Hero Section */
    .course-hero {
        background: linear-gradient(135deg, var(--primary-color) 0%, #008c44 100%);
        color: white;
        padding: 100px 0 80px;
        position: relative;
        overflow: hidden;
    }

    .course-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1;
    }

    .course-hero .container {
        position: relative;
        z-index: 2;
    }

    .course-hero h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 20px;
        animation: fadeInUp 1s ease;
    }

    .course-meta-hero {
        display: flex;
        gap: 30px;
        margin: 30px 0;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1rem;
    }

    .meta-item i {
        color: rgba(255, 255, 255, 0.8);
    }

    .price-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
        backdrop-filter: blur(10px);
    }

    .current-price {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
    }

    .original-price {
        font-size: 1.2rem;
        text-decoration: line-through;
        color: rgba(255, 255, 255, 0.7);
        margin-right: 15px;
    }

    .coupon-info {
        margin-top: 15px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 0.9rem;
    }

    /* Course Content */
    .course-content {
        padding: 80px 0;
    }

    .course-sidebar {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        padding: 30px;
        position: sticky;
        top: 100px;
    }

    .course-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .enroll-btn {
        width: 100%;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        text-align: center;
        margin-bottom: 15px;
    }

    .enroll-btn:hover {
        background: #008c44;
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }

    .enroll-btn.enrolled {
        background: #28a745;
        cursor: default;
    }

    .preview-btn {
        width: 100%;
        background: transparent;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        text-align: center;
    }

    .preview-btn:hover {
        background: var(--primary-color);
        color: white;
        text-decoration: none;
    }

    .course-includes {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #e9ecef;
    }

    .include-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        color: #666;
    }

    .include-item i {
        color: var(--primary-color);
        width: 20px;
    }

    .main-content {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        padding: 40px;
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--secondary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
    }

    .course-description {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #555;
        margin-bottom: 30px;
    }

    .course-content {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #555;
        margin-bottom: 30px;
    }

    .course-content ul {
        margin: 15px 0;
        padding-left: 20px;
    }

    .course-content li {
        margin-bottom: 8px;
        line-height: 1.6;
    }

    .course-content h3, .course-content h4 {
        color: var(--secondary-color);
        margin-top: 25px;
        margin-bottom: 15px;
    }

    .instructor-section {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 25px;
        background: #f8f9fc;
        border-radius: 10px;
        margin-top: 30px;
    }

    .instructor-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-color);
    }

    .instructor-info h4 {
        color: var(--secondary-color);
        margin-bottom: 5px;
    }

    .instructor-info p {
        color: #666;
        margin: 0;
    }

    /* What You'll Learn */
    .learning-outcomes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .outcome-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 15px;
        background: #f8f9fc;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }

    .outcome-item i {
        color: var(--primary-color);
        margin-top: 2px;
    }

    /* Course Requirements */
    .requirements-list {
        list-style: none;
        padding: 0;
    }

    .requirements-list li {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fc;
        border-radius: 8px;
    }

    .requirements-list i {
        color: var(--primary-color);
        margin-top: 2px;
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .main-content, .course-sidebar {
        animation: fadeInUp 0.6s ease;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .course-hero h1 {
            font-size: 2.2rem;
        }

        .course-meta-hero {
            flex-direction: column;
            gap: 15px;
        }

        .current-price {
            font-size: 2rem;
        }

        .course-sidebar {
            position: static;
            margin-top: 30px;
        }

        .main-content {
            padding: 25px;
        }

        .instructor-section {
            flex-direction: column;
            text-align: center;
        }

        .learning-outcomes {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
{% include 'header.html' %}

<!-- Course Hero Section -->
<section class="course-hero">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1>{{ course.title }}</h1>
                <p class="lead">{{ course.description[:200] }}{% if course.description|length > 200 %}...{% endif %}</p>
                
                <div class="course-meta-hero">
                    <div class="meta-item">
                        <i class="fas fa-tag"></i>
                        <span>{{ course.category or 'Programming' }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-users"></i>
                        <span>{{ course.enrollments|length }} students enrolled</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>Updated {{ course.updated_at.strftime('%B %Y') }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-star"></i>
                        <span>4.8 (1,234 reviews)</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="price-section">
                    <div class="d-flex align-items-center">
                        {% if course.has_public_discount %}
                            <span class="original-price">à§³{{ course.price|round|int }}</span>
                            <span class="current-price">à§³{{ course.current_price|round|int }}</span>
                        {% else %}
                            <span class="current-price">à§³{{ course.price|round|int }}</span>
                        {% endif %}
                    </div>
                    {% if course.has_public_discount %}
                        <div class="coupon-info">
                            <i class="fas fa-percentage"></i>
                            <strong>{{ course.discount_percent|round|int }}% OFF</strong> - Public Discount
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Course Content -->
<section class="course-content">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <!-- Course Description -->
                <div class="main-content">
                    <h2 class="section-title">About This Course</h2>
                    <div class="course-description">
                        {{ (course.about_course if course.about_course else course.description)|safe }}
                    </div>
                </div>

                <!-- What You'll Learn -->
                {% if course.what_youll_learn %}
                <div class="main-content">
                    <h2 class="section-title">What You'll Learn</h2>
                    <div class="course-content">
                        {{ course.what_youll_learn|safe }}
                    </div>
                </div>
                {% endif %}

                <!-- Course Requirements -->
                {% if course.course_requirements %}
                <div class="main-content">
                    <h2 class="section-title">Course Requirements</h2>
                    <div class="course-content">
                        {{ course.course_requirements|safe }}
                    </div>
                </div>
                {% endif %}


                <!-- Instructor Section -->
                <div class="main-content">
                    <h2 class="section-title">Your Instructor</h2>
                    <div class="instructor-section">
                        <img src="{% if course.instructor_image %}{% if '_' in course.instructor_image and course.instructor_image.split('_')[-1].split('.')[0].isdigit() %}https://skill-finesse-videos.b-cdn.net/courses/{{ course.instructor_image }}{% else %}{{ url_for('static', filename='uploads/' + course.instructor_image) }}{% endif %}{% else %}{{ url_for('static', filename='images/default-avatar.png') }}{% endif %}" 
                             alt="Instructor" class="instructor-avatar"
                             onerror="this.src='{{ url_for('static', filename='images/default-avatar.png') }}'; this.onerror=null;">
                        <div class="instructor-info">
                            <h4>{{ course.instructor_name or (course.admin.first_name + ' ' + course.admin.last_name) }}</h4>
                            <p class="text-muted">Professional Instructor â€¢ {{ course.admin.courses|length }} Courses</p>
                            <p>{{ course.instructor_bio or 'Experienced professional with years of industry experience and a passion for teaching.' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Course Sidebar -->
                <div class="course-sidebar">
                    <img src="{% if course|get_attr('image') %}{% if '_' in course|get_attr('image') and (course|get_attr('image')).split('_')[-1].split('.')[0].isdigit() %}https://skill-finesse-videos.b-cdn.net/courses/{{ course|get_attr('image') }}{% else %}{{ url_for('static', filename='images/' + course|get_attr_safe('image', 'default-course.jpg')) }}{% endif %}{% else %}{% if 'Python' in course|get_attr_safe('title', '') or 'Data Science' in course|get_attr_safe('title', '') or 'Machine Learning' in course|get_attr_safe('title', '') %}{{ url_for('static', filename='images/premium_course_1.png') }}{% elif 'Web Development' in course|get_attr_safe('title', '') or 'Full Stack' in course|get_attr_safe('title', '') or 'React' in course|get_attr_safe('title', '') or 'JavaScript' in course|get_attr_safe('title', '') %}{{ url_for('static', filename='images/premium_course_2.png') }}{% elif 'Mobile' in course|get_attr_safe('title', '') or 'Flutter' in course|get_attr_safe('title', '') or 'App Development' in course|get_attr_safe('title', '') %}{{ url_for('static', filename='images/premium_course_3.png') }}{% elif 'UI/UX' in course|get_attr_safe('title', '') or 'Design' in course|get_attr_safe('title', '') %}{{ url_for('static', filename='images/premium_course_4.png') }}{% elif 'Marketing' in course|get_attr_safe('title', '') or 'Digital Marketing' in course|get_attr_safe('title', '') %}{{ url_for('static', filename='images/premium_course_5.png') }}{% elif 'Blockchain' in course|get_attr_safe('title', '') or 'DevOps' in course|get_attr_safe('title', '') %}{{ url_for('static', filename='images/free_course_cover_1.png') }}{% else %}{{ url_for('static', filename='images/premium_course_1.png') }}{% endif %}{% endif %}" 
                         alt="{{ course|get_attr('title') }}" class="course-image"
                         onerror="this.src='{{ url_for('static', filename='images/premium_course_1.png') }}'; this.onerror=null;">
                    
                    {% if is_enrolled %}
                        <a href="{{ url_for('watch_course', course_id=course|get_attr('id')) }}" class="enroll-btn enrolled">
                            <i class="fas fa-play-circle me-2"></i>Watch Course
                        </a>
                    {% else %}
                        <a href="{{ url_for('course_purchase', course_id=course|get_attr('id')) }}" class="enroll-btn">
                            <i class="fas fa-shopping-cart me-2"></i>Enroll Now
                        </a>
                    {% endif %}
                    
                    <a href="#" class="preview-btn" onclick="playFirstPreviewVideo()">
                        <i class="fas fa-play me-2"></i>Preview Course
                    </a>

                    <div class="course-includes">
                        <h5 style="color: var(--secondary-color); margin-bottom: 20px;">This course includes:</h5>
                        <div class="include-item">
                            <i class="fas fa-video"></i>
                            <span>10+ hours of video content</span>
                        </div>
                        <div class="include-item">
                            <i class="fas fa-file-alt"></i>
                            <span>Downloadable resources</span>
                        </div>
                        <div class="include-item">
                            <i class="fas fa-infinity"></i>
                            <span>Lifetime access</span>
                        </div>
                        <div class="include-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Access on mobile and desktop</span>
                        </div>
                        <div class="include-item">
                            <i class="fas fa-certificate"></i>
                            <span>Certificate of completion</span>
                        </div>
                        <div class="include-item">
                            <i class="fas fa-comments"></i>
                            <span>Community support</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% include 'footer.html' %}
{% endblock %}

{% block extra_js %}
<!-- Video Preview Modal -->
<div class="modal fade" id="coursePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalTitle">Course Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="video-container" style="background: #000; border-radius: 8px; overflow: hidden;">
                    <video id="coursePreviewPlayer" controls style="width: 100%; height: 500px; object-fit: contain;">
                        <p>Your browser doesn't support HTML5 video.</p>
                    </video>
                </div>
                <div class="mt-3">
                    <h6 id="previewVideoTitle"></h6>
                    <p id="previewVideoDescription" class="text-muted"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('user_enroll', course_id=course.id) }}" class="btn btn-primary">
                    <i class="fas fa-credit-card me-2"></i>Enroll Now - ${{ course.price }}
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Course details page loaded');
});

// Play first available preview video when Preview Course button is clicked
function playFirstPreviewVideo() {
    const courseId = {{ course.id }};
    
    fetch(`/api/course/${courseId}/preview-videos`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.videos.length > 0) {
                const firstVideo = data.videos[0];
                playPreviewVideo(firstVideo.video_url, firstVideo.title, firstVideo.description || '');
            } else {
                alert('No preview videos available for this course.');
            }
        })
        .catch(error => {
            console.error('Error loading preview videos:', error);
            alert('Unable to load preview video at this time.');
        });
}


// Play preview video
function playPreviewVideo(videoUrl, title, description) {
    console.log('ðŸ”¥ Preview video called with URL:', videoUrl, 'Title:', title);
    
    if (!videoUrl || videoUrl === '') {
        alert('Video URL is not available');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('coursePreviewModal'));
    const player = document.getElementById('coursePreviewPlayer');
    const modalTitle = document.getElementById('previewModalTitle');
    const videoTitle = document.getElementById('previewVideoTitle');
    const videoDescription = document.getElementById('previewVideoDescription');
    
    if (!player) {
        alert('Video player not found');
        return;
    }
    
    modalTitle.textContent = 'Course Preview';
    videoTitle.textContent = title;
    videoDescription.textContent = description;
    
    // Clear existing content and event listeners
    player.pause();
    player.src = '';
    player.load();
    
    // Remove crossOrigin for Bunny.net CDN as it might cause issues
    player.removeAttribute('crossorigin');
    
    // Check if this is a Bunny.net URL and handle accordingly
    const isBunnyUrl = videoUrl.includes('b-cdn.net') || videoUrl.includes('bunnycdn.com');
    
    if (isBunnyUrl) {
        console.log('Detected Bunny.net URL, applying specific handling');
        
        // For Bunny.net, try different approaches
        const testBunnyAccess = async () => {
            try {
                console.log('Testing Bunny.net URL accessibility...');
                
                // Test with a simple fetch to check if URL is accessible
                const response = await fetch(videoUrl, { 
                    method: 'HEAD',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('Bunny.net URL is accessible');
                    
                    // Set the source directly
                    player.src = videoUrl;
                    player.load();
                } else {
                    console.error('Bunny.net URL returned status:', response.status);
                    
                    // Try alternative method with source element
                    tryAlternativeLoading();
                }
            } catch (error) {
                console.error('Bunny.net URL test failed:', error);
                
                // Try alternative method
                tryAlternativeLoading();
            }
        };
        
        const tryAlternativeLoading = () => {
            // Method 2: Use source element with explicit MIME type
            player.innerHTML = '';
            
            const source = document.createElement('source');
            source.src = videoUrl;
            source.type = 'video/mp4';
            
            const fallback = document.createElement('p');
            fallback.textContent = 'Your browser doesn\'t support HTML5 video.';
            
            player.appendChild(source);
            player.appendChild(fallback);
            
            player.load();
            console.log('Using source element method...');
        };
        
        // Start with testing Bunny.net access
        testBunnyAccess();
        
    } else {
        // For non-Bunny URLs, use standard method
        console.log('Non-Bunny URL, using standard method');
        player.src = videoUrl;
        player.load();
    }
    
    // Enhanced event handlers
    const handleLoadStart = () => {
        console.log('Preview video load started');
    };
    
    const handleLoadedMetadata = () => {
        console.log('Preview video metadata loaded');
        // Cancel any pending error message since video is loading successfully
        if (showErrorAfterDelay) {
            clearTimeout(showErrorAfterDelay);
            showErrorAfterDelay = null;
        }
    };
    
    const handleCanPlay = () => {
        console.log('Preview video can play');
        // Cancel any pending error message since video is working
        if (showErrorAfterDelay) {
            clearTimeout(showErrorAfterDelay);
            showErrorAfterDelay = null;
        }
    };
    
    let errorAttempts = 0;
    const maxAttempts = 2;
    let showErrorAfterDelay = null;
    
    const handleError = (e) => {
        errorAttempts++;
        console.error(`Preview video loading error (attempt ${errorAttempts}):`, e);
        console.error('Error details:', {
            error: player.error,
            errorCode: player.error ? player.error.code : 'unknown',
            networkState: player.networkState,
            readyState: player.readyState,
            src: player.src
        });
        
        const errorMessage = player.error ? 
            `Error ${player.error.code}: ${getVideoErrorMessage(player.error.code)}` : 
            'Unknown video error';
        
        // If it's a Bunny.net URL and we haven't tried all methods yet
        if (isBunnyUrl && errorAttempts < maxAttempts) {
            console.log(`Bunny.net error on attempt ${errorAttempts}, trying fallback method...`);
            
            if (errorAttempts === 1) {
                // First error - try alternative loading with source element without showing error
                player.innerHTML = '';
                
                const source = document.createElement('source');
                source.src = videoUrl;
                source.type = 'video/mp4';
                
                const fallback = document.createElement('p');
                fallback.textContent = 'Your browser doesn\'t support HTML5 video.';
                
                player.appendChild(source);
                player.appendChild(fallback);
                
                player.load();
            } else {
                // Second error - delay showing error to allow final retry
                showErrorAfterDelay = setTimeout(() => {
                    if (player.readyState === 0 || player.error) { // Still no data loaded or still has error
                        alert(`Error loading preview video: ${errorMessage}`);
                    }
                }, 2000); // Wait 2 seconds before showing final error
            }
        } else {
            // Non-Bunny URL error or exceeded attempts for Bunny - show error only after delay for final attempt
            if (errorAttempts >= maxAttempts) {
                showErrorAfterDelay = setTimeout(() => {
                    if (player.readyState === 0 || player.error) {
                        alert(`Error loading preview video: ${errorMessage}`);
                    }
                }, 1000);
            } else {
                // First error on non-Bunny URL - show immediately
                alert(`Error loading preview video: ${errorMessage}`);
            }
            console.log('Preview video loading failed with all methods');
        }
    };
    
    // Add event listeners
    player.addEventListener('loadstart', handleLoadStart);
    player.addEventListener('loadedmetadata', handleLoadedMetadata);
    player.addEventListener('canplay', handleCanPlay);
    player.addEventListener('error', handleError);
    
    // Show modal
    modal.show();
    
    // Clean up when modal closes
    const modalElement = document.getElementById('coursePreviewModal');
    modalElement.addEventListener('hidden.bs.modal', function () {
        player.pause();
        player.currentTime = 0;
        player.removeEventListener('loadstart', handleLoadStart);
        player.removeEventListener('loadedmetadata', handleLoadedMetadata);
        player.removeEventListener('canplay', handleCanPlay);
        player.removeEventListener('error', handleError);
        
        // Cancel any pending error message
        if (showErrorAfterDelay) {
            clearTimeout(showErrorAfterDelay);
            showErrorAfterDelay = null;
        }
    });
}

// Helper function to get human-readable error messages
function getVideoErrorMessage(errorCode) {
    const errorMessages = {
        1: 'Video loading aborted',
        2: 'Network error while loading video',
        3: 'Video decoding error',
        4: 'Video format not supported'
    };
    return errorMessages[errorCode] || 'Unknown error';
}

// Format duration helper
function formatDuration(seconds) {
    if (!seconds) return 'Unknown';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}
</script>
{% endblock %}