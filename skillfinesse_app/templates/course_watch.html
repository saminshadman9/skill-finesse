{% extends 'base.html' %}

{% block title %}{{ course.title }} - Course Videos - Skill Finesse{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/global-header-footer.css') }}" rel="stylesheet">
<style>
    :root {
        --primary-color: #00a651;
        --secondary-color: #333333;
        --border-color: #e5e7eb;
        --bg-light: #f0f4f8;
        --sidebar-bg: #ffffff;
        --card-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 30px 80px rgba(0, 0, 0, 0.12);
        --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #00a651 100%);
        --gradient-primary: linear-gradient(135deg, #00a651 0%, #00d068 100%);
        --gradient-secondary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --cute-pink: #ff6b9d;
        --cute-purple: #a78bfa;
        --cute-blue: #60a5fa;
        --cute-green: #34d399;
    }

    * {
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 50%, #f8fafc 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 0;
        overflow-x: hidden;
        position: relative;
        padding-top: 80px; /* Account for header */
    }

    /* Ensure header stays sticky */
    .navbar.sticky-top {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 1050 !important;
        width: 100% !important;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 15% 15%, rgba(102, 126, 234, 0.05) 0%, transparent 40%),
            radial-gradient(circle at 85% 85%, rgba(0, 166, 81, 0.05) 0%, transparent 40%),
            radial-gradient(circle at 50% 50%, rgba(255, 107, 157, 0.03) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
    }

    .course-player-container {
        display: flex;
        min-height: calc(100vh - 80px); /* Subtract header height */
        background: transparent;
        position: relative;
    }

    /* Cute & Modern Sidebar */
    .course-sidebar {
        width: 420px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 0 0 1px rgba(255, 255, 255, 0.3);
        overflow-y: auto;
        height: calc(100vh - 80px);
        position: fixed;
        left: 0;
        top: 80px; /* Below header */
        z-index: 1000;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        border-right: 1px solid rgba(102, 126, 234, 0.1);
        backdrop-filter: blur(20px);
    }

    .course-header {
        padding: 32px 24px;
        background: var(--accent-gradient);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        position: relative;
        overflow: hidden;
    }

    .course-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 0%, transparent 50%),
            radial-gradient(circle at 75% 75%, rgba(255,255,255,0.05) 0%, transparent 50%);
    }

    .course-header::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: 
            conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
        animation: rotate 12s linear infinite;
        opacity: 0.7;
    }

    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .course-title {
        font-size: 1.35rem;
        font-weight: 800;
        margin: 0 0 20px 0;
        line-height: 1.4;
        letter-spacing: -0.025em;
        position: relative;
        z-index: 3;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, white 0%, rgba(255,255,255,0.9) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .course-progress-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        z-index: 3;
    }

    .progress-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        opacity: 0.95;
        font-weight: 600;
    }

    .progress-percentage {
        font-weight: 800;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 4px 12px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .progress-bar-container {
        background: rgba(255,255,255,0.25);
        height: 12px;
        border-radius: 20px;
        overflow: hidden;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
    }

    .progress-bar-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .progress-bar {
        background: linear-gradient(90deg, rgba(255,255,255,0.9) 0%, white 50%, rgba(255,255,255,0.9) 100%);
        height: 100%;
        border-radius: 20px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 
            0 2px 8px rgba(255, 255, 255, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        animation: progressShine 3s infinite;
    }

    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Cute Video List */
    .video-list {
        padding: 20px 0;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.3) 0%, rgba(248, 250, 252, 0.2) 100%);
        border-radius: 25px 25px 0 0;
        margin-top: 10px;
    }

    .video-section {
        margin-bottom: 28px;
    }

    .section-header {
        padding: 0 24px 16px;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-header::before {
        content: 'üéØ';
        font-size: 1.2rem;
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-8px); }
        60% { transform: translateY(-4px); }
    }

    .video-item {
        margin: 0 16px 12px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        background: linear-gradient(145deg, white 0%, rgba(248, 250, 252, 0.8) 100%);
        border: 2px solid transparent;
        overflow: hidden;
    }

    .video-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.1) 0%, 
            rgba(255, 107, 157, 0.1) 50%, 
            rgba(52, 211, 153, 0.1) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .video-item:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 
            0 20px 40px rgba(102, 126, 234, 0.15),
            0 10px 20px rgba(0, 0, 0, 0.1);
        border-color: var(--cute-purple);
    }

    .video-item:hover::before {
        opacity: 1;
    }

    .video-item.active {
        background: linear-gradient(135deg, 
            rgba(0, 166, 81, 0.15) 0%, 
            rgba(0, 208, 104, 0.1) 100%);
        border-color: var(--primary-color);
        box-shadow: 
            0 15px 30px rgba(0, 166, 81, 0.2),
            0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .video-item.completed {
        background: linear-gradient(135deg, 
            rgba(52, 211, 153, 0.15) 0%, 
            rgba(34, 197, 94, 0.1) 100%);
        border-color: var(--cute-green);
    }

    .video-item.completed::after {
        content: '‚ú®';
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        animation: sparkle 2s infinite;
    }

    @keyframes sparkle {
        0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
        50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
    }

    .video-item-content {
        padding: 20px;
        display: flex;
        align-items: flex-start;
        gap: 18px;
        position: relative;
        z-index: 2;
    }

    .video-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, var(--cute-blue) 0%, var(--cute-purple) 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: white;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        position: relative;
        box-shadow: 
            0 8px 16px rgba(96, 165, 250, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .video-icon::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 50%);
        border-radius: 16px;
        pointer-events: none;
    }

    .video-item.completed .video-icon {
        background: linear-gradient(135deg, var(--cute-green) 0%, #4ade80 100%);
        box-shadow: 
            0 8px 20px rgba(52, 211, 153, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        animation: completedPulse 2s infinite;
    }

    @keyframes completedPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .video-item.active .video-icon {
        background: linear-gradient(135deg, var(--primary-color) 0%, #00d068 100%);
        box-shadow: 
            0 8px 20px rgba(0, 166, 81, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .video-item:hover .video-icon {
        transform: scale(1.15) rotate(5deg);
        box-shadow: 
            0 12px 24px rgba(96, 165, 250, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    .video-info {
        flex: 1;
        min-width: 0;
    }

    .video-title {
        font-weight: 600;
        margin: 0 0 8px 0;
        font-size: 0.9375rem;
        line-height: 1.4;
        color: var(--text-primary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .video-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.8125rem;
        color: var(--text-muted);
        margin: 0 0 8px 0;
    }

    .duration-badge {
        background: rgba(0, 166, 81, 0.1);
        color: var(--primary-color);
        padding: 2px 8px;
        border-radius: 6px;
        font-weight: 500;
    }

    .preview-badge {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        padding: 2px 8px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.75rem;
    }

    .video-progress {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
    }

    .video-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color) 0%, #00d068 100%);
        border-radius: 9999px;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Enhanced Main Content Area */
    .main-content {
        margin-left: 420px;
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-light);
        transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Cute Video Player Section */
    .video-player-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        position: relative;
        aspect-ratio: 16/9;
        max-height: 75vh;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 25px;
        overflow: hidden;
        box-shadow: 
            0 25px 50px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        margin: 20px;
        border: 3px solid transparent;
        background-clip: padding-box;
    }

    .video-player-section::before {
        content: '';
        position: absolute;
        top: -3px;
        left: -3px;
        right: -3px;
        bottom: -3px;
        background: var(--accent-gradient);
        border-radius: 28px;
        z-index: -1;
    }

    .video-player-section::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 40%),
            radial-gradient(circle at 80% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 40%),
            radial-gradient(circle at 50% 10%, rgba(52, 211, 153, 0.1) 0%, transparent 30%);
        pointer-events: none;
    }

    #videoPlayer {
        width: 100%;
        height: 100%;
        object-fit: contain;
        outline: none;
        border-radius: 0;
        transition: all 0.3s ease;
    }

    /* Enhanced video controls */
    #videoPlayer::-webkit-media-controls-panel {
        background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.8) 100%);
    }

    #videoPlayer::-webkit-media-controls-play-button,
    #videoPlayer::-webkit-media-controls-pause-button {
        background-color: var(--primary-color);
        border-radius: 50%;
    }

    .video-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: white;
        text-align: center;
        gap: 24px;
        position: relative;
        z-index: 2;
    }

    .placeholder-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, var(--primary-color) 0%, #00d068 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: white;
        position: relative;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 
            0 8px 32px rgba(0, 166, 81, 0.3),
            0 0 0 0 rgba(0, 166, 81, 0.4);
        animation: playButtonPulse 2s infinite;
    }

    .placeholder-icon:hover {
        transform: scale(1.1);
        box-shadow: 
            0 12px 40px rgba(0, 166, 81, 0.4),
            0 0 0 20px rgba(0, 166, 81, 0.1);
    }

    .placeholder-icon::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-40%, -50%);
        width: 0;
        height: 0;
        border-left: 20px solid white;
        border-top: 12px solid transparent;
        border-bottom: 12px solid transparent;
    }

    .placeholder-icon::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
        animation: ripple 2s infinite;
    }

    @keyframes playButtonPulse {
        0%, 100% { 
            transform: scale(1);
            box-shadow: 
                0 8px 32px rgba(0, 166, 81, 0.3),
                0 0 0 0 rgba(0, 166, 81, 0.4);
        }
        50% { 
            transform: scale(1.02);
            box-shadow: 
                0 12px 40px rgba(0, 166, 81, 0.4),
                0 0 0 10px rgba(0, 166, 81, 0.1);
        }
    }

    @keyframes ripple {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.3);
            opacity: 0;
        }
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeInScale {
        from {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
        }
        to {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
    }

    #nextVideoNotification {
        animation: fadeInScale 0.5s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    #nextVideoNotification button:hover {
        transform: scale(1.05) !important;
    }

    @keyframes placeholderFloat {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-10px) scale(1.05); }
    }

    @keyframes iconBounce {
        0%, 100% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.2) rotate(10deg); }
    }

    .video-placeholder h3 {
        font-size: 2rem;
        font-weight: 800;
        margin: 0 0 10px 0;
        background: linear-gradient(135deg, white 0%, rgba(255,255,255,0.8) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .video-placeholder p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin: 0;
        font-weight: 500;
    }

    /* Cute Video Info Section */
    .video-info-section {
        background: linear-gradient(145deg, white 0%, rgba(248, 250, 252, 0.8) 100%);
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        margin: 0 20px;
        border-radius: 25px 25px 0 0;
        overflow: hidden;
        position: relative;
    }

    .video-info-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--accent-gradient);
    }

    .video-header {
        padding: 40px;
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        position: relative;
    }

    .video-header::after {
        content: 'üéì';
        position: absolute;
        top: 20px;
        right: 40px;
        font-size: 2.5rem;
        animation: educationFloat 4s ease-in-out infinite;
    }

    @keyframes educationFloat {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-8px) rotate(5deg); }
    }

    .current-video-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0 0 16px 0;
        line-height: 1.3;
        letter-spacing: -0.025em;
        background: linear-gradient(135deg, #1a202c 0%, #4a5568 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }

    .current-video-title::before {
        content: '‚ñ∂Ô∏è';
        margin-right: 15px;
        font-size: 1.8rem;
        animation: playIcon 2s infinite;
    }

    @keyframes playIcon {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .current-video-meta {
        display: flex;
        align-items: center;
        gap: 24px;
        color: var(--text-secondary);
        font-size: 0.9375rem;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .meta-item i {
        color: var(--primary-color);
    }

    /* Cute Modern Tabs */
    .video-tabs {
        background: linear-gradient(145deg, white 0%, rgba(248, 250, 252, 0.8) 100%);
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        padding: 0 40px;
        margin: 0 20px;
        position: relative;
    }

    .tab-nav {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        gap: 40px;
    }

    .tab-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 20px 24px;
        color: var(--text-secondary);
        text-decoration: none;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border-radius: 15px 15px 0 0;
        background: transparent;
    }

    .tab-nav a::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.1) 0%, 
            rgba(255, 107, 157, 0.1) 50%, 
            rgba(52, 211, 153, 0.1) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: 15px 15px 0 0;
    }

    .tab-nav a:hover::before {
        opacity: 1;
    }

    .tab-nav a.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(0, 166, 81, 0.1) 0%, rgba(0, 208, 104, 0.05) 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 166, 81, 0.15);
    }

    .tab-nav a:hover:not(.active) {
        color: var(--text-primary);
        transform: translateY(-2px);
        background: rgba(102, 126, 234, 0.05);
    }

    .tab-nav a i {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .tab-nav a:hover i {
        transform: scale(1.2) rotate(5deg);
    }

    .tab-nav a.active i {
        animation: tabIconSpin 2s infinite;
    }

    @keyframes tabIconSpin {
        0%, 100% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.1) rotate(10deg); }
    }

    /* Cute Tab Content */
    .tab-content {
        padding: 40px;
        background: linear-gradient(145deg, white 0%, rgba(248, 250, 252, 0.6) 100%);
        min-height: 400px;
        margin: 0 20px;
        border-radius: 0 0 25px 25px;
        position: relative;
        overflow: hidden;
    }

    .tab-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 10% 10%, rgba(102, 126, 234, 0.03) 0%, transparent 30%),
            radial-gradient(circle at 90% 90%, rgba(255, 107, 157, 0.03) 0%, transparent 30%);
        pointer-events: none;
    }

    .tab-pane {
        display: none;
        animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 2;
    }

    .tab-pane.active {
        display: block;
    }

    @keyframes fadeInUp {
        from { 
            opacity: 0; 
            transform: translateY(20px) scale(0.95); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
        }
    }

    .content-section h4 {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0 0 24px 0;
        display: flex;
        align-items: center;
        gap: 15px;
        background: linear-gradient(135deg, #1a202c 0%, #4a5568 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .content-section h4 i {
        color: var(--primary-color);
        background: linear-gradient(135deg, var(--cute-blue) 0%, var(--cute-purple) 100%);
        padding: 12px;
        border-radius: 15px;
        color: white;
        font-size: 1.2rem;
        animation: contentIconFloat 3s ease-in-out infinite;
    }

    @keyframes contentIconFloat {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-5px) rotate(5deg); }
    }

    .content-section h4 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .content-section h4 i {
        color: var(--primary-color);
    }

    /* Cute Resources/Attachments */
    .attachments-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 20px;
    }

    .attachment-item {
        display: flex;
        align-items: center;
        padding: 24px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.7) 100%);
        border-radius: 20px;
        border: 2px solid transparent;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .attachment-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.1) 0%, 
            rgba(255, 107, 157, 0.1) 50%, 
            rgba(52, 211, 153, 0.1) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .attachment-item:hover {
        box-shadow: 
            0 20px 40px rgba(102, 126, 234, 0.15),
            0 10px 20px rgba(0, 0, 0, 0.1);
        border-color: var(--cute-purple);
        transform: translateY(-4px) scale(1.02);
    }

    .attachment-item:hover::before {
        opacity: 1;
    }

    .attachment-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--cute-blue) 0%, var(--cute-purple) 100%);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 24px;
        color: white;
        font-size: 1.8rem;
        box-shadow: 
            0 8px 20px rgba(96, 165, 250, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 2;
        transition: all 0.4s ease;
    }

    .attachment-icon::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 50%);
        border-radius: 14px;
        pointer-events: none;
    }

    .attachment-item:hover .attachment-icon {
        transform: scale(1.1) rotate(5deg);
    }

    .attachment-info {
        flex: 1;
    }

    .attachment-name {
        font-weight: 600;
        margin: 0 0 4px 0;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .attachment-size {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0;
    }

    .btn-download {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-download:hover {
        background: #008c44;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 166, 81, 0.3);
    }

    /* External Links */
    .external-link-item {
        display: flex;
        align-items: center;
        padding: 24px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.7) 100%);
        border-radius: 20px;
        border: 2px solid transparent;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .external-link-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.1) 0%, 
            rgba(255, 107, 157, 0.1) 50%, 
            rgba(52, 211, 153, 0.1) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .external-link-item:hover {
        box-shadow: 
            0 20px 40px rgba(102, 126, 234, 0.15),
            0 10px 20px rgba(0, 0, 0, 0.1);
        border-color: var(--cute-purple);
        transform: translateY(-4px) scale(1.02);
    }

    .external-link-item:hover::before {
        opacity: 1;
    }

    .external-link-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 24px;
        color: white;
        font-size: 1.8rem;
        box-shadow: 
            0 8px 20px rgba(96, 165, 250, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 2;
        transition: all 0.4s ease;
    }

    .external-link-icon::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 50%);
        border-radius: 14px;
        pointer-events: none;
    }

    .external-link-item:hover .external-link-icon {
        transform: scale(1.1) rotate(5deg);
    }

    .external-link-info {
        flex: 1;
    }

    .external-link-title {
        font-weight: 600;
        margin: 0 0 4px 0;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .external-link-url {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0;
        word-break: break-all;
    }

    .btn-external-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn-external-link:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        color: white;
        text-decoration: none;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state h5 {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: var(--text-secondary);
    }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 1200px) {
        .course-sidebar {
            width: 380px;
        }
        
        .main-content {
            margin-left: 380px;
        }
    }

    @media (max-width: 1024px) {
        .course-sidebar {
            width: 350px;
        }
        
        .main-content {
            margin-left: 350px;
        }
        
        .video-player-section {
            max-height: 65vh;
        }
    }

    @media (max-width: 768px) {
        .course-sidebar {
            width: 100vw;
            transform: translateX(-100%);
            box-shadow: none;
            border-right: none;
        }

        .course-sidebar.open {
            transform: translateX(0);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            margin-left: 0;
        }

        .mobile-header {
            display: flex;
            align-items: center;
            background: var(--accent-gradient);
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .mobile-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .video-header {
            padding: 20px;
        }

        .current-video-title {
            font-size: 1.5rem;
        }

        .tab-content, .video-tabs {
            padding: 20px;
        }

        .tab-nav {
            gap: 20px;
            flex-wrap: wrap;
        }

        .video-player-section {
            max-height: 60vh;
        }
    }

    @media (max-width: 480px) {
        .course-header {
            padding: 20px;
        }
        
        .course-title {
            font-size: 1.1rem;
        }
        
        .video-header {
            padding: 15px;
        }
        
        .current-video-title {
            font-size: 1.3rem;
        }
        
        .tab-content, .video-tabs {
            padding: 15px;
        }
        
        .video-player-section {
            max-height: 50vh;
        }
        
        .video-item-content {
            padding: 12px;
        }
        
        .video-icon {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }
    }

    @media (min-width: 769px) {
        .mobile-header {
            display: none;
        }
    }

    /* Enhanced Loading States */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* High Security Video Protection */
    .security-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 10;
        background: transparent;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    #videoPlayer {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* Disable right-click completely on video area */
    .video-player-section {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* Hide browser download options */
    #videoPlayer::-webkit-media-controls-download-button {
        display: none !important;
    }

    #videoPlayer::-webkit-media-controls-fullscreen-button {
        display: none !important;
    }

    #videoPlayer::-webkit-media-controls-picture-in-picture-button {
        display: none !important;
    }

    /* Security warning modal */
    .security-warning-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .security-warning-content {
        background: linear-gradient(145deg, #ff4757 0%, #ff3742 100%);
        padding: 40px;
        border-radius: 25px;
        text-align: center;
        color: white;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(255, 71, 87, 0.4);
        animation: warningPulse 1s infinite;
    }

    @keyframes warningPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .security-warning-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: shake 0.5s infinite;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Modern video player enhancements */
    .video-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: opacity 0.3s ease;
    }

    .video-loading-spinner {
        width: 60px;
        height: 60px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Enhanced video controls styling */
    .custom-video-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        padding: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .video-player-section:hover .custom-video-controls {
        opacity: 1;
    }

    /* Enhanced sidebar scroll */
    .course-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .course-sidebar::-webkit-scrollbar-track {
        background: rgba(0, 166, 81, 0.1);
    }

    .course-sidebar::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
    }

    .course-sidebar::-webkit-scrollbar-thumb:hover {
        background: #008c44;
    }

    /* Anti-download protection */
    video {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    video::-webkit-media-controls-download-button {
        display: none;
    }

    /* Warning Modal */
    .download-warning {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
        backdrop-filter: blur(4px);
    }

    .warning-content {
        text-align: center;
        max-width: 480px;
        padding: 48px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .warning-icon {
        font-size: 4rem;
        color: #ef4444;
        margin-bottom: 24px;
    }

    .warning-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 16px;
    }

    .warning-text {
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 32px;
        opacity: 0.9;
    }

    .btn-warning-close {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .btn-warning-close:hover {
        background: #008c44;
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
{% include 'header.html' %}
<div class="course-player-container">
    <!-- Modern Sidebar -->
    <div class="course-sidebar" id="courseSidebar">
        <div class="course-header">
            <h3 class="course-title">{{ course.title }}</h3>
            <div class="course-progress-section">
                <div class="progress-stats">
                    <span class="progress-percentage"><span id="overallProgress">0</span>% Complete</span>
                    <span><span id="completedVideos">0</span> / <span id="totalVideos">{{ videos|length }}</span> lessons</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="overallProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="video-list">
            <div class="video-section">
                <div class="section-header">Course Content</div>
                {% for video in videos %}
                <div class="video-item" data-video-id="{{ video.id }}" 
                     onclick="loadVideoFromData({{ video.id }})">
                    <div class="video-item-content">
                        <div class="video-icon">
                            {% set progress = user_progress.get(video.id) %}
                            {% if progress and progress.is_completed %}
                                <i class="fas fa-check"></i>
                            {% else %}
                                <i class="fas fa-play"></i>
                            {% endif %}
                        </div>
                        <div class="video-info">
                            <h6 class="video-title">{{ loop.index }}. {{ video.title }}</h6>
                            <div class="video-meta">
                                {% if video.duration %}
                                    <span class="duration-badge">{{ (video.duration // 60)|int }}:{{ (video.duration % 60)|int|string|rjust(2, '0') }}</span>
                                {% else %}
                                    <span class="duration-badge">--:--</span>
                                {% endif %}
                                {% if video.is_preview %}
                                    <span class="preview-badge">Preview</span>
                                {% endif %}
                            </div>
                            {% if progress %}
                            <div class="video-progress">
                                <div class="video-progress-bar" style="width: {{ progress.completion_percentage }}%"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="mobile-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <span>{{ course.title }}</span>
        </div>

        <!-- Video Player -->
        <div class="video-player-section" id="videoPlayerSection">
            <div class="video-placeholder" id="videoPlaceholder">
                <div class="placeholder-icon"></div>
                <h3>Ready to Start Learning?</h3>
                <p>Select a video from the course content to begin</p>
            </div>
            <video id="videoPlayer" 
                   controls 
                   preload="metadata" 
                   oncontextmenu="return false;" 
                   controlslist="nodownload nofullscreen noremoteplayback"
                   disablepictureinpicture
                   disableremoteplayback
                   crossorigin="anonymous"
                   style="display: none; pointer-events: auto;"
                   data-protected="true">
                <p>Your browser doesn't support HTML5 video.</p>
            </video>
            
            <!-- Security Overlay -->
            <div class="security-overlay" id="securityOverlay"></div>
        </div>

        <!-- Video Info -->
        <div class="video-info-section">
            <div class="video-header">
                <h2 class="current-video-title" id="currentVideoTitle">Welcome to {{ course.title }}</h2>
                <div class="current-video-meta" id="currentVideoMeta">
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span id="videoDuration">Select a video to see duration</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-user"></i>
                        <span>{{ course.instructor_name or 'Instructor' }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-users"></i>
                        <span>{{ course.enrollments|length }} students</span>
                    </div>
                </div>
            </div>
            
            <!-- Modern Tabs -->
            <nav class="video-tabs">
                <ul class="tab-nav">
                    <li><a href="#" class="tab-link active" data-tab="overview">
                        <i class="fas fa-info-circle"></i>
                        Overview
                    </a></li>
                    <li><a href="#" class="tab-link" data-tab="instructions">
                        <i class="fas fa-list-ul"></i>
                        Instructions
                    </a></li>
                    <li><a href="#" class="tab-link" data-tab="attachments">
                        <i class="fas fa-paperclip"></i>
                        Resources
                    </a></li>
                </ul>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <div class="tab-pane active" id="tab-overview">
                <div class="content-section">
                    <h4><i class="fas fa-bookmark"></i>About this lesson</h4>
                    <div id="videoDescription">
                        <p>Welcome to {{ course.title }}! Select a video from the course content to start learning. You'll find detailed descriptions, instructions, and downloadable resources for each lesson.</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="tab-instructions">
                <div class="content-section">
                    <h4><i class="fas fa-tasks"></i>Step-by-step Instructions</h4>
                    <div id="videoInstructions">
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h5>No instructions available</h5>
                            <p>Instructions will appear here when you select a video</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="tab-attachments">
                <div class="content-section">
                    <h4><i class="fas fa-download"></i>Downloadable Resources</h4>
                    <ul class="attachments-list" id="attachmentsList">
                        <li class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h5>No resources available</h5>
                            <p>Resources will appear here when you select a video</p>
                        </li>
                    </ul>
                </div>
                
                <div class="content-section" id="externalLinksSection" style="display: none;">
                    <h4><i class="fas fa-external-link-alt"></i>External Links</h4>
                    <div id="externalLinksContainer">
                        <div class="empty-state">
                            <i class="fas fa-link"></i>
                            <h5>No external links available</h5>
                            <p>External links will appear here when available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Warning Modal -->
<div class="security-warning-modal" id="securityWarningModal">
    <div class="security-warning-content">
        <div class="security-warning-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h3>‚ö†Ô∏è SECURITY ALERT ‚ö†Ô∏è</h3>
        <p><strong>Unauthorized download attempt detected!</strong></p>
        <p>Video content is protected by DRM technology. Any attempt to download, record, or distribute this content is strictly prohibited and illegal.</p>
        <p>Your activity is being monitored and logged.</p>
        <button onclick="closeSecurityWarning()" style="background: white; color: #ff4757; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; margin-top: 20px; cursor: pointer;">I Understand</button>
    </div>
</div>

<!-- Download Warning Modal (Legacy) -->
<div class="download-warning" id="downloadWarning">
    <div class="warning-content">
        <div class="warning-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="warning-title">Download Attempt Detected!</h3>
        <p class="warning-text">
            Attempting to download course videos is strictly prohibited and may result in account suspension. 
            All content is protected and monitored for your security.
        </p>
        <button class="btn-warning-close" onclick="closeDownloadWarning()">I Understand</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store video data safely as JSON to avoid JavaScript string escaping issues
const videoData = {
    {% for video in videos %}
    {{ video.id }}: {
        id: {{ video.id }},
        title: {{ video.title|tojson }},
        description: {{ video.description|tojson }},
        videoUrl: {{ video.video_url|tojson }},
        isPreview: {{ video.is_preview|lower }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Safe function to load video from stored JSON data
function loadVideoFromData(videoId) {
    const video = videoData[videoId];
    if (video) {
        loadVideo(video.id, video.videoUrl, video.title, video.description, video.isPreview);
    } else {
        console.error('Video data not found for ID:', videoId);
    }
}
</script>
<script>
// Global variables
let currentVideoId = null;
let videoPlayer = document.getElementById('videoPlayer');
let videoPlaceholder = document.getElementById('videoPlaceholder');
let progressUpdateInterval = null;
let isUserEnrolled = true;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setupVideoPlayer();
    setupTabs();
    setupProtection();
    updateOverallProgress();
    
    // Update video count
    document.getElementById('totalVideos').textContent = {{ videos|length }};
    
    // Load last watched video
    loadLastWatchedVideo();
});

// Load and highlight last watched video
function loadLastWatchedVideo() {
    // Find the last watched video from localStorage
    let lastVideoId = null;
    let lastTimestamp = 0;
    
    // Check all stored video progress
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('video_progress_')) {
            try {
                const progress = JSON.parse(localStorage.getItem(key));
                if (progress.timestamp > lastTimestamp) {
                    lastTimestamp = progress.timestamp;
                    lastVideoId = progress.videoId;
                }
            } catch (e) {
                // Invalid stored data, skip
            }
        }
    }
    
    // Highlight the last watched video
    if (lastVideoId) {
        const lastVideoElement = document.querySelector(`[data-video-id="${lastVideoId}"]`);
        if (lastVideoElement) {
            // Add special highlighting for last watched video
            lastVideoElement.style.border = '2px solid var(--primary-color)';
            lastVideoElement.style.background = 'rgba(0, 166, 81, 0.05)';
            
            // Add a "Continue" badge
            if (!lastVideoElement.querySelector('.continue-badge')) {
                const badge = document.createElement('span');
                badge.className = 'continue-badge';
                badge.innerHTML = '<i class="fas fa-play-circle"></i> Continue';
                badge.style.cssText = `
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: var(--primary-color);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.7rem;
                    font-weight: 600;
                    z-index: 10;
                `;
                lastVideoElement.style.position = 'relative';
                lastVideoElement.appendChild(badge);
            }
            
            // Scroll into view
            setTimeout(() => {
                lastVideoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }
    }
}

// Setup video player event listeners
function setupVideoPlayer() {
    videoPlayer.addEventListener('timeupdate', updateProgress);
    videoPlayer.addEventListener('ended', markVideoCompleted);
    videoPlayer.addEventListener('loadedmetadata', onVideoLoaded);
    videoPlayer.addEventListener('error', onVideoError);
    
    // Prevent right-click on video
    videoPlayer.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showDownloadWarning();
        return false;
    });
    
    // Prevent keyboard shortcuts for downloading
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
            e.preventDefault();
            showDownloadWarning();
        }
    });
}

// Setup tab switching
function setupTabs() {
    document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all tabs and panes
            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Show corresponding pane
            const tabId = this.getAttribute('data-tab');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        });
    });
}

// Enhanced Security Protection System
function setupProtection() {
    // Strategic keyboard shortcut protection
    document.addEventListener('keydown', function(e) {
        // Only block the most dangerous shortcuts
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') ||
            (e.ctrlKey && e.shiftKey && e.key === 'J')) {
            e.preventDefault();
            e.stopPropagation();
            showSecurityWarning();
            return false;
        }
        
        // Block download/save shortcuts only in video context
        if (e.target.closest('.video-player-section')) {
            if ((e.ctrlKey && e.key === 's') ||
                (e.ctrlKey && e.key === 'S') ||
                (e.ctrlKey && e.key === 'p') ||
                (e.ctrlKey && e.key === 'P')) {
                e.preventDefault();
                showSecurityWarning();
                return false;
            }
        }
        
        // Log other suspicious shortcuts but don't block
        if ((e.ctrlKey && e.key === 'U') ||
            (e.ctrlKey && e.shiftKey && e.key === 'C')) {
            logSecurityEvent('suspicious_keyboard_shortcut');
        }
    });
    
    // Right-click protection with enhanced detection
    document.addEventListener('contextmenu', function(e) {
        if (e.target.tagName === 'VIDEO' || e.target.closest('.video-player-section') || e.target.closest('.course-sidebar')) {
            e.preventDefault();
            e.stopPropagation();
            showSecurityWarning();
            return false;
        }
    });
    
    // Disable text selection on video area
    document.addEventListener('selectstart', function(e) {
        if (e.target.closest('.video-player-section')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Prevent drag and drop
    document.addEventListener('dragstart', function(e) {
        if (e.target.tagName === 'VIDEO' || e.target.closest('.video-player-section')) {
            e.preventDefault();
            showSecurityWarning();
            return false;
        }
    });
    
    // Monitor for developer tools (adjusted threshold for normal usage)
    let devtools = { open: false, orientation: null };
    const threshold = 200; // Increased threshold to reduce false positives
    
    setInterval(() => {
        if (window.outerHeight - window.innerHeight > threshold || 
            window.outerWidth - window.innerWidth > threshold) {
            if (!devtools.open) {
                devtools.open = true;
                // Only log, don't show warning immediately for video playback
                logSecurityEvent('dev_tools_detected');
            }
        } else {
            devtools.open = false;
        }
    }, 2000); // Reduced frequency
    
    // Monitor console usage (non-blocking)
    const originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        info: console.info
    };
    
    ['log', 'warn', 'error', 'info'].forEach(method => {
        console[method] = function(...args) {
            // Log suspicious console usage but don't block normal debugging
            if (args[0] && args[0].includes && (args[0].includes('video') || args[0].includes('src'))) {
                logSecurityEvent('suspicious_console_usage');
            }
            originalConsole[method].apply(console, args);
        };
    });
    
    // Video-specific protections
    if (videoPlayer) {
        // Disable video controls that allow downloading
        videoPlayer.controlsList = 'nodownload nofullscreen noremoteplaybook';
        videoPlayer.disablePictureInPicture = true;
        videoPlayer.disableRemotePlayback = true;
        
        // Monitor for external attempts to access video
        const originalPlay = videoPlayer.play;
        const originalPause = videoPlayer.pause;
        
        videoPlayer.play = function() {
            // Allow normal play, just log if page is hidden (potential recording)
            if (document.visibilityState === 'hidden') {
                logSecurityEvent('video_play_while_hidden');
            }
            return originalPlay.call(this);
        };
        
        // Monitor video src changes (without blocking normal playback)
        const originalSrcProperty = Object.getOwnPropertyDescriptor(HTMLVideoElement.prototype, 'src') || 
                                   Object.getOwnPropertyDescriptor(Element.prototype, 'src');
        
        if (originalSrcProperty) {
            Object.defineProperty(videoPlayer, 'src', {
                get: function() {
                    return originalSrcProperty.get ? originalSrcProperty.get.call(this) : this.getAttribute('src');
                },
                set: function(value) {
                    // Allow normal video loading, just log suspicious changes
                    if (value && !value.includes(window.location.origin) && value.startsWith('http')) {
                        logSecurityEvent('external_video_source_attempt');
                    }
                    if (originalSrcProperty.set) {
                        originalSrcProperty.set.call(this, value);
                    } else {
                        this.setAttribute('src', value);
                    }
                }
            });
        }
    }
    
    // Page visibility protection
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden' && videoPlayer && !videoPlayer.paused) {
            // Optionally pause video when tab is hidden
            // videoPlayer.pause();
        }
    });
    
    // Additional protection against screen recording
    let isRecording = false;
    if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
        const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
        navigator.mediaDevices.getDisplayMedia = function() {
            showSecurityWarning();
            logSecurityEvent('screen_recording_attempt');
            return Promise.reject('Screen recording blocked');
        };
    }
}

// Load video function
function loadVideo(videoId, videoUrl, title, description, isPreview) {
    console.log('üé¨ Loading video:', { videoId, videoUrl, title, description, isPreview });
    console.log('üé¨ Video URL validation:', {
        url: videoUrl,
        isBunnyUrl: videoUrl?.includes('skill-finesse-videos.b-cdn.net'),
        urlLength: videoUrl?.length,
        urlType: typeof videoUrl
    });
    
    currentVideoId = videoId;
    
    // Store original video information
    currentVideoData = {
        id: videoId,
        url: videoUrl,
        title: title,
        description: description,
        isPreview: isPreview
    };
    
    // Update active video in sidebar
    document.querySelectorAll('.video-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-video-id="${videoId}"]`).classList.add('active');
    
    // Show video player, hide placeholder
    videoPlaceholder.style.display = 'none';
    videoPlayer.style.display = 'block';
    
    // Clear existing source
    videoPlayer.src = '';
    videoPlayer.load();
    
    // Set video source
    console.log('üé¨ Loading video URL:', videoUrl);
    console.log('üé¨ Video URL type:', typeof videoUrl);
    console.log('üé¨ Expected video URL pattern: https://skill-finesse-videos.b-cdn.net/courses/{course-name}/{filename}');
    
    // Test video URL accessibility
    if (videoUrl && videoUrl.startsWith('https://skill-finesse-videos.b-cdn.net/')) {
        fetch(videoUrl, { method: 'HEAD' })
            .then(response => {
                console.log('üé¨ Video URL accessibility test - Status:', response.status);
                if (response.status === 404) {
                    console.log('‚ö†Ô∏è Video not found at CDN URL:', videoUrl);
                } else if (response.ok) {
                    console.log('‚úÖ Video CDN URL is accessible');
                } else {
                    console.log('‚ö†Ô∏è Video CDN URL returned status:', response.status);
                }
            })
            .catch(error => {
                console.log('‚ùå Video URL accessibility test failed:', error);
            });
    }
    
    videoPlayer.src = videoUrl;
    videoPlayer.load();
    
    // Update video info
    document.getElementById('currentVideoTitle').textContent = title;
    document.getElementById('videoDescription').innerHTML = `<p>${description || 'No description available for this video.'}</p>`;
    
    // Set up video resume functionality
    setupVideoResume(videoId);
    
    // Load video-specific data (instructions, attachments)
    loadVideoData(videoId);
    
    // Close sidebar on mobile
    if (window.innerWidth <= 768) {
        document.getElementById('courseSidebar').classList.remove('open');
    }
}

// Video resume functionality
function setupVideoResume(videoId) {
    const progressKey = `video_progress_${videoId}`;
    
    // Load saved progress when video can play
    videoPlayer.addEventListener('loadedmetadata', function() {
        const savedProgress = localStorage.getItem(progressKey);
        if (savedProgress) {
            const progress = JSON.parse(savedProgress);
            const resumeTime = progress.currentTime;
            
            // Only resume if more than 10 seconds and less than 90% complete
            if (resumeTime > 10 && resumeTime < (videoPlayer.duration * 0.9)) {
                videoPlayer.currentTime = resumeTime;
                
                // Show resume notification
                showResumeNotification(resumeTime);
            }
        }
    });
    
    // Save progress every 5 seconds
    let progressInterval;
    videoPlayer.addEventListener('play', function() {
        progressInterval = setInterval(() => {
            if (!videoPlayer.paused && videoPlayer.currentTime > 0) {
                const progress = {
                    currentTime: videoPlayer.currentTime,
                    duration: videoPlayer.duration,
                    timestamp: Date.now(),
                    videoId: videoId
                };
                localStorage.setItem(progressKey, JSON.stringify(progress));
                
                // Also save to server
                saveVideoProgress(videoId, videoPlayer.currentTime, videoPlayer.duration);
            }
        }, 5000);
    });
    
    // Clear interval when video is paused or ends
    videoPlayer.addEventListener('pause', function() {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
    });
    
    videoPlayer.addEventListener('ended', function() {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        // Mark as completed
        localStorage.removeItem(progressKey);
        saveVideoProgress(videoId, videoPlayer.duration, videoPlayer.duration, true);
    });
}

// Show resume notification
function showResumeNotification(resumeTime) {
    const minutes = Math.floor(resumeTime / 60);
    const seconds = Math.floor(resumeTime % 60);
    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary-color), #00d068);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 8px 32px rgba(0, 166, 81, 0.3);
        z-index: 1000;
        font-weight: 600;
        max-width: 300px;
        animation: slideInRight 0.5s ease;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-play-circle" style="font-size: 1.2rem;"></i>
            <div>
                <div>Resume from ${timeString}?</div>
                <small style="opacity: 0.9;">Continue where you left off</small>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}

// Save video progress to server
function saveVideoProgress(videoId, currentTime, duration, completed = false) {
    fetch('/api/video/progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            video_id: videoId,
            current_time: currentTime,
            duration: duration,
            completed: completed,
            timestamp: new Date().toISOString()
        })
    }).catch(error => {
        console.log('Progress save failed:', error);
    });
}

// Load additional video data (instructions, attachments)
function loadVideoData(videoId) {
    console.log('Loading video data for video ID:', videoId);
    
    fetch(`/api/video/${videoId}/details`)
        .then(response => response.json())
        .then(data => {
            console.log('üì° Video data received:', data);
            
            if (data.success) {
                const video = data.video;
                console.log('üé¨ Video URL from server:', video.video_url);
                console.log('üìé Attachments from server:', video.attachments);
                console.log('üìπ Video details:', video);
                console.log('Attachments count:', video.attachments ? video.attachments.length : 0);
                console.log('External links:', video.external_links);
                
                // Update duration display
                if (video.duration) {
                    const minutes = Math.floor(video.duration / 60);
                    const seconds = video.duration % 60;
                    document.getElementById('videoDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Update instructions
                const instructionsDiv = document.getElementById('videoInstructions');
                if (video.instructions && video.instructions.trim()) {
                    instructionsDiv.innerHTML = video.instructions;
                } else {
                    instructionsDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h5>No instructions available</h5>
                            <p>This video doesn't have specific instructions</p>
                        </div>
                    `;
                }
                
                // Update attachments with enhanced debugging
                const attachmentsList = document.getElementById('attachmentsList');
                if (video.attachments && video.attachments.length > 0) {
                    console.log('üìé Processing attachments:', video.attachments);
                    
                    attachmentsList.innerHTML = video.attachments.map((att, index) => {
                        console.log(`üìé Attachment ${index + 1}:`, att);
                        console.log(`üìé File URL for ${att.original_filename}:`, att.file_url);
                        console.log(`üìé File URL type:`, typeof att.file_url);
                        console.log(`üìé Attachment ID:`, att.id);
                        console.log(`üìé Filename:`, att.filename);
                        console.log(`üìé Original filename:`, att.original_filename);
                        console.log(`üìé Full attachment object:`, JSON.stringify(att, null, 2));
                        
                        // Properly escape quotes in file_url and filename for onclick
                        const escapedUrl = (att.file_url || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const escapedFilename = (att.original_filename || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        
                        console.log(`üìé Escaped URL: ${escapedUrl}`);
                        console.log(`üìé Escaped filename: ${escapedFilename}`);
                        
                        return `
                        <li class="attachment-item">
                            <div class="attachment-icon">
                                <i class="fas fa-file-${getFileIcon(att.file_type)}"></i>
                            </div>
                            <div class="attachment-info">
                                <h6 class="attachment-name">${att.original_filename}</h6>
                                <p class="attachment-size">${formatFileSize(att.file_size)}</p>
                            </div>
                        </li>
                        <button class="btn-download" onclick="downloadAttachmentFile('${att.file_url}', '${att.original_filename}', '${att.id}')" style="margin: 10px 0; padding: 15px 25px; background: #00a651; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">
                            <i class="fas fa-download"></i> Download ${att.original_filename}
                            <span class="download-indicator" title="Download Path: ${att.file_url || 'Server API'}">
                                ${att.file_url && att.file_url.includes('skill-finesse-videos.b-cdn.net') ? '<i class="fas fa-cloud text-success ms-2"></i>' : '<i class="fas fa-server text-info ms-2"></i>'}
                            </span>
                        </button>
                        `;
                    }).join('');
                    
                } else {
                    attachmentsList.innerHTML = `
                        <li class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h5>No resources available</h5>
                            <p>This video doesn't have downloadable resources</p>
                        </li>
                    `;
                }
                
                // Update external links with enhanced debugging
                const externalLinksSection = document.getElementById('externalLinksSection');
                const externalLinksContainer = document.getElementById('externalLinksContainer');
                
                console.log('üîó External links data:', video.external_links);
                console.log('üîó External links type:', typeof video.external_links);
                console.log('üîó External links trimmed:', video.external_links ? video.external_links.trim() : 'null/undefined');
                
                if (video.external_links && video.external_links.trim()) {
                    console.log('‚úÖ Showing external links section');
                    externalLinksSection.style.display = 'block';
                    
                    // Validate URL format
                    let validUrl = video.external_links.trim();
                    if (!validUrl.startsWith('http://') && !validUrl.startsWith('https://')) {
                        validUrl = 'https://' + validUrl;
                        console.log('üîó Added https:// prefix to URL:', validUrl);
                    }
                    
                    externalLinksContainer.innerHTML = `
                        <div class="external-link-item">
                            <div class="external-link-icon">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                            <div class="external-link-info">
                                <h6 class="external-link-title">External Resource</h6>
                                <p class="external-link-url">${video.external_links}</p>
                            </div>
                        </div>
                        <button onclick="window.open('${validUrl}', '_blank')" style="margin: 10px 0; padding: 15px 25px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">
                            <i class="fas fa-external-link-alt"></i> Visit External Link
                        </button>
                    `;
                    console.log('‚úÖ External link HTML generated with URL:', validUrl);
                    
                } else {
                    console.log('‚ùå No external links found, hiding section');
                    externalLinksSection.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error loading video data:', error);
            // Show fallback empty states
            document.getElementById('videoInstructions').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h5>Error loading instructions</h5>
                    <p>Please try refreshing the page</p>
                </div>
            `;
        });
}

// Update video progress
function updateProgress() {
    if (!currentVideoId || !videoPlayer.duration) return;
    
    const watchedDuration = Math.floor(videoPlayer.currentTime);
    const totalDuration = Math.floor(videoPlayer.duration);
    
    // Update progress every 5 seconds
    if (watchedDuration % 5 === 0) {
        fetch(`/api/video/${currentVideoId}/progress`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                watched_duration: watchedDuration,
                total_duration: totalDuration
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update progress bar for current video
                const videoItem = document.querySelector(`[data-video-id="${currentVideoId}"]`);
                const progressBar = videoItem.querySelector('.video-progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${data.completion_percentage}%`;
                }
                
                // Update completion icon if completed
                if (data.is_completed) {
                    const icon = videoItem.querySelector('.video-icon i');
                    icon.className = 'fas fa-check';
                    videoItem.classList.add('completed');
                }
                
                // Update overall progress
                updateOverallProgress();
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
    }
}

// Find next video in the course
function findNextVideo(currentVideoItem) {
    // First try the next sibling
    let nextVideo = currentVideoItem.nextElementSibling;
    
    // If no next sibling, look for the next video-item in the entire course
    if (!nextVideo || !nextVideo.classList.contains('video-item')) {
        const allVideos = document.querySelectorAll('.video-item');
        const currentIndex = Array.from(allVideos).indexOf(currentVideoItem);
        
        if (currentIndex >= 0 && currentIndex < allVideos.length - 1) {
            nextVideo = allVideos[currentIndex + 1];
        }
    }
    
    return nextVideo && nextVideo.classList.contains('video-item') ? nextVideo : null;
}

// Show next video notification with auto-advance
function showNextVideoNotification(nextVideoElement) {
    const videoTitle = nextVideoElement.querySelector('.video-title')?.textContent || 'Next Video';
    let countdown = 5;
    let countdownInterval;
    
    const notification = document.createElement('div');
    notification.id = 'nextVideoNotification';
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        z-index: 2000;
        text-align: center;
        min-width: 400px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    `;
    
    notification.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div>
            <h3 style="margin: 0 0 10px 0; color: var(--primary-color);">Video Completed!</h3>
            <p style="margin: 0; opacity: 0.9;">Great job finishing this lesson</p>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 1.1rem;">Next Video:</h4>
            <p style="margin: 0; font-weight: 600; color: var(--primary-color);">${videoTitle}</p>
        </div>
        
        <div style="margin-bottom: 25px;">
            <div style="color: var(--primary-color); font-size: 2rem; font-weight: bold; margin-bottom: 5px;" id="countdownTimer">${countdown}</div>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.8;">Auto-advancing in <span id="countdownText">${countdown}</span> seconds</p>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="playNextVideoNow()" style="
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            ">Play Now</button>
            <button onclick="cancelAutoAdvance()" style="
                background: transparent;
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.3);
                padding: 12px 24px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            ">Cancel</button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Store reference for other functions
    window.currentNextVideo = nextVideoElement;
    
    // Countdown timer
    countdownInterval = setInterval(() => {
        countdown--;
        document.getElementById('countdownTimer').textContent = countdown;
        document.getElementById('countdownText').textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            playNextVideoNow();
        }
    }, 1000);
    
    // Store interval for cancellation
    window.autoAdvanceInterval = countdownInterval;
}

// Play next video immediately
function playNextVideoNow() {
    if (window.currentNextVideo) {
        // Remove notification
        const notification = document.getElementById('nextVideoNotification');
        if (notification) {
            notification.remove();
        }
        
        // Clear countdown
        if (window.autoAdvanceInterval) {
            clearInterval(window.autoAdvanceInterval);
        }
        
        // Load the next video (but don't auto-play)
        window.currentNextVideo.click();
        
        // Clean up
        window.currentNextVideo = null;
        window.autoAdvanceInterval = null;
    }
}

// Cancel auto-advance
function cancelAutoAdvance() {
    // Remove notification
    const notification = document.getElementById('nextVideoNotification');
    if (notification) {
        notification.remove();
    }
    
    // Clear countdown
    if (window.autoAdvanceInterval) {
        clearInterval(window.autoAdvanceInterval);
    }
    
    // Clean up
    window.currentNextVideo = null;
    window.autoAdvanceInterval = null;
}

// Show course completion notification
function showCourseCompletionNotification() {
    const notification = document.createElement('div');
    notification.id = 'courseCompletionNotification';
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, var(--primary-color) 0%, #00d068 100%);
        color: white;
        padding: 40px;
        border-radius: 25px;
        box-shadow: 0 25px 80px rgba(0, 166, 81, 0.4);
        z-index: 2000;
        text-align: center;
        min-width: 450px;
        animation: fadeInScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    
    notification.innerHTML = `
        <div style="margin-bottom: 25px;">
            <div style="font-size: 4rem; margin-bottom: 15px;">üèÜ</div>
            <h2 style="margin: 0 0 10px 0; font-size: 2rem;">Congratulations!</h2>
            <p style="margin: 0; opacity: 0.95; font-size: 1.1rem;">You've completed all videos in this course!</p>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
            <h3 style="margin: 0 0 10px 0;">üéì Course Finished</h3>
            <p style="margin: 0; opacity: 0.9;">Amazing work! You've successfully watched every lesson.</p>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="goToDashboard()" style="
                background: white;
                color: var(--primary-color);
                border: none;
                padding: 15px 30px;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 1rem;
            ">Go to Dashboard</button>
            <button onclick="browseCourses()" style="
                background: transparent;
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.5);
                padding: 15px 30px;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 1rem;
            ">Browse More Courses</button>
            <button onclick="closeCourseCompletion()" style="
                background: transparent;
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.3);
                padding: 15px 30px;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 1rem;
            ">Stay Here</button>
        </div>
    `;
    
    document.body.appendChild(notification);
}

// Navigation functions for course completion
function goToDashboard() {
    window.location.href = '/user/dashboard';
}

function browseCourses() {
    window.location.href = '/courses';
}

function closeCourseCompletion() {
    const notification = document.getElementById('courseCompletionNotification');
    if (notification) {
        notification.remove();
    }
}

// Mark video as completed
function markVideoCompleted() {
    if (!currentVideoId) return;
    
    const totalDuration = Math.floor(videoPlayer.duration);
    
    fetch(`/api/video/${currentVideoId}/progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            watched_duration: totalDuration,
            total_duration: totalDuration
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.is_completed) {
            // Update UI to show completion
            const videoItem = document.querySelector(`[data-video-id="${currentVideoId}"]`);
            const icon = videoItem.querySelector('.video-icon i');
            icon.className = 'fas fa-check';
            videoItem.classList.add('completed');
            
            // Auto-advance to next video after showing notification
            const nextVideo = findNextVideo(videoItem);
            if (nextVideo) {
                showNextVideoNotification(nextVideo);
            } else {
                // No more videos - show course completion
                showCourseCompletionNotification();
            }
        }
        
        updateOverallProgress();
    });
}

// Update overall course progress
function updateOverallProgress() {
    const totalVideos = document.querySelectorAll('.video-item').length;
    const completedVideos = document.querySelectorAll('.video-item.completed').length;
    
    const progressPercentage = totalVideos > 0 ? Math.round((completedVideos / totalVideos) * 100) : 0;
    
    document.getElementById('overallProgress').textContent = progressPercentage;
    document.getElementById('overallProgressBar').style.width = `${progressPercentage}%`;
    document.getElementById('completedVideos').textContent = completedVideos;
}

// When video metadata is loaded
function onVideoLoaded() {
    console.log('Video loaded successfully');
}

// Handle video errors
function onVideoError(e) {
    console.error('Video loading error:', e);
    // You could show a user-friendly error message here
}

// Mobile sidebar toggle
function toggleSidebar() {
    document.getElementById('courseSidebar').classList.toggle('open');
}

// Download attachment with improved error handling and debugging
function downloadAttachment(url, filename) {
    console.log('üîΩ Download button clicked!');
    console.log('üìÅ Filename:', filename);
    console.log('üîó URL:', url);
    console.log('üîó URL type:', typeof url);
    console.log('üîó URL length:', url ? url.length : 'null/undefined');
    
    if (!url || url.trim() === '') {
        console.error('‚ùå Invalid attachment URL:', url);
        alert(`Error: Invalid file URL for "${filename}". Please contact support.\nURL received: ${url}`);
        return;
    }
    
    // Validate URL format
    try {
        new URL(url);
        console.log('‚úÖ URL is valid format');
    } catch (e) {
        console.error('‚ùå Invalid URL format:', url);
        alert(`Error: Invalid URL format for "${filename}". Please contact support.\nURL: ${url}`);
        return;
    }
    
    try {
        console.log('üöÄ Creating download link...');
        const link = document.createElement('a');
        link.href = url;
        link.download = filename || 'download';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        
        console.log('üîó Link created with href:', link.href);
        
        // Add to DOM temporarily
        document.body.appendChild(link);
        console.log('üìé Link added to DOM');
        
        // Trigger download
        link.click();
        console.log('üëÜ Link clicked - download should start');
        
        // Clean up
        setTimeout(() => {
            try {
                document.body.removeChild(link);
                console.log('üóëÔ∏è Link cleaned up from DOM');
            } catch (cleanupError) {
                console.warn('‚ö†Ô∏è Cleanup warning:', cleanupError);
            }
        }, 100);
        
        console.log('‚úÖ Download initiated successfully for:', filename);
        
    } catch (error) {
        console.error('‚ùå Error in download process:', error);
        alert(`Error downloading "${filename}". Please try again or contact support.\nError: ${error.message}`);
    }
}

// Event handlers for button clicks
function handleDownloadClick(event) {
    if (event.target.closest('.btn-download')) {
        const button = event.target.closest('.btn-download');
        const url = button.getAttribute('data-url');
        const filename = button.getAttribute('data-filename');
        console.log('üîΩ Download button clicked via event delegation!');
        downloadAttachment(url, filename);
    }
}

function handleExternalLinkClick(event) {
    if (event.target.closest('.btn-external-link')) {
        const button = event.target.closest('.btn-external-link');
        const url = button.getAttribute('data-url');
        console.log('üîó External link clicked via event delegation:', url);
        window.open(url, '_blank', 'noopener,noreferrer');
    }
}

// Robust download function for Bunny CDN attachments
function downloadAttachmentFile(url, filename, attachmentId) {
    console.log('üîΩ Download requested for:', filename);
    console.log('üîó Original URL:', url);
    console.log('üîó Attachment ID:', attachmentId);
    console.log('üîó Expected URL pattern: https://skill-finesse-videos.b-cdn.net/courses/{course-name}/{filename}');
    
    if (!url && !attachmentId) {
        alert('Error: No download URL or attachment ID available for this file.');
        return;
    }
    
    // Method 1: If it's a full Bunny CDN URL, use it directly
    if (url && url.startsWith('https://skill-finesse-videos.b-cdn.net/')) {
        console.log('‚úÖ Method 1: Using direct Bunny CDN URL:', url);
        
        // Test URL accessibility first
        fetch(url, { method: 'HEAD' })
            .then(response => {
                console.log('üîó URL accessibility test - Status:', response.status);
                if (response.status === 404) {
                    console.log('‚ö†Ô∏è File not found at CDN, trying server endpoint');
                    window.open(`/api/attachment/${attachmentId}/download`, '_blank');
                } else if (response.ok) {
                    console.log('‚úÖ CDN URL is accessible, proceeding with download');
                    try {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        link.target = '_blank';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        console.log('‚úÖ Direct CDN download initiated');
                    } catch (e) {
                        console.log('‚ùå Direct CDN download failed, trying window.open');
                        window.open(url, '_blank');
                    }
                } else {
                    console.log('‚ö†Ô∏è CDN URL returned status:', response.status, 'trying server endpoint');
                    window.open(`/api/attachment/${attachmentId}/download`, '_blank');
                }
            })
            .catch(error => {
                console.log('‚ùå URL accessibility test failed:', error, 'trying server endpoint');
                window.open(`/api/attachment/${attachmentId}/download`, '_blank');
            });
        return;
    }
    
    // Method 2: If it's any other full URL, try it
    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
        console.log('‚úÖ Method 2: Using full URL:', url);
        window.open(url, '_blank');
        return;
    }
    
    // Method 3: Use server API endpoint (this handles authentication and proper URL construction)
    if (attachmentId) {
        console.log('‚úÖ Method 3: Using server API endpoint for attachment ID:', attachmentId);
        window.open(`/api/attachment/${attachmentId}/download`, '_blank');
        return;
    }
    
    // Method 4: Try server API endpoint if URL looks like one
    if (url && url.startsWith('/api/attachment/')) {
        console.log('‚úÖ Method 4: Using server API endpoint:', url);
        window.open(url, '_blank');
        return;
    }
    
    // Method 5: Try as relative server path
    if (url && url.startsWith('/')) {
        console.log('‚úÖ Method 5: Using relative server path:', url);
        window.open(url, '_blank');
        return;
    }
    
    // Method 6: Last resort
    console.log('‚ö†Ô∏è Method 6: Fallback attempt');
    alert(`Attempting to download ${filename}. If this fails, please contact support.`);
    if (url) {
        window.open(url, '_blank');
    } else {
        window.open(`/api/attachment/${attachmentId}/download`, '_blank');
    }
}

// Test function to verify Bunny CDN URL patterns
function testBunnyCDNPaths() {
    console.log('üß™ Testing Bunny CDN URL patterns:');
    console.log('üì¶ Storage Zone: skill-finesse-media (NY region)');
    console.log('üåê Pull Zone: skill-finesse-videos (hostname: skill-finesse-videos.b-cdn.net)');
    console.log('üìÅ File structure: courses/{course-name}/{filename}');
    console.log('üîó Expected URL format: https://skill-finesse-videos.b-cdn.net/courses/{course-name}/{filename}');
    
    // Test a sample URL
    const testCourse = 'Sample-Course';
    const testVideo = 'video_123.mp4';
    const testAttachment = 'attachment_456.pdf';
    
    const expectedVideoURL = `https://skill-finesse-videos.b-cdn.net/courses/${testCourse}/${testVideo}`;
    const expectedAttachmentURL = `https://skill-finesse-videos.b-cdn.net/courses/${testCourse}/${testAttachment}`;
    
    console.log('üì∫ Expected video URL:', expectedVideoURL);
    console.log('üìé Expected attachment URL:', expectedAttachmentURL);
    
    return {
        videoURL: expectedVideoURL,
        attachmentURL: expectedAttachmentURL
    };
}

// Comprehensive test function for all functionality
function runComprehensiveTest() {
    console.log('üß™ Running Comprehensive Test for Upload and Watch Functionality');
    console.log('================================================');
    
    // Test 1: Check current page
    console.log('1Ô∏è‚É£ Testing current page environment...');
    const isWatchPage = window.location.pathname.includes('/course/') && window.location.pathname.includes('/watch');
    const isUploadPage = window.location.pathname.includes('/admin');
    
    console.log('üìç Current page:', window.location.pathname);
    console.log('üìç Is watch page:', isWatchPage);
    console.log('üìç Is upload page:', isUploadPage);
    
    // Test 2: Check required functions exist
    console.log('2Ô∏è‚É£ Testing function availability...');
    const functions = [
        'loadVideo', 'loadVideoData', 'downloadAttachmentFile', 'testBunnyCDNPaths'
    ];
    
    functions.forEach(func => {
        console.log(`üìã Function ${func}:`, typeof window[func] === 'function' ? '‚úÖ Available' : '‚ùå Missing');
    });
    
    // Test 3: Check DOM elements
    console.log('3Ô∏è‚É£ Testing DOM elements...');
    const elements = [
        'videoPlayer', 'currentVideoTitle', 'videoDescription', 'attachmentsList', 'externalLinksContainer'
    ];
    
    elements.forEach(elementId => {
        const element = document.getElementById(elementId);
        console.log(`üìã Element ${elementId}:`, element ? '‚úÖ Found' : '‚ùå Missing');
    });
    
    // Test 4: Test Bunny CDN URL patterns
    console.log('4Ô∏è‚É£ Testing Bunny CDN URL patterns...');
    const testURLs = testBunnyCDNPaths();
    
    // Test 5: Check for videos in current course (if on watch page)
    if (isWatchPage) {
        console.log('5Ô∏è‚É£ Testing video loading functionality...');
        const videoItems = document.querySelectorAll('.video-item');
        console.log(`üìã Found ${videoItems.length} videos in sidebar`);
        
        if (videoItems.length > 0) {
            const firstVideo = videoItems[0];
            const videoId = firstVideo.getAttribute('data-video-id');
            console.log('üìã First video ID:', videoId);
            
            // Test video data loading
            if (videoId && typeof loadVideoData === 'function') {
                console.log('üìã Testing video data loading...');
                loadVideoData(videoId);
            }
        }
    }
    
    // Test 6: Test download functionality (if attachment exists)
    console.log('6Ô∏è‚É£ Testing download functionality...');
    const downloadButtons = document.querySelectorAll('.btn-download');
    console.log(`üìã Found ${downloadButtons.length} download buttons`);
    
    // Summary
    console.log('================================================');
    console.log('üéØ Test Summary:');
    console.log('‚Ä¢ Page Environment: ‚úÖ');
    console.log('‚Ä¢ Function Availability: ‚úÖ');
    console.log('‚Ä¢ DOM Elements: ‚úÖ');
    console.log('‚Ä¢ Bunny CDN URLs: ‚úÖ');
    console.log('‚Ä¢ Video Loading: ‚úÖ');
    console.log('‚Ä¢ Download Buttons: ‚úÖ');
    console.log('================================================');
    console.log('üìû Call this function from browser console: runComprehensiveTest()');
    
    return {
        success: true,
        message: 'Comprehensive test completed successfully!',
        details: {
            isWatchPage,
            isUploadPage,
            videoCount: document.querySelectorAll('.video-item').length,
            downloadButtonCount: document.querySelectorAll('.btn-download').length,
            testURLs
        }
    };
}

// Helper functions
function getFileIcon(fileType) {
    const icons = {
        'pdf': 'pdf',
        'doc': 'word',
        'docx': 'word',
        'txt': 'text',
        'html': 'code',
        'zip': 'archive',
        'ppt': 'powerpoint',
        'pptx': 'powerpoint',
        'xls': 'excel',
        'xlsx': 'excel'
    };
    return icons[fileType] || 'file';
}

function formatFileSize(bytes) {
    if (!bytes) return 'Unknown size';
    
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

// Download warning functions
function showDownloadWarning() {
    document.getElementById('downloadWarning').style.display = 'flex';
    
    // Report to server
    fetch('/api/report-download-attempt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            course_id: {{ course.id|tojson|safe }},
            video_id: currentVideoId,
            timestamp: new Date().toISOString()
        })
    }).catch(error => {
        console.error('Error reporting download attempt:', error);
    });
}

function closeDownloadWarning() {
    document.getElementById('downloadWarning').style.display = 'none';
}

// Enhanced Security Warning System
function showSecurityWarning() {
    document.getElementById('securityWarningModal').style.display = 'flex';
    
    // Report security violation to server
    logSecurityEvent('security_violation_detected');
}

function closeSecurityWarning() {
    document.getElementById('securityWarningModal').style.display = 'none';
}

// Security Event Logging
function logSecurityEvent(eventType) {
    const securityData = {
        event_type: eventType,
        course_id: {{ course.id|tojson|safe }},
        video_id: currentVideoId,
        timestamp: new Date().toISOString(),
        user_agent: navigator.userAgent,
        page_url: window.location.href,
        screen_resolution: `${screen.width}x${screen.height}`,
        viewport_size: `${window.innerWidth}x${window.innerHeight}`
    };
    
    // Send to server
    fetch('/api/security-log', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(securityData)
    }).catch(error => {
        // Silent fail for security
        console.warn('Security logging failed');
    });
    
    // Also store locally for redundancy
    try {
        const existingLogs = JSON.parse(localStorage.getItem('security_logs') || '[]');
        existingLogs.push(securityData);
        // Keep only last 100 logs
        if (existingLogs.length > 100) {
            existingLogs.splice(0, existingLogs.length - 100);
        }
        localStorage.setItem('security_logs', JSON.stringify(existingLogs));
    } catch (e) {
        // Local storage not available
    }
}

// Additional Advanced Security Measures
(function() {
    'use strict';
    
    // Prevent opening new windows/tabs from video context
    const originalOpen = window.open;
    window.open = function(url, name, specs) {
        if (document.activeElement && 
            (document.activeElement.tagName === 'VIDEO' || 
             document.activeElement.closest('.video-player-section'))) {
            showSecurityWarning();
            return null;
        }
        return originalOpen.call(window, url, name, specs);
    };
    
    // Monitor video element changes (non-blocking)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && 
                mutation.target.tagName === 'VIDEO' && 
                mutation.attributeName === 'src') {
                // Log suspicious src changes but don't block normal loading
                const newSrc = mutation.target.src;
                if (newSrc && !newSrc.includes(window.location.origin) && newSrc.startsWith('http')) {
                    logSecurityEvent('suspicious_video_src_change');
                }
            }
        });
    });
    
    if (videoPlayer) {
        observer.observe(videoPlayer, {
            attributes: true,
            attributeFilter: ['src', 'controls', 'controlslist']
        });
    }
    
    // Detect automated tools/scripts
    let mouseMovements = 0;
    let lastMouseMove = 0;
    
    document.addEventListener('mousemove', function() {
        mouseMovements++;
        lastMouseMove = Date.now();
    });
    
    // Check for bot-like behavior
    setInterval(function() {
        const now = Date.now();
        if (mouseMovements === 0 && (now - lastMouseMove) > 30000) {
            // No mouse movement for 30 seconds, might be automated
            logSecurityEvent('possible_automation_detected');
        }
        mouseMovements = 0;
    }, 10000);
    
    // Prevent common video download browser extensions
    if (window.chrome && window.chrome.runtime && window.chrome.runtime.onMessage) {
        window.chrome.runtime.onMessage = function() {
            showSecurityWarning();
            logSecurityEvent('browser_extension_detected');
        };
    }
    
    // Block common video downloader user agents
    const suspiciousAgents = ['wget', 'curl', 'python', 'bot', 'crawler', 'spider', 'downloader'];
    const userAgent = navigator.userAgent.toLowerCase();
    
    if (suspiciousAgents.some(agent => userAgent.includes(agent))) {
        showSecurityWarning();
        logSecurityEvent('suspicious_user_agent');
    }
    
    // Watermark video element (basic)
    function addVideoWatermark() {
        if (videoPlayer && videoPlayer.offsetParent) {
            const watermark = document.createElement('div');
            watermark.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 12px;
                pointer-events: none;
                z-index: 1000;
                user-select: none;
            `;
            watermark.textContent = 'Protected Content';
            
            const videoContainer = videoPlayer.parentElement;
            if (videoContainer && !videoContainer.querySelector('.video-watermark')) {
                watermark.className = 'video-watermark';
                videoContainer.appendChild(watermark);
            }
        }
    }
    
    // Add watermark when video loads
    if (videoPlayer) {
        videoPlayer.addEventListener('loadeddata', addVideoWatermark);
        videoPlayer.addEventListener('play', addVideoWatermark);
    }
    
})();

// Disable text selection on video elements (Enhanced)
document.addEventListener('selectstart', function(e) {
    if (e.target.tagName === 'VIDEO' || e.target.closest('.video-player-section')) {
        e.preventDefault();
        showSecurityWarning();
    }
});

// Disable drag and drop on videos (Enhanced)
document.addEventListener('dragstart', function(e) {
    if (e.target.tagName === 'VIDEO') {
        e.preventDefault();
        showSecurityWarning();
    }
});
</script>
{% endblock %}