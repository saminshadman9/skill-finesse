{% extends 'base.html' %}

{% block title %}My eBooks - Skill Finesse{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/global-header-footer.css') }}" rel="stylesheet">
<style>
    body {
        font-family: 'Nunito', sans-serif;
        background-color: #f8f9fa;
    }
    
    .main-content {
        padding: 20px;
    }
    
    .card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .ebook-image {
        height: 200px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
{% include 'header.html' %}
<div class="container-fluid">
    <div class="row">
        {% include 'user/sidebar.html' %}
        
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">My eBooks</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{{ url_for('ebooks') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-search"></i> Browse eBooks
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Total eBooks</h5>
                                    <h3>{{ ebooks|length }}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-book fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Purchased</h5>
                                    <h3>{{ purchased_ebook_ids|length }}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Available</h5>
                                    <h3>{{ (ebooks|length) - (purchased_ebook_ids|length) }}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-shopping-cart fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchased eBooks -->
            {% if purchased_ebook_ids %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4><i class="fas fa-download me-2"></i>My Purchased eBooks</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for ebook in ebooks %}
                            {% if ebook.id in purchased_ebook_ids %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <img src="{% if ebook.cover_image %}{% if '_' in ebook.cover_image and ebook.cover_image.split('_')[-1].split('.')[0].isdigit() %}https://skill-finesse-videos.b-cdn.net/ebooks/{{ ebook.cover_image }}{% else %}{{ url_for('static', filename='images/ebook_cover/' + ebook.cover_image) }}{% endif %}{% else %}{{ url_for('static', filename='images/premium_course_1.png') }}{% endif %}" 
                                         class="card-img-top" alt="{{ ebook.name }}" style="height: 200px; object-fit: cover;">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">{{ ebook.name }}</h5>
                                        <p class="text-muted mb-2">by {{ ebook.author }}</p>
                                        <p class="card-text flex-grow-1">{{ ebook.description[:100] }}{% if ebook.description|length > 100 %}...{% endif %}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-success">Purchased</span>
                                                <span class="text-muted">{{ ebook.category or 'General' }}</span>
                                            </div>
                                            <div class="btn-group w-100">
                                                <a href="{{ url_for('ebook_details', ebook_id=ebook.id) }}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                <a href="{{ url_for('read_ebook', ebook_id=ebook.id) }}" class="btn btn-success btn-sm">
                                                    <i class="fas fa-book-open"></i> Read eBook
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Available eBooks -->
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-shopping-cart me-2"></i>Available eBooks</h4>
                </div>
                <div class="card-body">
                    {% if ebooks %}
                        <div class="row">
                            {% for ebook in ebooks %}
                                {% if ebook.id not in purchased_ebook_ids %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100">
                                        <img src="{% if ebook.cover_image %}{% if '_' in ebook.cover_image and ebook.cover_image.split('_')[-1].split('.')[0].isdigit() %}https://skill-finesse-videos.b-cdn.net/ebooks/{{ ebook.cover_image }}{% else %}{{ url_for('static', filename='images/ebook_cover/' + ebook.cover_image) }}{% endif %}{% else %}{{ url_for('static', filename='images/premium_course_1.png') }}{% endif %}" 
                                             class="card-img-top" alt="{{ ebook.name }}" style="height: 200px; object-fit: cover;">
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title">{{ ebook.name }}</h5>
                                            <p class="text-muted mb-2">by {{ ebook.author }}</p>
                                            <p class="card-text flex-grow-1">{{ ebook.description[:100] }}{% if ebook.description|length > 100 %}...{% endif %}</p>
                                            <div class="mt-auto">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="h5 text-primary mb-0">
                                                        {% if ebook.coupon and ebook.coupon_discount %}
                                                            <span class="text-decoration-line-through text-muted me-2">৳{{ ebook.price|round|int }}</span>
                                                            ৳{{ (ebook.price * (100 - ebook.coupon_discount) / 100)|round|int }}
                                                        {% else %}
                                                            ৳{{ ebook.price|round|int }}
                                                        {% endif %}
                                                    </span>
                                                    <span class="text-muted">{{ ebook.category or 'General' }}</span>
                                                </div>
                                                <div class="btn-group w-100">
                                                    <a href="{{ url_for('ebook_details', ebook_id=ebook.id) }}" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    <a href="{{ url_for('ebook_purchase', ebook_id=ebook.id) }}" class="btn btn-primary btn-sm">
                                                        <i class="fas fa-shopping-cart"></i> Purchase
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        {% if not (ebooks|selectattr('id', 'notin', purchased_ebook_ids)|list) %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h4>All eBooks Purchased!</h4>
                            <p class="text-muted">You have purchased all available eBooks. Great job!</p>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-book fa-3x text-muted mb-3"></i>
                            <h4>No eBooks Available</h4>
                            <p class="text-muted">There are currently no eBooks available. Check back later!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>
{% include 'footer.html' %}
{% endblock %}