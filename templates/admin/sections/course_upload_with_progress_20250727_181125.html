<!-- Course Upload Section -->
<div id="course-upload-section" class="content-section" style="display: none;">
    <div class="page-header modern-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="page-title">
                    <i class="fas fa-video me-3"></i>Video Management
                </h1>
                <p class="page-subtitle">Upload, organize, and manage your course videos</p>
            </div>
            <nav aria-label="breadcrumb" class="modern-breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="fas fa-home me-1"></i>Home</a></li>
                    <li class="breadcrumb-item"><a href="#"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Video Management</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Course Selection -->
    <div class="modern-card course-selector-card">
        <div class="card-header-modern">
            <div class="header-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="header-text">
                <h3 class="card-title-modern">Course Selection</h3>
                <p class="card-subtitle-modern">Choose a course to manage its video content</p>
            </div>
        </div>
        <div class="card-body-modern">
            <div class="course-selection-container">
                <div class="selection-wrapper">
                    <label class="modern-label">
                        <i class="fas fa-search me-2"></i>Select Course
                    </label>
                    <select id="courseSelect" class="modern-select" onchange="loadCourseVideos()">
                        <option value="">Choose a course to get started...</option>
                    </select>
                </div>
                <div id="selectedCourseInfo" class="course-info-panel" style="display: none;">
                    <div class="info-header">
                        <i class="fas fa-info-circle me-2"></i>Course Overview
                    </div>
                    <div id="courseInfoContent" class="info-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Management Section -->
    <div id="videoUploadSection" style="display: none;">
        <!-- Upload Actions Panel -->
        <div class="modern-card upload-actions-card">
            <div class="card-header-modern">
                <div class="header-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="header-text">
                    <h3 class="card-title-modern">Video Upload</h3>
                    <p class="card-subtitle-modern">Add new video content to your course</p>
                </div>
                <div class="header-actions">
                    <button class="btn-modern btn-primary" data-bs-toggle="modal" data-bs-target="#addVideoModal">
                        <i class="fas fa-plus me-2"></i>Add Video
                    </button>
                </div>
            </div>
            <div class="card-body-modern">
                <!-- Upload Progress -->
                <div id="simpleProgress" style="display: none; margin-bottom: 20px;"><div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px;"><div id="progressFileName" style="font-weight: bold; margin-bottom: 10px;">📤 Uploading...</div><div style="background: #e9ecef; border-radius: 6px; height: 25px; margin-bottom: 10px;"><div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #28a745, #20c997); width: 0%; transition: width 0.3s ease; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">0%</div></div><div id="progressStats" style="font-size: 13px; color: #666;">Preparing upload...</div></div>
                    <!-- Progress will be dynamically inserted here -->
                </div>
                
                <!-- Bulk Upload Zone -->
                <div class="bulk-upload-section">
                    <div class="upload-zone" id="bulkUploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h4 class="upload-title">Bulk Upload</h4>
                        <p class="upload-description">Drag and drop multiple video files or click to browse</p>
                        <input type="file" id="bulkVideoUpload" multiple accept="video/*" style="display: none;">
                        <button type="button" class="btn-upload" onclick="document.getElementById('bulkVideoUpload').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose Files
                        </button>
                        <div class="upload-info">
                            <small class="text-muted">Supported formats: MP4, AVI, MOV, WMV • No size limit (optimized for 500GB+ enterprise files)</small>
                        </div>
                    </div>
                    
                    <!-- Bulk Upload Progress -->
                    <div id="bulkUploadProgress" class="upload-progress-container" style="display: none;">
                        <!-- Bulk upload progress will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Library -->
        <div class="modern-card video-library-card">
            <div class="card-header-modern">
                <div class="header-icon">
                    <i class="fas fa-video"></i>
                </div>
                <div class="header-text">
                    <h3 class="card-title-modern">Video Library</h3>
                    <p class="card-subtitle-modern">Manage your course video content</p>
                </div>
                <div class="header-actions">
                    <div class="view-options">
                        <button class="view-btn active" data-view="grid" title="Grid View">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" data-view="list" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body-modern">
                <div id="videoList" class="video-library-content">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-video"></i>
                        </div>
                        <h4 class="empty-title">No videos yet</h4>
                        <p class="empty-description">Start building your course by adding your first video</p>
                        <button class="btn-modern btn-primary" data-bs-toggle="modal" data-bs-target="#addVideoModal">
                            <i class="fas fa-plus me-2"></i>Add Your First Video
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Video Modal -->
<div class="modal fade" id="addVideoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: black;">Add New Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addVideoForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Video Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Video Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Video File *</label>
                            <input type="file" class="form-control" name="video" accept="video/*" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Index</label>
                            <input type="number" class="form-control" name="order_index" min="0" value="0">
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="is_preview" id="isPreview">
                                <label class="form-check-label" for="isPreview">
                                    Free Preview (Non-enrolled users can watch)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Instructions</label>
                            <textarea class="form-control" name="instructions" rows="4" placeholder="Add written instructions for this video..."></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">External Link</label>
                            <input type="url" class="form-control" name="external_links" placeholder="https://example.com/resource">
                            <small class="form-text text-muted">Optional: Add a direct link to external resources</small>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Attachments</label>
                            <input type="file" class="form-control" name="attachments" multiple accept=".pdf,.html,.txt,.doc,.docx">
                            <small class="form-text text-muted">Upload additional files (PDF, HTML, TXT, DOC, etc.)</small>
                        </div>
                    </div>
                    
                    <!-- Upload Progress for Add Video Modal -->
                    <div id="addVideoProgress" class="upload-progress-container" style="display: none;">
                        <!-- Modal progress will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Video
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Video Modal -->
<div class="modal fade" id="editVideoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: black;">Edit Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editVideoForm">
                <div class="modal-body">
                    <input type="hidden" name="video_id" id="editVideoId">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Video Title *</label>
                            <input type="text" class="form-control" name="title" id="editVideoTitle" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Video Description</label>
                            <textarea class="form-control" name="description" id="editVideoDescription" rows="3"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Index</label>
                            <input type="number" class="form-control" name="order_index" id="editVideoOrder" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input type="checkbox" class="form-check-input" name="is_preview" id="editIsPreview">
                                <label class="form-check-label" for="editIsPreview">
                                    Free Preview
                                </label>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Instructions</label>
                            <textarea class="form-control" name="instructions" id="editVideoInstructions" rows="4"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">External Link</label>
                            <input type="url" class="form-control" name="external_links" id="editVideoLinks" placeholder="https://example.com/resource">
                            <small class="form-text text-muted">Optional: Add a direct link to external resources</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Video Preview Modal -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewVideoTitle">Video Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="video-container" style="background: #000; border-radius: 8px; overflow: hidden;">
                    <video id="previewVideoPlayer" controls preload="metadata" style="width: 100%; height: 500px; object-fit: contain;">
                        <p>Your browser doesn't support HTML5 video.</p>
                    </video>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Debug info: <span id="videoDebugInfo">No video loaded</span></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --primary-color: #00a651;
    --primary-dark: #008c44;
    --primary-light: #e8f5ed;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --dark-color: #343a40;
    --light-color: #f8f9fa;
    --white: #ffffff;
    --border-color: #e9ecef;
    --border-radius: 12px;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
}

/* Modern Header Styles */
.modern-header {
    background: var(--gradient-primary);
    padding: 2.5rem 0;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.modern-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

.header-content {
    position: relative;
    z-index: 2;
    padding: 0 2rem;
}

.page-title {
    color: var(--white);
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-subtitle {
    color: rgba(255,255,255,0.9);
    font-size: 1.1rem;
    margin: 0.5rem 0 0 0;
    font-weight: 400;
}

.modern-breadcrumb .breadcrumb {
    background: rgba(255,255,255,0.1);
    border-radius: 50px;
    padding: 0.75rem 1.5rem;
    margin-top: 1.5rem;
    backdrop-filter: blur(10px);
}

.modern-breadcrumb .breadcrumb-item a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: color 0.3s ease;
}

.modern-breadcrumb .breadcrumb-item a:hover {
    color: var(--white);
}

.modern-breadcrumb .breadcrumb-item.active {
    color: var(--white);
    font-weight: 500;
}

/* Modern Card Styles */
.modern-card {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
    overflow: hidden;
    transition: all 0.3s ease;
}

.modern-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.card-header-modern {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid var(--border-color);
    padding: 1.5rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-primary);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 1.2rem;
    flex-shrink: 0;
}

.header-text {
    flex: 1;
}

.card-title-modern {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
    line-height: 1.3;
}

.card-subtitle-modern {
    color: var(--secondary-color);
    font-size: 0.95rem;
    margin: 0.25rem 0 0 0;
    font-weight: 400;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.card-body-modern {
    padding: 2rem;
}

/* Modern Button Styles */
.btn-modern {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.95rem;
    border: none;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
    white-space: nowrap;
}

.btn-modern.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
    box-shadow: 0 2px 8px rgba(0, 166, 81, 0.3);
}

.btn-modern.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 166, 81, 0.4);
}

/* Course Selection Styles */
.course-selection-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
}

.selection-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.modern-label {
    font-weight: 600;
    color: var(--dark-color);
    font-size: 1rem;
    display: flex;
    align-items: center;
    margin: 0;
}

.modern-select {
    padding: 1rem 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 1rem;
    background: var(--white);
    color: var(--dark-color);
    transition: all 0.3s ease;
    outline: none;
}

.modern-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 166, 81, 0.1);
}

.course-info-panel {
    background: var(--primary-light);
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid rgba(0, 166, 81, 0.2);
}

.info-header {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1.1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}

.info-content {
    color: var(--dark-color);
    line-height: 1.6;
}

.info-content p {
    margin: 0.5rem 0;
}

.info-content strong {
    color: var(--primary-dark);
}

/* Upload Zone Styles */
.bulk-upload-section {
    margin-top: 1rem;
}

.upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius);
    padding: 3rem 2rem;
    text-align: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.upload-zone::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 166, 81, 0.1), transparent);
    transition: left 0.5s ease;
}

.upload-zone:hover {
    border-color: var(--primary-color);
    background: var(--primary-light);
    transform: translateY(-2px);
}

.upload-zone:hover::before {
    left: 100%;
}

.upload-zone.dragover {
    border-color: var(--primary-color);
    background: var(--primary-light);
    border-style: solid;
    box-shadow: 0 8px 24px rgba(0, 166, 81, 0.2);
}

.upload-icon {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
    opacity: 0.8;
}

.upload-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0 0 0.5rem 0;
}

.upload-description {
    color: var(--secondary-color);
    font-size: 1rem;
    margin: 0 0 1.5rem 0;
}

.btn-upload {
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
}

.btn-upload:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 166, 81, 0.3);
}

.upload-info {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

/* Progress Styles */
.upload-progress-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.progress-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.progress-bar-modern {
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 15px;
    color: white;
    font-weight: bold;
    font-size: 13px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    min-width: 40px;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: progress-shimmer 2s infinite;
}

@keyframes progress-shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-text {
    font-weight: 500;
    color: #333;
    text-align: left;
    font-size: 14px;
    margin-top: 5px;
}

/* Enhanced Progress Display Styles */
.upload-progress-info {
    font-family: var(--font-primary);
    text-align: left;
}

.upload-progress-info .progress-main {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}

.upload-progress-info .progress-details {
    font-size: 0.85rem;
    color: var(--text-muted);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
}

.upload-progress-info .bytes-info {
    font-weight: 500;
    color: var(--text-secondary);
}

.upload-progress-info .speed-info {
    font-weight: 600;
    color: var(--primary-color);
}

.upload-progress-info .eta-info {
    font-weight: 500;
    color: var(--secondary-color);
    font-style: italic;
}

/* View Options */
.view-options {
    display: flex;
    background: var(--light-color);
    border-radius: 8px;
    padding: 0.25rem;
    gap: 0.25rem;
}

.view-btn {
    padding: 0.5rem 0.75rem;
    border: none;
    background: transparent;
    border-radius: 6px;
    color: var(--secondary-color);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.view-btn.active,
.view-btn:hover {
    background: var(--white);
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-icon {
    font-size: 4rem;
    color: var(--border-color);
    margin-bottom: 1.5rem;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0 0 0.5rem 0;
}

.empty-description {
    color: var(--secondary-color);
    font-size: 1rem;
    margin: 0 0 2rem 0;
}

/* Video Library Content */
.video-library-content {
    min-height: 200px;
}

/* Grid and List View Styles */
.video-library-content.grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
}

.video-library-content.list-view .video-item-modern {
    margin-bottom: 1rem;
}

.video-library-content.grid-view .video-item-modern {
    margin-bottom: 0;
}

.video-library-content.grid-view .video-content-modern {
    grid-template-columns: 1fr;
    gap: 1rem;
    text-align: center;
}

.video-library-content.grid-view .video-thumbnail-modern {
    width: 100%;
    height: 120px;
    font-size: 2rem;
}

.video-library-content.grid-view .video-actions-modern {
    justify-content: center;
}

/* Video Item Styles (Modern) */
.video-item-modern {
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.video-item-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary-color);
    transform: scaleY(0);
    transition: transform 0.3s ease;
}

.video-item-modern:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.video-item-modern:hover::before {
    transform: scaleY(1);
}

.video-content-modern {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1.5rem;
    align-items: center;
}

.video-thumbnail-modern {
    width: 120px;
    height: 80px;
    background: var(--light-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--secondary-color);
    font-size: 1.5rem;
    border: 1px solid var(--border-color);
}

.video-info-modern {
    flex: 1;
    min-width: 0;
}

.video-title-modern {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
}

.video-meta-modern {
    display: flex;
    gap: 1rem;
    color: var(--secondary-color);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.video-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.video-tags {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.video-tag {
    background: var(--primary-light);
    color: var(--primary-color);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.video-actions-modern {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    padding: 0.5rem 0.75rem;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.action-btn.preview {
    background: var(--primary-light);
    color: var(--primary-color);
}

.action-btn.preview:hover {
    background: var(--primary-color);
    color: var(--white);
}

.action-btn.edit {
    background: var(--info-color);
    color: var(--white);
}

.action-btn.edit:hover {
    background: #138496;
}

.action-btn.delete {
    background: var(--danger-color);
    color: var(--white);
}

.action-btn.delete:hover {
    background: #c82333;
}

/* Responsive Design */
@media (max-width: 768px) {
    .course-selection-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .card-header-modern {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .header-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .video-content-modern {
        grid-template-columns: 1fr;
        gap: 1rem;
        text-align: center;
    }
    
    .video-actions-modern {
        justify-content: center;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .header-content {
        padding: 0 1rem;
    }
    
    .card-body-modern {
        padding: 1.5rem;
    }
}

@media (max-width: 576px) {
    .upload-zone {
        padding: 2rem 1rem;
    }
    
    .video-actions-modern {
        flex-direction: column;
        width: 100%;
    }
    
    .action-btn {
        justify-content: center;
    }
}
</style>

<script>
// Global variables
let selectedCourseId = null;
let uploadedVideos = [];

// Initialize course upload functionality
document.addEventListener('DOMContentLoaded', function() {
    // Make function globally available
    window.loadCoursesForUpload = loadCoursesForUpload;
    
    // Set up drag and drop
    setupDragAndDrop();
    
    // Set up form handlers
    setupFormHandlers();
    
    // Set up view toggle functionality
    setupViewToggle();
    
    // Load courses when section becomes visible
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const target = mutation.target;
                if (target.id === 'course-upload-section' && target.style.display !== 'none') {
                    console.log('Course upload section is now visible, loading courses...');
                    loadCoursesForUpload();
                }
            }
        });
    });
    
    // Start observing the course upload section
    const courseUploadSection = document.getElementById('course-upload-section');
    if (courseUploadSection) {
        observer.observe(courseUploadSection, { attributes: true });
    }
});

// Load courses for upload section
function loadCoursesForUpload() {
    console.log('Loading courses for upload...');
    
    const courseSelect = document.getElementById('courseSelect');
    if (!courseSelect) {
        console.error('Course select element not found');
        return;
    }
    
    // Show loading state
    courseSelect.innerHTML = '<option value="">Loading courses...</option>';
    
    fetch('/admin/courses/api')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            
            if (data.success) {
                courseSelect.innerHTML = '<option value="">-- Select a Course --</option>';
                
                if (data.courses && data.courses.length > 0) {
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        courseSelect.appendChild(option);
                    });
                    
                    console.log(`Loaded ${data.courses.length} courses for upload`);
                    showNotification(`Loaded ${data.courses.length} courses`, 'success');
                } else {
                    courseSelect.innerHTML = '<option value="">No courses available</option>';
                    showNotification('No courses found. Create a course first in the "Create Course" section.', 'info');
                }
            } else {
                console.error('Failed to load courses:', data.message);
                courseSelect.innerHTML = '<option value="">Failed to load courses</option>';
                showNotification('Failed to load courses: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading courses:', error);
            courseSelect.innerHTML = '<option value="">Error loading courses</option>';
            showNotification('Error loading courses: ' + error.message, 'error');
        });
}

// Load course videos when course is selected
function loadCourseVideos() {
    const courseSelect = document.getElementById('courseSelect');
    selectedCourseId = courseSelect.value;
    
    if (!selectedCourseId) {
        document.getElementById('videoUploadSection').style.display = 'none';
        document.getElementById('selectedCourseInfo').style.display = 'none';
        return;
    }
    
    // Show course info and upload section
    document.getElementById('videoUploadSection').style.display = 'block';
    showCourseInfo(selectedCourseId);
    
    // Load existing videos for this course
    loadExistingVideos(selectedCourseId);
}

// Show course information
function showCourseInfo(courseId) {
    fetch(`/admin/courses/${courseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const course = data.course;
                const infoDiv = document.getElementById('selectedCourseInfo');
                const contentDiv = document.getElementById('courseInfoContent');
                
                contentDiv.innerHTML = `
                    <p><strong>Title:</strong> ${course.title}</p>
                    <p><strong>Category:</strong> ${course.category || 'N/A'}</p>
                    <p><strong>Price:</strong> ${course.price} BDT</p>
                    <p><strong>Status:</strong> ${course.is_published ? 'Published' : 'Draft'}</p>
                `;
                
                infoDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading course info:', error);
        });
}

// Load existing videos for selected course
function loadExistingVideos(courseId) {
    console.log('📡 ========== LOADING EXISTING VIDEOS ==========');
    console.log('📡 Loading existing videos for course:', courseId);
    console.log('📡 Current timestamp:', new Date().toISOString());
    
    fetch(`/admin/courses/${courseId}/videos`)
        .then(response => {
            console.log('📡 Response status:', response.status);
            console.log('📡 Response headers:', Object.fromEntries(response.headers.entries()));
            return response.json();
        })
        .then(data => {
            console.log('📡 ========== API RESPONSE RECEIVED ==========');
            console.log('📡 Response data:', data);
            console.log('📡 Success flag:', data.success);
            console.log('📡 Videos found:', data.videos ? data.videos.length : 0);
            console.log('📡 Full video data:', JSON.stringify(data.videos, null, 2));
            
            if (data.success) {
                console.log('✅ Successfully loaded videos, calling displayVideos...');
                displayVideos(data.videos);
                console.log('✅ displayVideos called');
                
                // Force refresh the DOM to ensure it's updated
                setTimeout(() => {
                    const videoList = document.getElementById('videoList');
                    console.log('📡 Video list DOM content after 1 second:', videoList ? videoList.innerHTML.substring(0, 200) + '...' : 'NULL');
                }, 1000);
            } else {
                console.error('❌ Failed to load videos:', data.message);
                displayVideos([]); // Show empty state
            }
        })
        .catch(error => {
            console.error('❌ Error loading videos:', error);
            console.error('❌ Error details:', error.message, error.stack);
            displayVideos([]); // Show empty state
        });
}

// Display videos in the list - Recreated to match all upload sections
function displayVideos(videos) {
    console.log('🎬 ========== DISPLAY VIDEOS CALLED ==========');
    console.log('🎬 Displaying videos:', videos);
    console.log('🎬 Videos count:', videos.length);
    console.log('🎬 Raw video data:', JSON.stringify(videos, null, 2));
    console.log('🎬 Current timestamp:', new Date().toISOString());
    
    const videoList = document.getElementById('videoList');
    
    if (!videoList) {
        console.error('❌ videoList element not found! DOM might not be ready.');
        console.log('❌ Available elements with video-related IDs:');
        const videoElements = document.querySelectorAll('[id*="video"], [id*="Video"]');
        videoElements.forEach(el => console.log('  - Found:', el.id, el.tagName));
        return;
    }
    
    console.log('✅ videoList element found:', videoList);
    
    if (videos.length === 0) {
        videoList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-video"></i>
                </div>
                <h4 class="empty-title">No videos yet</h4>
                <p class="empty-description">Start building your course by adding your first video</p>
                <button class="btn-modern btn-primary" data-bs-toggle="modal" data-bs-target="#addVideoModal">
                    <i class="fas fa-plus me-2"></i>Add Your First Video
                </button>
            </div>
        `;
        return;
    }
    
    // Enhanced video display with proper Bunny CDN URL handling
    console.log('🎬 Creating video library items...');
    
    videoList.innerHTML = videos.map((video, index) => {
        console.log(`🎬 Processing video ${index + 1}:`, video);
        
        // Validate video data
        const videoId = video.id || 'unknown';
        const videoTitle = video.title || 'Untitled Video';
        const videoUrl = video.video_url || '';
        const videoDescription = video.description || '';
        const videoOrder = video.order_index || 0;
        const videoDuration = video.duration || 0;
        const isPreview = video.is_preview || false;
        const videoInstructions = video.instructions || '';
        const externalLinks = video.external_links || '';
        const attachments = video.attachments || [];
        
        console.log(`🎬 Video ${videoId} URL:`, videoUrl);
        console.log(`🎬 Video ${videoId} attachments:`, attachments);
        
        // Validate Bunny CDN URL format
        const isBunnyUrl = videoUrl.includes('skill-finesse-videos.b-cdn.net');
        const urlStatus = isBunnyUrl ? '✅ Bunny CDN' : '⚠️ Non-CDN';
        
        return `
        <div class="video-item-modern" data-video-id="${videoId}">
            <div class="video-content-modern">
                <div class="video-thumbnail-modern">
                    <i class="fas fa-play-circle"></i>
                    <div class="video-url-indicator" title="${urlStatus}: ${videoUrl}">
                        ${isBunnyUrl ? '<i class="fas fa-cloud text-success"></i>' : '<i class="fas fa-exclamation-triangle text-warning"></i>'}
                    </div>
                </div>
                <div class="video-info-modern">
                    <h4 class="video-title-modern">${videoTitle}</h4>
                    <div class="video-meta-modern">
                        <div class="video-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${formatDuration(videoDuration)}</span>
                        </div>
                        <div class="video-meta-item">
                            <i class="fas fa-sort"></i>
                            <span>Order: ${videoOrder}</span>
                        </div>
                        <div class="video-meta-item">
                            <i class="fas fa-link"></i>
                            <span>${urlStatus}</span>
                        </div>
                    </div>
                    <div class="video-tags">
                        ${isPreview ? '<span class="video-tag preview-tag">Free Preview</span>' : ''}
                        ${videoDescription ? '<span class="video-tag">Has Description</span>' : ''}
                        ${videoInstructions ? '<span class="video-tag">Has Instructions</span>' : ''}
                        ${externalLinks ? '<span class="video-tag">External Links</span>' : ''}
                        ${attachments.length > 0 ? `<span class="video-tag">${attachments.length} Files</span>` : ''}
                    </div>
                    ${videoDescription ? `<p class="video-description">${videoDescription.substring(0, 100)}${videoDescription.length > 100 ? '...' : ''}</p>` : ''}
                </div>
                <div class="video-actions-modern">
                    <button class="action-btn preview video-preview-btn" 
                            data-video-url="${videoUrl}" 
                            data-video-title="${videoTitle}"
                            data-video-id="${videoId}"
                            title="Preview Video">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn edit" onclick="editVideo(${videoId})" title="Edit Video">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteVideo(${videoId})" title="Delete Video">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="action-btn info" onclick="showVideoDetails(${videoId})" title="Video Details">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            ${attachments.length > 0 ? `
                <div class="video-attachments-section">
                    <h6 class="attachments-title">
                        <i class="fas fa-paperclip"></i> 
                        Attachments (${attachments.length})
                    </h6>
                    <div class="attachments-grid">
                        ${attachments.map(att => `
                            <div class="attachment-item-compact" title="${att.original_filename} (${formatFileSize(att.file_size)})">
                                <i class="fas fa-file-${getFileIcon(att.file_type)}"></i>
                                <span class="attachment-name">${att.original_filename}</span>
                                <span class="attachment-size">${formatFileSize(att.file_size)}</span>
                                ${att.file_url ? `<i class="fas fa-check-circle text-success" title="File URL available"></i>` : `<i class="fas fa-exclamation-circle text-warning" title="File URL missing"></i>`}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
        `;
    }).join('');
    
    // Add event listeners for preview buttons
    const previewButtons = videoList.querySelectorAll('.video-preview-btn');
    previewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const videoUrl = this.getAttribute('data-video-url');
            const videoTitle = this.getAttribute('data-video-title');
            const videoId = this.getAttribute('data-video-id');
            console.log('Preview button clicked:', videoUrl, videoTitle, 'ID:', videoId);
            previewVideo(videoUrl, videoTitle, videoId);
        });
    });
    
    console.log('🎬 ========== DISPLAY VIDEOS COMPLETED ==========');
    console.log('🎬 Video library updated with', videos.length, 'videos');
}

// Test function to manually verify video library functionality
function testVideoLibraryRefresh() {
    console.log('🧪 ========== TESTING VIDEO LIBRARY REFRESH ==========');
    
    if (!selectedCourseId) {
        console.log('❌ No course selected. Please select a course first.');
        return;
    }
    
    console.log('🧪 Testing video library refresh for course:', selectedCourseId);
    console.log('🧪 Step 1: Checking if videoList element exists...');
    
    const videoList = document.getElementById('videoList');
    if (!videoList) {
        console.log('❌ videoList element not found!');
        return;
    }
    console.log('✅ videoList element found');
    
    console.log('🧪 Step 2: Current videoList content preview:', videoList.innerHTML.substring(0, 100) + '...');
    
    console.log('🧪 Step 3: Calling loadExistingVideos...');
    loadExistingVideos(selectedCourseId);
    
    console.log('🧪 Step 4: Waiting 3 seconds then checking result...');
    setTimeout(() => {
        const updatedContent = document.getElementById('videoList').innerHTML;
        console.log('🧪 Updated content preview:', updatedContent.substring(0, 200) + '...');
        
        if (updatedContent.includes('No videos yet')) {
            console.log('⚠️ Video library still shows empty state');
        } else if (updatedContent.includes('video-item-modern')) {
            console.log('✅ Video library shows video items!');
        } else {
            console.log('❓ Video library content unclear:', updatedContent.substring(0, 100));
        }
    }, 3000);
}

// Helper function to format bytes
function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Debug function to test database directly
function testDatabaseVideos() {
    console.log('🔍 ========== TESTING DATABASE VIDEOS ==========');
    
    if (!selectedCourseId) {
        console.log('❌ No course selected. Please select a course first.');
        return;
    }
    
    console.log('🔍 Testing database videos for course:', selectedCourseId);
    console.log('🔍 Making direct API call to /admin/courses/${courseId}/videos...');
    
    fetch(`/admin/courses/${selectedCourseId}/videos`)
        .then(response => {
            console.log('🔍 Raw response status:', response.status);
            return response.text();
        })
        .then(text => {
            console.log('🔍 Raw response text:', text);
            try {
                const data = JSON.parse(text);
                console.log('🔍 Parsed JSON:', data);
                console.log('🔍 Videos in database:', data.videos ? data.videos.length : 0);
                
                if (data.videos && data.videos.length > 0) {
                    console.log('✅ Found videos in database!');
                    data.videos.forEach((video, index) => {
                        console.log(`🔍 Video ${index + 1}:`, {
                            id: video.id,
                            title: video.title,
                            video_url: video.video_url,
                            created_at: video.created_at
                        });
                    });
                } else {
                    console.log('❌ No videos found in database');
                }
            } catch (e) {
                console.log('❌ Failed to parse JSON:', e.message);
            }
        })
        .catch(error => {
            console.log('❌ API call failed:', error);
        });
}

// Setup drag and drop functionality
function setupDragAndDrop() {
    const uploadArea = document.getElementById('bulkUploadArea');
    const fileInput = document.getElementById('bulkVideoUpload');
    
    // Click to upload
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Drag and drop events
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('video/'));
        if (files.length > 0) {
            handleBulkUpload(files);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            handleBulkUpload(files);
        }
    });
}

// Setup form handlers
function setupFormHandlers() {
    // Add video form
    document.getElementById('addVideoForm').addEventListener('submit', handleVideoUpload);
    
    // Edit video form
    document.getElementById('editVideoForm').addEventListener('submit', handleVideoEdit);
    
    // Auto-fill title when video file is selected in modal
    const addVideoFileInput = document.querySelector('#addVideoForm input[name="video"]');
    const addVideoTitleInput = document.querySelector('#addVideoForm input[name="title"]');
    
    if (addVideoFileInput && addVideoTitleInput) {
        addVideoFileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                // Extract filename without extension and set as title
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                
                // Only set title if it's currently empty
                if (!addVideoTitleInput.value.trim()) {
                    addVideoTitleInput.value = fileName;
                    console.log('🏷️ Auto-filled title:', fileName);
                }
            }
        });
    }
}

// Setup view toggle functionality
function setupViewToggle() {
    const viewButtons = document.querySelectorAll('.view-btn');
    const videoList = document.getElementById('videoList');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            viewButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get view type
            const viewType = this.getAttribute('data-view');
            
            // Apply view class to video list
            if (viewType === 'grid') {
                videoList.classList.remove('list-view');
                videoList.classList.add('grid-view');
            } else {
                videoList.classList.remove('grid-view');
                videoList.classList.add('list-view');
            }
        });
    });
}

// Handle bulk video upload with enhanced progress tracking
function handleBulkUpload(files) {
    if (!selectedCourseId) {
        showNotification('Please select a course first', 'error');
        return;
    }
    
    if (files.length === 0) {
        showNotification('No video files selected', 'error');
        return;
    }
    
    showNotification(`Starting upload of ${files.length} videos...`, 'info');
    
    // Show bulk upload progress
    document.getElementById('bulkUploadProgress').style.display = 'block';
    document.getElementById('bulkUploadTotal').textContent = files.length;
    document.getElementById('bulkUploadCurrent').textContent = '0';
    
    let completedUploads = 0;
    let activeUploads = [];
    
    const uploadNext = (index) => {
        if (index >= files.length) {
            // All uploads completed
            document.getElementById('bulkUploadProgress').style.display = 'none';
            showNotification(`All ${files.length} videos uploaded successfully!`, 'success');
            return;
        }
        
        const file = files[index];
        const xhr = uploadSingleVideo(file, index + 1, true);
        activeUploads.push(xhr);
        
        // Update bulk upload counter
        document.getElementById('bulkUploadCurrent').textContent = (index + 1).toString();
        
        // Override the xhr.onload to handle bulk upload completion
        const originalOnload = xhr.onload;
        xhr.onload = function() {
            completedUploads++;
            
            // Update overall progress
            const overallProgress = Math.round((completedUploads / files.length) * 100);
            document.getElementById('bulkUploadProgressBar').style.width = overallProgress + '%';
            document.getElementById('bulkUploadProgressText').textContent = 
                `Bulk Upload Progress: ${completedUploads}/${files.length} completed (${overallProgress}%)`;
            
            // Call original handler
            originalOnload.call(this);
            
            // Start next upload after a short delay to prevent server overload
            setTimeout(() => {
                uploadNext(index + 1);
            }, 500);
        };
        
        // Override the xhr.onerror to handle bulk upload errors
        const originalOnerror = xhr.onerror;
        xhr.onerror = function() {
            completedUploads++; // Count as completed even if failed
            
            // Update overall progress
            const overallProgress = Math.round((completedUploads / files.length) * 100);
            document.getElementById('bulkUploadProgressBar').style.width = overallProgress + '%';
            document.getElementById('bulkUploadProgressText').textContent = 
                `Bulk Upload Progress: ${completedUploads}/${files.length} completed (${overallProgress}%) - Some errors occurred`;
            
            // Call original handler
            originalOnerror.call(this);
            
            // Continue with next upload
            setTimeout(() => {
                uploadNext(index + 1);
            }, 500);
        };
    };
    
    // Start the first upload
    uploadNext(0);
}

// Upload single video with real-time Bunny.net progress tracking
function uploadSingleVideo(file, orderIndex = 0, isBulk = false) {
    const formData = new FormData();
    formData.append('video', file);
    formData.append('title', file.name.replace(/\.[^/.]+$/, "")); // Remove extension
    formData.append('course_id', selectedCourseId);
// Add upload ID and start simple progress    const uploadId = "upload_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);    formData.append("upload_id", uploadId);    formData.append("use_tus", "true");        const videoFile = formData.get("video");    if (videoFile) updateSimpleProgress(uploadId, videoFile.name);
    formData.append('order_index', orderIndex);
    
    const progressBarId = isBulk ? 'bulkUploadProgressBar' : 'progressBar';
    const progressTextId = isBulk ? 'bulkUploadProgressText' : 'progressText';
    const progressContainerId = isBulk ? 'bulkUploadProgress' : 'uploadProgress';
    
    // Show progress container
    document.getElementById(progressContainerId).style.display = 'block';
    
    // Generate unique upload ID for progress tracking
    const uploadId = 'upload_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    formData.append('upload_id', uploadId);
    
    // Create XMLHttpRequest for initial upload to server
    const xhr = new XMLHttpRequest();
    let bunnyProgressStarted = false;
    let eventSource = null;
    
    // Track initial upload progress to Flask server
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable && !bunnyProgressStarted) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            const progressBar = document.getElementById(progressBarId);
            const progressText = document.getElementById(progressTextId);
            
            if (progressBar) progressBar.style.width = Math.min(percentComplete, 30) + '%'; // Max 30% for server upload
            if (progressText) {
                const fileSizeMB = (e.total / (1024 * 1024)).toFixed(1);
                const uploadedMB = (e.loaded / (1024 * 1024)).toFixed(1);
                progressText.textContent = `Uploading to server "${file.name}" - ${percentComplete}% (${uploadedMB}MB / ${fileSizeMB}MB)`;
            }
        }
    });
    
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    // Server upload complete, now track Bunny.net upload
                    bunnyProgressStarted = true;
                    startRealTimeProgress(uploadId, file.name, progressContainerId, isBulk);
                } else {
                    showNotification(`Failed to upload "${file.name}": ${data.message}`, 'error');
                    if (!isBulk) {
                        document.getElementById(progressContainerId).style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error parsing response:', error);
                showNotification(`Error uploading "${file.name}": Invalid response`, 'error');
                if (!isBulk) {
                    document.getElementById(progressContainerId).style.display = 'none';
                }
            }
        } else {
            showNotification(`Error uploading "${file.name}": HTTP ${xhr.status}`, 'error');
            if (!isBulk) {
                document.getElementById(progressContainerId).style.display = 'none';
            }
        }
    };
    
    xhr.onerror = function() {
        console.error('Upload error for:', file.name);
        showNotification(`Network error uploading "${file.name}"`, 'error');
        if (!isBulk) {
            document.getElementById(progressContainerId).style.display = 'none';
        }
    };
    
    // Use TUS resumable upload for all files (optimized for 10GB+ files)
    const useTUS = true; // Always use TUS for best performance and resumability
    
    if (useTUS) {
        console.log(`🚀 Using TUS resumable upload for ${(file.size / (1024*1024*1024)).toFixed(1)}GB file (optimized for 500GB+ enterprise files)`);
        formData.append('use_tus', 'true');
        
        // Add retry capability for TUS uploads - optimized for 500GB+ enterprise files
        xhr.timeout = 0; // No timeout for TUS uploads (can handle 500GB+ files)
        
        // Enhanced error handling for TUS uploads
        xhr.addEventListener('timeout', function() {
            console.log('⏰ TUS upload timeout, this is expected for resumable uploads');
        });
    } else {
        console.log(`📤 Using standard upload for file (${(file.size / (1024*1024)).toFixed(1)}MB)`);
        formData.append('use_tus', 'false');
        xhr.timeout = 300000; // 5 minute timeout for standard uploads
    }
    
    // Test if the new progress route is available, otherwise fallback to original
    xhr.open('POST', '/admin/upload-video-with-progress');
    xhr.send(formData);
    
    return {xhr, uploadId}; // Return both xhr and uploadId for potential cancellation
}

// NEW SIMPLE REAL-TIME PROGRESS TRACKER
function startRealTimeProgress(uploadId, fileName, progressContainerId, isBulk = false) {
    console.log('🚀 Starting REAL-TIME progress for:', fileName);
    
    const progressContainer = document.getElementById(progressContainerId);
    if (!progressContainer) {
        console.error('❌ Progress container not found:', progressContainerId);
        return;
    }
    
    // Show progress container
    progressContainer.style.display = 'block';
    progressContainer.innerHTML = `
        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin: 10px 0;">
            <div style="font-weight: 600; margin-bottom: 10px; color: #495057;">
                📤 Uploading: ${fileName}
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #e9ecef; border-radius: 6px; height: 20px; margin-bottom: 10px; overflow: hidden;">
                <div id="realProgressBar_${uploadId}" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                    0%
                </div>
            </div>
            
            <!-- Upload Stats -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px;">
                <div>
                    <strong>Progress:</strong>
                    <span id="realPercent_${uploadId}">0%</span>
                </div>
                <div>
                    <strong>Uploaded:</strong>
                    <span id="realUploaded_${uploadId}">0 MB</span>
                </div>
                <div>
                    <strong>Speed:</strong>
                    <span id="realSpeed_${uploadId}">0 MB/s</span>
                </div>
            </div>
            
            <!-- Status -->
            <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                <strong>Status:</strong> <span id="realStatus_${uploadId}">Starting upload...</span>
            </div>
        </div>
    `;
    
    // Connect to real-time updates
    const eventSource = new EventSource(`/admin/upload-progress/${uploadId}`);
    let isCompleted = false;
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('📊 Real upload data:', data);
            
            // Update progress bar
            const progressBar = document.getElementById(`realProgressBar_${uploadId}`);
            const percentElement = document.getElementById(`realPercent_${uploadId}`);
            const uploadedElement = document.getElementById(`realUploaded_${uploadId}`);
            const speedElement = document.getElementById(`realSpeed_${uploadId}`);
            const statusElement = document.getElementById(`realStatus_${uploadId}`);
            
            if (data.percent !== undefined) {
                const percent = Math.max(0, Math.min(100, data.percent));
                
                if (progressBar) {
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                    progressBar.style.background = percent >= 100 
                        ? 'linear-gradient(90deg, #28a745, #20c997)' 
                        : 'linear-gradient(90deg, #007bff, #0056b3)';
                }
                
                if (percentElement) percentElement.textContent = percent + '%';
                if (uploadedElement) uploadedElement.textContent = data.uploaded || '0 MB';
                if (speedElement) speedElement.textContent = data.speed || '0 MB/s';
                if (statusElement) statusElement.textContent = data.message || data.status || 'Uploading...';
                
                // Handle completion
                if (data.status === 'completed' && percent >= 100) {
                    isCompleted = true;
                    eventSource.close();
                    
                    if (statusElement) statusElement.textContent = '✅ Upload completed successfully!';
                    showNotification(`${fileName} uploaded successfully!`, 'success');
                    
                    // Auto-hide and reload
                    setTimeout(() => {
                        if (!isBulk) progressContainer.style.display = 'none';
                        loadCourseVideos(document.getElementById('courseSelect')?.value);
                    }, 3000);
                    
                } else if (data.status === 'failed') {
                    isCompleted = true;
                    eventSource.close();
                    
                    if (statusElement) statusElement.textContent = '❌ Upload failed: ' + (data.error || 'Unknown error');
                    if (progressBar) progressBar.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
                    showNotification(`Upload failed: ${data.error || 'Unknown error'}`, 'error');
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 5000);
                }
            }
        } catch (error) {
            console.error('📡 Error parsing progress data:', error);
        }
    };
    
    eventSource.onerror = function(error) {
        console.error('📡 Progress connection error:', error);
        if (!isCompleted) {
            const statusElement = document.getElementById(`realStatus_${uploadId}`);
            if (statusElement) statusElement.textContent = '⚠️ Connection lost - upload may still be processing';
        }
        eventSource.close();
    };
}

// Handle single video upload from modal with real-time Bunny.net progress tracking
function handleVideoUpload(e) {
    e.preventDefault();
    
    if (!selectedCourseId) {
        showNotification('Please select a course first', 'error');
        return;
    }
    
    const formData = new FormData(e.target);
    formData.append('course_id', selectedCourseId);
// Add upload ID and start simple progress    const uploadId = "upload_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);    formData.append("upload_id", uploadId);    formData.append("use_tus", "true");        const videoFile = formData.get("video");    if (videoFile) updateSimpleProgress(uploadId, videoFile.name);
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
    submitBtn.disabled = true;
    
    // Show modal progress bar
    document.getElementById('addVideoProgress').style.display = 'block';
    
    // Generate unique upload ID for progress tracking
    const uploadId = 'upload_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    formData.append('upload_id', uploadId);
    
    // Get file name for progress tracking
    const videoFile = formData.get('video');
    const fileName = videoFile ? videoFile.name : 'video';
    
    // Create XMLHttpRequest for initial upload to server
    const xhr = new XMLHttpRequest();
    let bunnyProgressStarted = false;
    
    // Track initial upload progress to Flask server
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable && !bunnyProgressStarted) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            const progressBar = document.getElementById('addVideoProgressBar');
            const progressText = document.getElementById('addVideoProgressText');
            
            if (progressBar) progressBar.style.width = Math.min(percentComplete, 30) + '%'; // Max 30% for server upload
            if (progressText) {
                const fileSizeMB = (e.total / (1024 * 1024)).toFixed(1);
                const uploadedMB = (e.loaded / (1024 * 1024)).toFixed(1);
                progressText.textContent = `Uploading to server "${fileName}" - ${percentComplete}% (${uploadedMB}MB / ${fileSizeMB}MB)`;
            }
        }
    });
    
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    // Server upload complete, now track Bunny.net upload
                    bunnyProgressStarted = true;
                    startModalRealTimeProgress(uploadId, fileName, submitBtn, originalText, e.target);
                } else {
                    // Hide progress bar and reset button
                    document.getElementById('addVideoProgress').style.display = 'none';
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    showNotification('Failed to upload video: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error parsing response:', error);
                document.getElementById('addVideoProgress').style.display = 'none';
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showNotification('Error uploading video: Invalid response', 'error');
            }
        } else {
            console.error(`Upload failed with status ${xhr.status} - trying fallback method`);
            
            // Try fallback to original upload method
            const fallbackFormData = new FormData(e.target);
            fallbackFormData.append('course_id', selectedCourseId);
            
            fetch('/admin/upload-video', {
                method: 'POST',
                body: fallbackFormData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addVideoProgress').style.display = 'none';
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (data.success) {
                    showNotification('Video uploaded successfully (fallback method)!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addVideoModal')).hide();
                    e.target.reset();
                    loadCourseVideos();
                } else {
                    showNotification('Upload failed: ' + data.message, 'error');
                }
            })
            .catch(error => {
                document.getElementById('addVideoProgress').style.display = 'none';
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showNotification(`Error uploading video: HTTP ${xhr.status}`, 'error');
            });
        }
    };
    
    xhr.onerror = function() {
        console.error('Upload error - trying fallback method');
        
        // Try fallback to original upload method
        const fallbackFormData = new FormData(e.target);
        fallbackFormData.append('course_id', selectedCourseId);
        
        fetch('/admin/upload-video', {
            method: 'POST',
            body: fallbackFormData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('addVideoProgress').style.display = 'none';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (data.success) {
                showNotification('Video uploaded successfully (fallback method)!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addVideoModal')).hide();
                e.target.reset();
                loadCourseVideos();
            } else {
                showNotification('Upload failed: ' + data.message, 'error');
            }
        })
        .catch(error => {
            document.getElementById('addVideoProgress').style.display = 'none';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            showNotification('Network error uploading video', 'error');
        });
    };
    
    // Use TUS resumable upload for all files (optimized for 10GB+ files)
    const modalVideoFile = formData.get('video');
    const useTUS = modalVideoFile && modalVideoFile.size > 0; // Always use TUS for all video files
    
    if (useTUS) {
        console.log(`🚀 Using TUS resumable upload for ${(modalVideoFile.size / (1024*1024*1024)).toFixed(1)}GB file (optimized for 500GB+ enterprise files)`);
        formData.append('use_tus', 'true');
        
        // Add retry capability for TUS uploads - optimized for 500GB+ enterprise files
        xhr.timeout = 0; // No timeout for TUS uploads (can handle 500GB+ files)
        
        // Enhanced error handling for TUS uploads
        xhr.addEventListener('timeout', function() {
            console.log('⏰ TUS upload timeout, this is expected for resumable uploads');
        });
    } else {
        console.log(`📤 Using standard upload for file (${modalVideoFile ? (modalVideoFile.size / (1024*1024)).toFixed(1) : 'unknown'}MB)`);
        formData.append('use_tus', 'false');
        xhr.timeout = 300000; // 5 minute timeout for standard uploads
    }
    
    // Use the main upload route with progress tracking
    console.log('🔄 Using upload route with progress tracking...');
    xhr.open('POST', '/admin/upload-video-with-progress');
    xhr.send(formData);
}

// NEW SIMPLE MODAL PROGRESS TRACKER
function startModalRealTimeProgress(uploadId, fileName, submitBtn, originalText, form) {
    console.log('🚀 Starting MODAL real-time progress for:', fileName);
    
    // Show and setup progress container
    const progressContainer = document.getElementById('addVideoProgress');
    if (!progressContainer) {
        console.error('❌ Modal progress container not found');
        return;
    }
    
    progressContainer.style.display = 'block';
    progressContainer.innerHTML = `
        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: #495057;">
                📤 Uploading: ${fileName}
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #e9ecef; border-radius: 6px; height: 20px; margin-bottom: 10px; overflow: hidden;">
                <div id="modalProgressBar_${uploadId}" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                    0%
                </div>
            </div>
            
            <!-- Upload Stats -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px;">
                <div><strong>Progress:</strong> <span id="modalPercent_${uploadId}">0%</span></div>
                <div><strong>Uploaded:</strong> <span id="modalUploaded_${uploadId}">0 MB</span></div>
                <div><strong>Speed:</strong> <span id="modalSpeed_${uploadId}">0 MB/s</span></div>
            </div>
            
            <!-- Status -->
            <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                <strong>Status:</strong> <span id="modalStatus_${uploadId}">Starting upload...</span>
            </div>
        </div>
    `;
    
    // Connect to real-time updates
    const eventSource = new EventSource(`/admin/upload-progress/${uploadId}`);
    let isCompleted = false;
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('📊 Modal real upload data:', data);
            
            // Update elements
            const progressBar = document.getElementById(`modalProgressBar_${uploadId}`);
            const percentElement = document.getElementById(`modalPercent_${uploadId}`);
            const uploadedElement = document.getElementById(`modalUploaded_${uploadId}`);
            const speedElement = document.getElementById(`modalSpeed_${uploadId}`);
            const statusElement = document.getElementById(`modalStatus_${uploadId}`);
            
            if (data.percent !== undefined) {
                const percent = Math.max(0, Math.min(100, data.percent));
                
                if (progressBar) {
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                    progressBar.style.background = percent >= 100 
                        ? 'linear-gradient(90deg, #28a745, #20c997)' 
                        : 'linear-gradient(90deg, #007bff, #0056b3)';
                }
                
                if (percentElement) percentElement.textContent = percent + '%';
                if (uploadedElement) uploadedElement.textContent = data.uploaded || '0 MB';
                if (speedElement) speedElement.textContent = data.speed || '0 MB/s';
                if (statusElement) statusElement.textContent = data.message || data.status || 'Uploading...';
                
                // Handle completion
                if (data.status === 'completed' && percent >= 100) {
                    isCompleted = true;
                    eventSource.close();
                    
                    if (statusElement) statusElement.textContent = '✅ Upload completed successfully!';
                    
                    // Reset modal and reload
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        form.reset();
                        
                        showNotification(`${fileName} uploaded successfully!`, 'success');
                        loadCourseVideos(document.getElementById('courseSelectModal')?.value);
                    }, 3000);
                    
                } else if (data.status === 'failed') {
                    isCompleted = true;
                    eventSource.close();
                    
                    if (statusElement) statusElement.textContent = '❌ Upload failed: ' + (data.error || 'Unknown error');
                    if (progressBar) progressBar.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
                    
                    // Reset modal
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }, 5000);
                    
                    showNotification(`Upload failed: ${data.error || 'Unknown error'}`, 'error');
                }
            }
        } catch (error) {
            console.error('📡 Modal: Error parsing progress data:', error);
        }
    };
    
    eventSource.onerror = function(error) {
        console.error('📡 Modal: Progress connection error:', error);
        if (!isCompleted) {
            const statusElement = document.getElementById(`modalStatus_${uploadId}`);
            if (statusElement) statusElement.textContent = '⚠️ Connection lost - upload may still be processing';
        }
        eventSource.close();
    };
}

// Edit video function with enhanced data loading
function editVideo(videoId) {
    console.log('🔄 Loading video data for editing, ID:', videoId);
    
    fetch(`/admin/videos/${videoId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('✅ Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📊 Video data received:', data);
        if (data.success && data.video) {
            const video = data.video;
            
            // Fill basic video information
            document.getElementById('editVideoId').value = video.id || '';
            document.getElementById('editVideoTitle').value = video.title || '';
            document.getElementById('editVideoDescription').value = video.description || '';
            document.getElementById('editVideoOrder').value = video.order_index || 0;
            document.getElementById('editIsPreview').checked = video.is_preview || false;
            document.getElementById('editVideoInstructions').value = video.instructions || '';
            
            // Handle external links - parse JSON if it's a string
            let externalLinksValue = '';
            if (video.external_links) {
                if (typeof video.external_links === 'string') {
                    try {
                        // Try to parse as JSON and format nicely
                        const parsedLinks = JSON.parse(video.external_links);
                        externalLinksValue = JSON.stringify(parsedLinks, null, 2);
                    } catch (e) {
                        // If parsing fails, use as-is
                        externalLinksValue = video.external_links;
                    }
                } else if (typeof video.external_links === 'object') {
                    // If it's already an object, stringify it nicely
                    externalLinksValue = JSON.stringify(video.external_links, null, 2);
                }
            }
            document.getElementById('editVideoLinks').value = externalLinksValue;
            
            // Add video metadata display
            const modalBody = document.querySelector('#editVideoModal .modal-body');
            
            // Remove any existing metadata section
            const existingMetadata = modalBody.querySelector('.video-metadata-section');
            if (existingMetadata) {
                existingMetadata.remove();
            }
            
            // Create metadata section
            const metadataSection = document.createElement('div');
            metadataSection.className = 'video-metadata-section';
            metadataSection.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-color);';
            
            let metadataHTML = '<h6 style="color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-info-circle me-2"></i>Video Information</h6>';
            
            // Video file information
            if (video.video_url) {
                metadataHTML += `<p class="mb-2"><strong>Video URL:</strong> <small class="text-muted">${video.video_url}</small></p>`;
            }
            
            if (video.duration) {
                metadataHTML += `<p class="mb-2"><strong>Duration:</strong> ${formatDuration(video.duration)}</p>`;
            }
            
            if (video.created_at) {
                const createdDate = new Date(video.created_at).toLocaleString();
                metadataHTML += `<p class="mb-2"><strong>Created:</strong> ${createdDate}</p>`;
            }
            
            if (video.updated_at) {
                const updatedDate = new Date(video.updated_at).toLocaleString();
                metadataHTML += `<p class="mb-2"><strong>Last Updated:</strong> ${updatedDate}</p>`;
            }
            
            // Attachments information
            if (video.attachments && video.attachments.length > 0) {
                metadataHTML += `<p class="mb-2"><strong>Attachments:</strong></p>`;
                metadataHTML += '<ul class="mb-0">';
                video.attachments.forEach(attachment => {
                    metadataHTML += `<li><small>${attachment.original_filename || attachment.filename}</small></li>`;
                });
                metadataHTML += '</ul>';
            }
            
            metadataSection.innerHTML = metadataHTML;
            
            // Insert metadata section at the beginning of modal body
            modalBody.insertBefore(metadataSection, modalBody.firstChild);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editVideoModal'));
            modal.show();
            
            console.log('✅ Video edit modal opened successfully');
            showNotification('Video data loaded successfully', 'success');
        } else {
            console.error('❌ API returned error:', data.message);
            showNotification('Error: ' + (data.message || 'Video not found'), 'error');
        }
    })
    .catch(error => {
        console.error('❌ Error loading video:', error);
        showNotification('Error loading video details: ' + error.message, 'error');
    });
}

// Handle video edit
function handleVideoEdit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const videoId = formData.get('video_id');
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    submitBtn.disabled = true;
    
    fetch(`/admin/videos/${videoId}/update`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Video updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editVideoModal')).hide();
            loadCourseVideos(); // Reload video list
        } else {
            showNotification('Failed to update video: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Update error:', error);
        showNotification('Error updating video', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Delete video
function deleteVideo(videoId) {
    console.log('🗑️ Delete video clicked for ID:', videoId);
    
    if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
        console.log('🗑️ Delete cancelled by user');
        return;
    }
    
    console.log('🗑️ Proceeding with delete request...');
    showNotification('Deleting video...', 'info');
    
    fetch(`/admin/videos/${videoId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('🗑️ Delete response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('🗑️ Delete response data:', data);
        if (data.success) {
            showNotification('Video deleted successfully!', 'success');
            console.log('🗑️ Reloading course videos...');
            // Reload the video list
            if (selectedCourseId) {
                loadExistingVideos(selectedCourseId);
            } else {
                loadCourseVideos();
            }
        } else {
            showNotification('Failed to delete video: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('🗑️ Delete error:', error);
        showNotification('Error deleting video: ' + error.message, 'error');
    });
}

// Preview video
function previewVideo(videoUrl, title, videoId = null) {
    console.log('Preview video called with URL:', videoUrl, 'Title:', title);
    
    if (!videoUrl || videoUrl === '') {
        showNotification('Video URL is not available', 'error');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('videoPreviewModal'));
    const player = document.getElementById('previewVideoPlayer');
    const modalTitle = document.getElementById('previewVideoTitle');
    const debugInfo = document.getElementById('videoDebugInfo');
    
    if (!player) {
        showNotification('Video player not found', 'error');
        return;
    }
    
    modalTitle.textContent = title || 'Video Preview';
    debugInfo.textContent = 'Loading video...';
    
    // Clear existing content and event listeners
    player.pause();
    player.src = '';
    player.load();
    
    // Remove crossOrigin for Bunny.net CDN as it might cause issues
    player.removeAttribute('crossorigin');
    
    // Check if this is a Bunny.net URL and handle accordingly
    const isBunnyUrl = videoUrl.includes('b-cdn.net') || videoUrl.includes('bunnycdn.com');
    
    if (isBunnyUrl) {
        console.log('Detected Bunny.net URL, applying specific handling');
        
        // For Bunny.net, try different approaches
        // Method 1: Direct URL with proper headers
        const testBunnyAccess = async () => {
            try {
                debugInfo.textContent = 'Testing Bunny.net URL accessibility...';
                
                // Test with a simple fetch to check if URL is accessible
                const response = await fetch(videoUrl, { 
                    method: 'HEAD',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('Bunny.net URL is accessible');
                    debugInfo.textContent = 'Bunny.net URL accessible, loading video...';
                    
                    // Set the source directly
                    player.src = videoUrl;
                    player.load();
                } else {
                    console.error('Bunny.net URL returned status:', response.status);
                    debugInfo.textContent = `Bunny.net URL error: ${response.status}`;
                    
                    // Try alternative method with source element
                    player.innerHTML = '';
                    
                    const source = document.createElement('source');
                    source.src = videoUrl;
                    source.type = 'video/mp4';
                    
                    const fallback = document.createElement('p');
                    fallback.textContent = 'Your browser doesn\'t support HTML5 video.';
                    
                    player.appendChild(source);
                    player.appendChild(fallback);
                    
                    player.load();
                    debugInfo.textContent = 'Using source element method...';
                }
            } catch (error) {
                console.error('Bunny.net URL test failed:', error);
                debugInfo.textContent = 'Direct access failed, trying alternative method...';
                
                // Try alternative method with source element
                player.innerHTML = '';
                
                const source = document.createElement('source');
                source.src = videoUrl;
                source.type = 'video/mp4';
                
                const fallback = document.createElement('p');
                fallback.textContent = 'Your browser doesn\'t support HTML5 video.';
                
                player.appendChild(source);
                player.appendChild(fallback);
                
                player.load();
                debugInfo.textContent = 'Using source element method...';
            }
        };
        
        
        // Start with testing Bunny.net access
        testBunnyAccess();
        
    } else {
        // For non-Bunny URLs, use standard method
        console.log('Non-Bunny URL, using standard method');
        player.src = videoUrl;
        player.load();
    }
    
    // Enhanced event handlers
    const handleLoadStart = () => {
        console.log('Video load started');
        debugInfo.textContent = 'Video loading started...';
    };
    
    const handleLoadedMetadata = () => {
        console.log('Video metadata loaded');
        debugInfo.textContent = 'Video metadata loaded successfully!';
    };
    
    const handleCanPlay = () => {
        console.log('Video can play');
        debugInfo.textContent = 'Video ready to play!';
        showNotification('Video loaded successfully', 'success');
    };
    
    let errorAttempts = 0;
    const maxAttempts = 3;
    
    const handleError = (e) => {
        errorAttempts++;
        console.error(`Video loading error (attempt ${errorAttempts}):`, e);
        console.error('Error details:', {
            error: player.error,
            errorCode: player.error ? player.error.code : 'unknown',
            networkState: player.networkState,
            readyState: player.readyState,
            src: player.src
        });
        
        const errorMessage = player.error ? 
            `Error ${player.error.code}: ${getVideoErrorMessage(player.error.code)}` : 
            'Unknown video error';
        
        // If it's a Bunny.net URL and we haven't tried all methods yet
        if (isBunnyUrl && errorAttempts < maxAttempts && videoId) {
            console.log(`Bunny.net error on attempt ${errorAttempts}, trying fallback method...`);
            
            if (errorAttempts === 1) {
                // First error - try alternative loading with source element
                debugInfo.textContent = 'Direct loading failed, trying alternative method...';
                
                // Method 2: Use source element with explicit MIME type
                player.innerHTML = '';
                
                const source = document.createElement('source');
                source.src = videoUrl;
                source.type = 'video/mp4';
                
                const fallback = document.createElement('p');
                fallback.textContent = 'Your browser doesn\'t support HTML5 video.';
                
                player.appendChild(source);
                player.appendChild(fallback);
                
                player.load();
                debugInfo.textContent = 'Using source element method...';
            } else if (errorAttempts === 2 && videoId) {
                // Second error - try proxy method if available
                debugInfo.textContent = 'Alternative method failed, trying proxy method...';
                const proxyUrl = `/admin/video-proxy/${videoId}`;
                console.log('Trying proxy method with URL:', proxyUrl);
                
                player.src = proxyUrl;
                player.load();
            }
        } else {
            // Final error or not a Bunny.net URL
            debugInfo.textContent = `Video error: ${errorMessage}`;
            showNotification(`Error loading video: ${errorMessage}`, 'error');
            
            if (isBunnyUrl) {
                console.log('All Bunny.net methods failed. Check: 1) Pull Zone is active, 2) CORS settings, 3) File exists');
                debugInfo.textContent += ' | All methods failed - check Bunny.net configuration';
            }
        }
    };
    
    // Add event listeners
    player.addEventListener('loadstart', handleLoadStart);
    player.addEventListener('loadedmetadata', handleLoadedMetadata);
    player.addEventListener('canplay', handleCanPlay);
    player.addEventListener('error', handleError);
    
    // Show modal
    modal.show();
    
    // Clean up when modal closes
    const modalElement = document.getElementById('videoPreviewModal');
    modalElement.addEventListener('hidden.bs.modal', function () {
        player.pause();
        player.currentTime = 0;
        player.removeEventListener('loadstart', handleLoadStart);
        player.removeEventListener('loadedmetadata', handleLoadedMetadata);
        player.removeEventListener('canplay', handleCanPlay);
        player.removeEventListener('error', handleError);
    });
}

// Helper function to get human-readable error messages
function getVideoErrorMessage(errorCode) {
    const errorMessages = {
        1: 'Video loading aborted',
        2: 'Network error while loading video',
        3: 'Video decoding error',
        4: 'Video format not supported'
    };
    return errorMessages[errorCode] || 'Unknown error';
}


// Show upload progress
function showUploadProgress() {
    document.getElementById('uploadProgress').style.display = 'block';
    // You can update the progress bar here if needed
}

// Hide upload progress
function hideUploadProgress() {
    document.getElementById('uploadProgress').style.display = 'none';
}

// Format duration helper
function formatDuration(seconds) {
    if (!seconds) return 'Unknown';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Helper function to get file icon
function getFileIcon(fileType) {
    const icons = {
        'pdf': 'pdf',
        'doc': 'word',
        'docx': 'word',
        'txt': 'text',
        'jpg': 'image',
        'jpeg': 'image',
        'png': 'image',
        'gif': 'image',
        'zip': 'archive',
        'rar': 'archive',
        'mp3': 'audio',
        'wav': 'audio',
        'mp4': 'video',
        'avi': 'video'
    };
    return icons[fileType?.toLowerCase()] || 'file';
}

// Show detailed video information
function showVideoDetails(videoId) {
    console.log('📋 Showing details for video ID:', videoId);
    
    fetch(`/admin/courses/${selectedCourseId}/videos`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const video = data.videos.find(v => v.id == videoId);
                if (video) {
                    const details = `
📹 Video Details:
• ID: ${video.id}
• Title: ${video.title}
• Description: ${video.description || 'None'}
• Duration: ${formatDuration(video.duration)}
• Order: ${video.order_index}
• Preview: ${video.is_preview ? 'Yes' : 'No'}
• Video URL: ${video.video_url}
• Instructions: ${video.instructions || 'None'}
• External Links: ${video.external_links || 'None'}
• Attachments: ${video.attachments ? video.attachments.length : 0} files

📎 Attachments:
${video.attachments && video.attachments.length > 0 ? 
    video.attachments.map(att => 
        `• ${att.original_filename} (${formatFileSize(att.file_size)}) - URL: ${att.file_url || 'Missing'}`
    ).join('\n') : 
    '• No attachments'
}`;
                    alert(details);
                } else {
                    alert('Video details not found.');
                }
            } else {
                alert('Failed to load video details.');
            }
        })
        .catch(error => {
            console.error('Error loading video details:', error);
            alert('Error loading video details.');
        });
}




// Notification helper (reuse existing function if available)
function showNotification(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Simple incremental progress system is now built into the template
console.log('✅ Simple incremental progress system ready - no external scripts needed');

// Add a manual test function for debugging progress bar
window.testProgressBar = function() {
    console.log('🧪 Testing progress bar manually...');
    
    // Test the main progress bar
    trackBunnyUploadProgress(
        'test-upload-123',
        'test-video.mp4',
        'progressBar',
        'progressText',
        'uploadProgress',
        false
    );
    
    console.log('✅ Progress bar test started! Watch the progress container.');
};

console.log('🔧 Manual test function added: window.testProgressBar()');
console.log('📋 To test: Open browser console and type: testProgressBar()');
</script>