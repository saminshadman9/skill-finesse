<!-- Create Course Section -->
<div id="create-course-section" class="content-section" style="display: none;">
    <div class="page-header">
        <h1>Create Course</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Create Course</li>
            </ol>
        </nav>
    </div>

    <div class="row">
        <!-- Create Course Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Course</h3>
                </div>
                <div class="card-body">
                    <form id="createCourseForm" method="POST" action="/admin/courses/create" enctype="multipart/form-data">
                        <div class="row">
                            <!-- Course Title -->
                            <div class="col-md-12 mb-3">
                                <label for="courseTitle" class="form-label fw-bold">Course Title *</label>
                                <input type="text" class="form-control form-control-lg" id="courseTitle" name="title" required>
                                <div class="form-text">Enter a compelling course title that describes what students will learn.</div>
                            </div>
                            
                            <!-- Course Category -->
                            <div class="col-md-6 mb-3">
                                <label for="courseCategory" class="form-label fw-bold">Course Category *</label>
                                <select class="form-select" id="courseCategory" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Web Development">Web Development</option>
                                    <option value="Data Science">Data Science</option>
                                    <option value="Mobile Development">Mobile Development</option>
                                    <option value="Business">Business</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Design">Design</option>
                                    <option value="Photography">Photography</option>
                                    <option value="Music">Music</option>
                                    <option value="Language">Language</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <!-- Course Price -->
                            <div class="col-md-6 mb-3">
                                <label for="coursePrice" class="form-label fw-bold">Course Price (à§³) *</label>
                                <input type="number" class="form-control" id="coursePrice" name="price" min="0" step="0.01" required>
                                <div class="form-text">Enter the course price in Bangladeshi Taka (BDT).</div>
                            </div>
                            
                            <!-- Course Description -->
                            <div class="col-md-12 mb-3">
                                <label for="courseDescription" class="form-label fw-bold">Course Description *</label>
                                <textarea class="form-control" id="courseDescription" name="description" rows="4" required></textarea>
                                <div class="form-text">Provide a detailed description of what the course covers.</div>
                            </div>
                            
                            <!-- Course Image -->
                            <div class="col-md-12 mb-3">
                                <label for="courseImage" class="form-label fw-bold">Course Image</label>
                                <input type="file" class="form-control" id="courseImage" name="image" accept="image/*">
                                <div class="form-text">Upload a course thumbnail image (recommended: 1200x800 pixels).</div>
                            </div>
                            
                            <!-- Instructor Information -->
                            <div class="col-md-6 mb-3">
                                <label for="instructorName" class="form-label fw-bold">Instructor Name</label>
                                <input type="text" class="form-control" id="instructorName" name="instructor_name">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="instructorImage" class="form-label fw-bold">Instructor Image</label>
                                <input type="file" class="form-control" id="instructorImage" name="instructor_image" accept="image/*">
                            </div>
                            
                            <!-- What You'll Learn -->
                            <div class="col-md-12 mb-3">
                                <label for="whatYoullLearn" class="form-label fw-bold">What You'll Learn</label>
                                <textarea class="form-control" id="whatYoullLearn" name="what_youll_learn" rows="4" placeholder="List the key learning outcomes, one per line"></textarea>
                            </div>
                            
                            <!-- Course Requirements -->
                            <div class="col-md-12 mb-3">
                                <label for="courseRequirements" class="form-label fw-bold">Course Requirements</label>
                                <textarea class="form-control" id="courseRequirements" name="course_requirements" rows="3" placeholder="List any prerequisites or requirements"></textarea>
                            </div>
                            
                            <!-- About Course -->
                            <div class="col-md-12 mb-3">
                                <label for="aboutCourse" class="form-label fw-bold">About This Course</label>
                                <textarea class="form-control" id="aboutCourse" name="about_course" rows="4"></textarea>
                            </div>
                            
                            <!-- Instructor Bio -->
                            <div class="col-md-12 mb-3">
                                <label for="instructorBio" class="form-label fw-bold">Instructor Bio</label>
                                <textarea class="form-control" id="instructorBio" name="instructor_bio" rows="4"></textarea>
                            </div>
                            
                            <!-- Submit Button -->
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>Create Course
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar -->
        <div class="col-lg-4">
            <!-- My Courses List -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>My Courses <span id="courseCount">(0)</span></h5>
                    <button class="btn btn-sm btn-light" onclick="loadCourses()" title="Refresh Courses">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="coursesList" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; min-height: 200px;">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading courses...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Course Management Functions
let coursesLoaded = false;

function getCourseImageUrl(course) {
    if (!course.image) return '/static/images/placeholder.svg';
    return `/static/uploads/${course.image}`;
}

function viewCourse(courseId) {
    window.open(`/course/${courseId}`, '_blank');
}

function editCourse(courseId) {
    alert('Edit functionality will be implemented soon');
}

function togglePublishCourse(courseId, isPublished) {
    if (confirm(`Are you sure you want to ${isPublished ? 'unpublish' : 'publish'} this course?`)) {
        fetch(`/admin/courses/${courseId}/toggle-publish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCourses(); // Reload courses
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating course status');
        });
    }
}

function deleteCourse(courseId) {
    if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        fetch(`/admin/courses/${courseId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCourses(); // Reload courses
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting course');
        });
    }
}

function loadCourses() {
    const coursesList = document.getElementById('coursesList');
    const courseCount = document.getElementById('courseCount');
    
    if (!coursesList) {
        console.error('coursesList element not found');
        return;
    }
    
    // Show loading state
    coursesList.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading courses...</p>
        </div>
    `;
    
    // Make API call
    fetch('/admin/courses/list', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            coursesLoaded = true;
            
            // Update course count
            if (courseCount) {
                courseCount.textContent = `(${data.courses.length})`;
            }
            
            if (data.courses && data.courses.length > 0) {
                // Display courses
                const coursesHTML = data.courses.map(course => `
                    <div class="card course-card ${course.is_published ? 'published' : 'draft'} mb-2" data-course-id="${course.id}">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-start">
                                <img src="${getCourseImageUrl(course)}" 
                                     alt="${course.title}" 
                                     class="course-thumbnail me-3" 
                                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px;"
                                     onerror="this.src='/static/images/placeholder.svg';">
                                
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1" style="font-size: 0.9rem;">${course.title}</h6>
                                    
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <span class="price-badge" style="background: linear-gradient(45deg, #198754, #20c997); color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem;">
                                            à§³${parseFloat(course.price).toLocaleString('en-BD')}
                                        </span>
                                        <span class="status-badge status-${course.is_published ? 'published' : 'draft'}" 
                                              style="font-size: 0.65rem; padding: 2px 6px; border-radius: 8px; 
                                                     background-color: ${course.is_published ? 'rgba(25, 135, 84, 0.1)' : 'rgba(255, 193, 7, 0.1)'}; 
                                                     color: ${course.is_published ? '#198754' : '#ffc107'};">
                                            ${course.is_published ? 'Published' : 'Draft'}
                                        </span>
                                    </div>
                                    
                                    <p class="text-muted small mb-1" style="font-size: 0.75rem;">${course.category || 'Uncategorized'}</p>
                                    
                                    ${course.instructor_name ? `
                                        <div class="instructor-info d-flex align-items-center gap-1 mb-2" style="font-size: 0.7rem; color: #6c757d;">
                                            ${course.instructor_image ? 
                                                `<img src="/static/uploads/${course.instructor_image}" alt="${course.instructor_name}" style="width: 16px; height: 16px; border-radius: 50%; object-fit: cover;">` : 
                                                '<i class="fas fa-user-circle"></i>'
                                            }
                                            <span>By ${course.instructor_name}</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="course-actions">
                                        <button class="btn btn-sm btn-outline-info" onclick="viewCourse(${course.id})" title="View Course" style="padding: 3px 6px; font-size: 0.7rem;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editCourse(${course.id})" title="Edit Course" style="padding: 3px 6px; font-size: 0.7rem;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-${course.is_published ? 'warning' : 'success'}" 
                                                onclick="togglePublishCourse(${course.id}, ${course.is_published})" 
                                                title="${course.is_published ? 'Unpublish' : 'Publish'} Course" 
                                                style="padding: 3px 6px; font-size: 0.7rem;">
                                            <i class="fas fa-${course.is_published ? 'eye-slash' : 'eye'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCourse(${course.id})" title="Delete Course" style="padding: 3px 6px; font-size: 0.7rem;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                coursesList.innerHTML = coursesHTML;
            } else {
                // No courses found
                coursesList.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No Courses Found</h6>
                        <p class="text-muted small">Create your first course using the form above.</p>
                    </div>
                `;
            }
        } else {
            throw new Error(data.message || 'Failed to load courses');
        }
    })
    .catch(error => {
        console.error('Error loading courses:', error);
        coursesList.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                <h6 class="text-danger">Error Loading Courses</h6>
                <p class="text-muted small">${error.message}</p>
                <button class="btn btn-sm btn-primary" onclick="loadCourses()">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            </div>
        `;
    });
}

// Form submission handler
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createCourseForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Course...';
            
            fetch('/admin/courses/create', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset form
                    this.reset();
                    
                    // Show success message
                    alert('Course created successfully!');
                    
                    // Reload courses list
                    loadCourses();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating course');
            })
            .finally(() => {
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // Load courses when section becomes visible
    function checkSectionVisibility() {
        const section = document.getElementById('create-course-section');
        if (section && section.style.display !== 'none' && !coursesLoaded) {
            loadCourses();
        }
    }
    
    // Initial check
    checkSectionVisibility();
    
    // Check when section visibility changes
    const observer = new MutationObserver(checkSectionVisibility);
    observer.observe(document.body, { 
        subtree: true, 
        attributes: true, 
        attributeFilter: ['style'] 
    });
});
</script>